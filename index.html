<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>å±±æ­©ä¼š è»Šå‰²ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
:root {
    /* --- ãƒ™ãƒ¼ã‚¹ã‚«ãƒ©ãƒ¼ (Light Mode: ã‚«ãƒ•ã‚§ãƒ©ãƒ†ãƒ»é…è‰²) --- */
    --bg-body: #f2efe9;       /* èƒŒæ™¯ï¼šæ·¡ã„ãƒ™ãƒ¼ã‚¸ãƒ¥ */
    --text-main: #4e342e;     /* æ–‡å­—ï¼šãƒ€ãƒ¼ã‚¯ã‚³ãƒ¼ãƒ’ãƒ¼ãƒ–ãƒ©ã‚¦ãƒ³ */
    --bg-card: #fdfbf7;       /* ã‚«ãƒ¼ãƒ‰èƒŒæ™¯ï¼šã‚ªãƒ•ãƒ›ãƒ¯ã‚¤ãƒˆï¼ˆç´”ç™½ã§ã¯ãªã„ã‚¯ãƒªãƒ¼ãƒ è‰²ï¼‰ */
    --border-color: #d7ccc8;  /* æ ç·šï¼šãƒŸãƒ«ã‚¯ã‚³ã‚³ã‚¢è‰² */
    
    /* --- ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ --- */
    --accent-color: #558b2f;  /* ç·‘ã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼ˆæŠ¹èŒ¶è‰²ï¼‰ */
    --accent-hover: #33691e;
    --primary-btn: #6d4c41;   /* ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³ï¼šã‚³ãƒ¼ãƒ’ãƒ¼è‰² */
    --primary-btn-hover: #5d4037;
    
    /* --- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç”¨ --- */
    --card-shadow: 0 4px 10px rgba(78, 52, 46, 0.08); /* å½±ï¼šèŒ¶è‰²ãƒ™ãƒ¼ã‚¹ã§æŸ”ã‚‰ã‹ã */
    --driver-bg: #eefebe;     /* é‹è»¢å¸­ï¼šæ·¡ã„æŠ¹èŒ¶ã‚¯ãƒªãƒ¼ãƒ  */
    --driver-text: #33691e;
    --seat-bg: #ece8e1;       /* åº§å¸­ã‚¨ãƒªã‚¢ï¼šå°‘ã—æ¿ƒã„ãƒ™ãƒ¼ã‚¸ãƒ¥ */
    --drag-over-bg: #d7ccc8;
    --share-bar-bg: #fdfbf7;  /* ã‚·ã‚§ã‚¢ãƒãƒ¼ï¼šã‚«ãƒ¼ãƒ‰èƒŒæ™¯ã¨åŒã˜ï¼ˆä¸é€æ˜ï¼‰ */
    
    /* --- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  --- */
    --input-bg: #faf8f5;
    --input-text: #4e342e;
    --input-border: #bcaaa4;

    /* --- ãã®ä»– --- */
    --ghost-bg: #a1887f;
    --modal-bg: #fdfbf7;
    --modal-border: #d7ccc8;
    
    /* --- æ€§åˆ¥ã‚«ãƒ©ãƒ¼ï¼ˆã‚«ãƒ•ã‚§ã®é›°å›²æ°—ã«åˆã‚ã›ãŸãƒ€ã‚¹ãƒ†ã‚£ãƒ¼ã‚«ãƒ©ãƒ¼ï¼‰ --- */
    --bg-male: #e1f5fe;       /* æ·¡ã„ãƒ–ãƒ«ãƒ¼ã‚°ãƒ¬ãƒ¼ */
    --border-male: #b3e5fc;
    --text-male: #01579b;
    
    --bg-female: #fce4ec;     /* æ·¡ã„ã•ãã‚‰è‰² */
    --border-female: #f8bbd0;
    --text-female: #880e4f;
    
    --driver-bg-male: #b3e5fc;
    --driver-text-male: #01579b;
    --driver-bg-female: #f8bbd0;
    --driver-text-female: #880e4f;

    --freshman-color: #558b2f; /* 1å¹´ç”Ÿãƒãƒ¼ã‚¯ï¼šæŠ¹èŒ¶è‰² */
    --locked-color: #f9a825;   /* ãƒ­ãƒƒã‚¯ï¼šãƒã‚¹ã‚¿ãƒ¼ãƒ‰ã‚¤ã‚¨ãƒ­ãƒ¼ */
    
    /* --- ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ --- */
    --radius-main: 12px;       /* è§’ä¸¸ã‚’å°‘ã—å¼·ã‚ã¦æŸ”ã‚‰ã‹ã */
    --radius-sm: 8px;

    color-scheme: light;
}

[data-theme="dark"] {
    /* --- ãƒ™ãƒ¼ã‚¹ã‚«ãƒ©ãƒ¼ (Dark Mode: ã‚¨ã‚¹ãƒ—ãƒ¬ãƒƒã‚½ãƒ»é…è‰²) --- */
    --bg-body: #251d1a;       /* èƒŒæ™¯ï¼šéå¸¸ã«æ¿ƒã„ç„¦ã’èŒ¶ */
    --text-main: #d7ccc8;     /* æ–‡å­—ï¼šãƒŸãƒ«ã‚¯ãƒ†ã‚£ãƒ¼è‰² */
    --bg-card: #3e2723;       /* ã‚«ãƒ¼ãƒ‰èƒŒæ™¯ï¼šãƒ€ãƒ¼ã‚¯ãƒ­ãƒ¼ã‚¹ãƒˆ */
    --border-color: #5d4037;  /* æ ç·šï¼šæ¿ƒã„èŒ¶è‰² */
    
    --card-shadow: 0 4px 10px rgba(0,0,0,0.5);
    
    --driver-bg: #33691e;     /* é‹è»¢å¸­ï¼šæ¿ƒã„æŠ¹èŒ¶ */
    --driver-text: #f1f8e9;
    --seat-bg: #322520;       /* åº§å¸­ã‚¨ãƒªã‚¢ï¼šèƒŒæ™¯ã‚ˆã‚Šå°‘ã—æ˜ã‚‹ã„èŒ¶è‰² */
    --drag-over-bg: #4e342e;
    --share-bar-bg: #3e2723;  /* ä¸é€æ˜ */
    
    --input-bg: #4e342e;
    --input-text: #efebe9;
    --input-border: #6d4c41;

    --ghost-bg: #5d4037;
    --modal-bg: #3e2723;
    --modal-border: #5d4037;

    /* Dark Mode æ€§åˆ¥ã‚«ãƒ©ãƒ¼ï¼ˆå½©åº¦ã‚’è½ã¨ã—ã¦é¦´æŸ“ã¾ã›ã‚‹ï¼‰ */
    --bg-male: rgba(3, 169, 244, 0.15);
    --border-male: #0288d1;
    --text-male: #b3e5fc;
    
    --bg-female: rgba(233, 30, 99, 0.15);
    --border-female: #c2185b;
    --text-female: #f8bbd0;
    
    --driver-bg-male: rgba(3, 169, 244, 0.3);
    --driver-text-male: #e1f5fe;
    --driver-bg-female: rgba(233, 30, 99, 0.3);
    --driver-text-female: #fce4ec;

    --freshman-color: #aed581; /* 1å¹´ç”Ÿï¼šãƒ©ã‚¤ãƒˆã‚°ãƒªãƒ¼ãƒ³ */
    
    color-scheme: dark;
}

/* Bootstrapã®ä¸Šæ›¸ãã¨åŸºæœ¬è¨­å®š */
body { 
    background-color: var(--bg-body); 
    color: var(--text-main); 
    font-family: 'Helvetica Neue', Arial, sans-serif; 
    padding-bottom: 120px; 
    transition: background-color 0.3s, color 0.3s; 
    font-size: 0.95rem; 
    letter-spacing: 0.03em; /* æ–‡å­—é–“ã‚’å°‘ã—é–‹ã‘ã¦èª­ã¿ã‚„ã™ã */
}

/* ãƒœã‚¿ãƒ³é¡ã®é…è‰²ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ */
.btn-primary { background-color: var(--primary-btn); border-color: var(--primary-btn); color: #fff; }
.btn-primary:hover { background-color: var(--primary-btn-hover); border-color: var(--primary-btn-hover); }
.btn-success { background-color: var(--accent-color); border-color: var(--accent-color); color: #fff; }
.btn-success:hover { background-color: var(--accent-hover); border-color: var(--accent-hover); }
.btn-warning { background-color: #ffd54f; border-color: #ffca28; color: #3e2723; } /* ãƒãƒƒãƒç™»éŒ²ãƒœã‚¿ãƒ³ */
.btn-outline-secondary { color: var(--text-main); border-color: var(--border-color); }
.btn-outline-secondary:hover { background-color: var(--seat-bg); color: var(--text-main); border-color: var(--text-main); }
.btn-outline-danger { color: #d32f2f; border-color: #ef9a9a; }
.btn-outline-danger:hover { background-color: #ffebee; color: #b71c1c; }
[data-theme="dark"] .btn-outline-danger:hover { background-color: #b71c1c; color: #fff; }

.form-control, .form-select, .input-group-text { 
    background-color: var(--input-bg); 
    color: var(--input-text); 
    border-color: var(--input-border); 
    border-radius: var(--radius-sm);
}
.form-control:focus { 
    border-color: var(--accent-color); 
    box-shadow: 0 0 0 0.2rem rgba(85, 139, 47, 0.25); 
    background-color: var(--input-bg); 
    color: var(--input-text); 
}
.form-control::placeholder { color: var(--input-text); opacity: 0.5; }

/* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ã®ãƒªãƒ•ã‚¡ã‚¤ãƒ³ */
.member-card { 
    background: var(--bg-card); 
    border: 1px solid var(--border-color); 
    border-radius: var(--radius-sm); 
    padding: 8px 10px 8px 34px; 
    position: relative; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.03); /* å½±ã‚’æ§ãˆã‚ã« */
    color: var(--text-main); 
    margin-bottom: 0; 
    display: flex; 
    flex-direction: column; 
    transition: all 0.2s; 
    touch-action: pan-y;
}
.handle {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: grab;
    background-color: rgba(0,0,0,0.03); 
    border-right: 1px solid var(--border-color);
    border-top-left-radius: var(--radius-sm);
    border-bottom-left-radius: var(--radius-sm);
    color: #a1887f; /* ãƒãƒ³ãƒ‰ãƒ«è‰²ã‚‚èŒ¶ç³»ã« */
    touch-action: none;
}
.handle:active { cursor: grabbing; background-color: rgba(0,0,0,0.08); color: #5d4037; }
[data-theme="dark"] .handle { background-color: rgba(255,255,255,0.05); }

.member-card:active { transform: scale(1.0); }
.member-card[data-gender="male"] { background-color: var(--bg-male); border-color: var(--border-male); color: var(--text-male); }
.member-card[data-gender="female"] { background-color: var(--bg-female); border-color: var(--border-female); color: var(--text-female); }
.member-card[data-locked="true"] { border-color: var(--locked-color); border-width: 2px; box-shadow: 0 0 8px rgba(249, 168, 37, 0.4); }

.lock-btn { color: #bcaaa4; margin-right: 8px; transition: color 0.2s; }
.lock-btn:hover { color: var(--text-main); }
.member-card[data-locked="true"] .lock-btn { color: var(--locked-color); opacity: 1; }

.card-top-row { display: flex; align-items: center; font-size: 1rem; line-height: 1.3; width: 100%; }
.member-name-text { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; margin: 0 6px; cursor: pointer; }

.card-bottom-row { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 6px; font-size: 0.85rem; }
.action-btn { cursor: pointer; padding: 2px 4px; color: #bcaaa4; transition: color 0.2s; }
.action-btn:hover { color: var(--text-main); }
.edit-name-btn { cursor: pointer; font-size: 0.8em; color: inherit; opacity: 0.5; transition: opacity 0.2s; }
.edit-name-btn:hover { opacity: 1; }

.freshman-icon { color: var(--freshman-color); margin-right: 4px; font-size: 1em; }

.memo-indicator { font-size: 0.9rem; color: var(--locked-color); cursor: pointer; margin-right: 6px; transition: transform 0.2s; }
.memo-indicator:hover { transform: scale(1.1); }
.memo-indicator.empty { color: var(--border-color); opacity: 0.6; }
.memo-popup { font-size: 0.8rem; color: #5d4037; background: #fff8e1; padding: 6px 8px; border-radius: 6px; border: 1px solid #ffe0b2; margin-top: 5px; display: none; width: 100%; word-break: break-all; line-height: 1.3; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
[data-theme="dark"] .memo-popup { background: #4e342e; color: #ffecb3; border-color: #6d4c41; }

/* è»Šä¸¡ãƒœãƒƒã‚¯ã‚¹ */
.car-box { 
    background: var(--bg-card); 
    border: 1px solid var(--border-color); 
    border-radius: var(--radius-main); 
    padding: 16px; /* ä½™ç™½ã‚’å°‘ã—åºƒã’ã‚‹ */
    position: relative; 
    box-shadow: var(--card-shadow); 
}
.car-header { font-weight: bold; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 2px solid var(--border-color); font-size: 1.1rem; color: var(--text-main); }
.car-header i.fa-car { color: var(--primary-btn) !important; } /* ã‚¢ã‚¤ã‚³ãƒ³è‰²å¤‰æ›´ */

.car-box.over-capacity { border-color: #e57373; background-color: rgba(229, 115, 115, 0.05); }

.car-interior-layout { display: flex; flex-direction: column; gap: 10px; }
.front-row { display: flex; gap: 10px; }
.seat-area { flex: 1; min-height: 60px; border-radius: var(--radius-sm); padding: 6px; background-color: var(--seat-bg); transition: background-color 0.2s; border: 1px solid transparent; }
.sortable-area { border: 2px dashed var(--border-color); }
.sortable-area.drag-over { background-color: var(--drag-over-bg); border-color: var(--accent-color); }

.rear-seats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; align-content: start; }

.driver-seat { 
    background-color: var(--driver-bg); 
    color: var(--driver-text); 
    border: 1px solid var(--border-color); 
    border-radius: var(--radius-sm); 
    padding: 10px; 
    display: flex; 
    flex-direction: column; 
    font-size: 0.95rem; 
    user-select: none; 
}
.driver-seat[data-gender="male"] { background: var(--driver-bg-male); color: var(--driver-text-male); border-color: var(--border-male); }
.driver-seat[data-gender="female"] { background: var(--driver-bg-female); color: var(--driver-text-female); border-color: var(--border-female); }
.driver-label { font-size: 0.7em; opacity: 0.7; text-align: right; margin-bottom: 4px; line-height: 1; font-weight: bold; letter-spacing: 1px; color: inherit; }
.driver-name-disp { cursor: pointer; }

/* å¾…æ©Ÿã‚¨ãƒªã‚¢ */
.waiting-area { 
    background-color: var(--seat-bg); 
    border-radius: var(--radius-main); 
    padding: 12px; 
    min-height: 120px; 
    display: flex; 
    flex-wrap: wrap; 
    gap: 8px; 
    align-content: flex-start; 
    border: 2px dashed var(--border-color); 
    transition: background-color 0.2s, border-color 0.2s; 
}
.waiting-area.drag-over { background-color: var(--drag-over-bg); border-color: var(--accent-color); }
.waiting-area .member-card { width: calc(33.333% - 6px); }
@media (max-width: 768px) { .waiting-area .member-card { width: calc(50% - 4px); } }

/* ã‚·ã‚§ã‚¢ãƒãƒ¼ (é€æ˜åŒ–å»ƒæ­¢ã€ã‚½ãƒªãƒƒãƒ‰ãªãƒ‡ã‚¶ã‚¤ãƒ³ã¸) */
.share-bar { 
    position: fixed; 
    bottom: 0; 
    left: 0; 
    right: 0; 
    background: var(--share-bar-bg); /* ä¸é€æ˜ */
    border-top: 1px solid var(--border-color); 
    padding: 15px 20px 20px; 
    z-index: 1000; 
    box-shadow: 0 -4px 10px rgba(0,0,0,0.05); 
}

/* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.sortable-ghost { background-color: var(--ghost-bg) !important; opacity: 0.5; border: 2px dashed var(--text-main); }
.sortable-chosen { background-color: var(--drag-over-bg) !important; opacity: 0.9 !important; }
.sortable-fallback { 
    opacity: 1 !important; 
    background: var(--bg-card); 
    box-shadow: 0 15px 30px rgba(0,0,0,0.2); 
    transform: scale(1.02) rotate(1deg); /* å°‘ã—å‚¾ã‘ã¦æŒã¡ä¸Šã’æ„Ÿã‚’å‡ºã™ */
    cursor: grabbing; 
    transition: none !important; 
    z-index: 9999 !important;
    pointer-events: none;
    border: 1px solid var(--accent-color);
}

/* ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ & ãƒ¢ãƒ¼ãƒ€ãƒ« */
.dropdown-menu { background-color: var(--modal-bg); border-color: var(--modal-border); box-shadow: 0 8px 16px rgba(0,0,0,0.15); color: var(--text-main); border-radius: var(--radius-sm); }
.dropdown-item { color: var(--text-main); padding: 8px 16px; }
.dropdown-item:hover { background-color: var(--seat-bg); color: var(--text-main); }
.dropdown-header { color: var(--text-main); opacity: 0.6; font-weight: bold; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; }
.dropdown-menu .form-check-label { color: var(--text-main); cursor: pointer; }

.modal-content { 
    background-color: var(--modal-bg); 
    color: var(--text-main); 
    border-color: var(--modal-border); 
    border-radius: var(--radius-main); 
    box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
    border: none;
}
.modal-header { border-bottom-color: var(--border-color); padding: 15px 20px; }
.modal-footer { border-top-color: var(--border-color); padding: 15px 20px; }
.btn-close { opacity: 0.5; }
[data-theme="dark"] .btn-close { filter: invert(1); opacity: 0.7; }

.btn-group .btn i, .btn-outline-danger i { font-size: 1.1em; }
</style>
</head>
<body data-theme="light">
<div class="container py-4"> <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0 fs-4 fw-bold text-nowrap" style="color: var(--text-main);"><i class="fas fa-mountain me-2" style="color: var(--accent-color);"></i>è»Šå‰²ãƒ¡ãƒ¼ã‚«ãƒ¼</h2>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-warning btn-sm fw-bold shadow-sm" data-action="batch"><i class="fas fa-paste me-1"></i>ä¸€æ‹¬ç™»éŒ²</button>
            <button class="btn btn-outline-danger btn-sm shadow-sm" data-action="reset"><i class="fas fa-redo-alt"></i></button>
        </div>
    </div>
    <div class="row g-3 mb-4"> <div class="col-md-5">
            <div class="input-group shadow-sm">
                <span class="input-group-text border-end-0"><i class="fas fa-user text-muted"></i></span>
                <input type="text" id="newMemberName" class="form-control border-start-0 ps-0" placeholder="åå‰ã‚’å…¥åŠ›">
                <button class="btn btn-primary px-4" data-action="addMember">è¿½åŠ </button>
            </div>
        </div>
        <div class="col-md-7">
            <div class="input-group shadow-sm">
                <span class="input-group-text border-end-0"><i class="fas fa-car text-muted"></i></span>
                <input type="text" id="newCarName" class="form-control border-start-0 ps-0" placeholder="é‹è»¢æ‰‹å">
                <input type="number" id="newCarCapacity" class="form-control text-center" placeholder="å®šå“¡" value="3" style="max-width:80px; border-left: 1px solid var(--input-border); border-right: 1px solid var(--input-border);">
                <button class="btn btn-success px-4" data-action="addCar">è»Šè¿½åŠ </button>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3 px-1">
                <h6 class="mb-0 fw-bold" style="color: var(--text-main); opacity: 0.8;"><i class="fas fa-users me-2"></i>æœªå‰²å½“ãƒ¡ãƒ³ãƒãƒ¼</h6>
                <div class="btn-group shadow-sm">
                    <button class="btn btn-outline-secondary btn-sm" style="font-size:0.85rem;" data-action="auto" data-mode="fill"><i class="fas fa-plus me-1"></i>åŸ‹ã‚ã‚‹</button>
                    <button class="btn btn-outline-secondary btn-sm" style="font-size:0.85rem;" data-action="auto" data-mode="shuffle"><i class="fas fa-random me-1"></i>ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown"></button>
                    <div class="dropdown-menu p-3 shadow" style="min-width:260px;">
                        <h6 class="dropdown-header mb-2">è‡ªå‹•å‰²ã‚Šå½“ã¦è¨­å®š</h6>
                        <div class="form-check mb-2"><input class="form-check-input" type="checkbox" id="optFemale"><label class="form-check-label" for="optFemale">ğŸšº å¥³å­ã‚’ã¾ã¨ã‚ã‚‹</label></div>
                        <div class="form-check mb-2"><input class="form-check-input" type="checkbox" id="optMale"><label class="form-check-label" for="optMale">ğŸš¹ ç”·å­ã‚’ã¾ã¨ã‚ã‚‹</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" id="optGrade"><label class="form-check-label" for="optGrade">ğŸ“ å­¦å¹´ã‚’ã¾ã¨ã‚ã‚‹ (å„ªå…ˆ)</label></div>
                    </div>
                </div>
            </div>
            <div id="waiting-list" class="waiting-area shared-sortable shadow-inner"></div>
        </div>
        <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-center mb-3 px-1">
                <h6 class="mb-0 fw-bold" style="color: var(--text-main); opacity: 0.8;"><i class="fas fa-car-side me-2"></i>é…è»ŠçŠ¶æ³</h6>
                <button class="btn btn-outline-danger btn-sm shadow-sm" style="font-size:0.85rem;" data-action="clear"><i class="fas fa-reply-all me-1"></i>å…¨è§£é™¤</button>
            </div>
            <div id="cars-container" class="row g-4"></div>
        </div>
    </div>
</div>
<div class="share-bar">
    <div class="container" style="max-width:600px;">
        <div class="row g-3">
            <div class="col-6"><button class="btn btn-outline-primary w-100 py-2 fw-bold shadow-sm" data-action="copyLine" style="border-width: 2px;"><i class="far fa-copy me-2"></i>LINEç”¨ã‚³ãƒ”ãƒ¼</button></div>
            <div class="col-6"><button class="btn btn-primary w-100 py-2 fw-bold shadow-sm" data-action="copyUrl"><i class="fas fa-link me-2"></i>URLå…±æœ‰</button></div>
        </div>
    </div>
</div>
<div class="modal fade" id="commonEditModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-header py-3"><h5 class="modal-title fs-6 fw-bold" id="editModalTitle">ç·¨é›†</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body pt-0 pb-3"><input type="text" id="editModalInput" class="form-control" autocomplete="off" style="font-size: 1.1em;"></div><div class="modal-footer py-2"><button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button type="button" class="btn btn-primary btn-sm" id="saveEditBtn">ä¿å­˜</button></div></div></div></div>
<div class="modal fade" id="batchImportModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title fw-bold"><i class="fas fa-paste me-2 text-warning"></i>ä¸€æ‹¬ç™»éŒ²</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="row g-4"><div class="col-md-4"><label class="form-label fw-bold small text-primary">åŒä¹—è€…ãƒªã‚¹ãƒˆ (æ”¹è¡ŒåŒºåˆ‡ã‚Š)</label><textarea id="batchMembers" class="form-control batch-textarea shadow-sm" style="min-height:200px; background-color: var(--input-bg); color: var(--text-main);"></textarea></div><div class="col-md-4"><label class="form-label fw-bold small text-success">1å¹´ç”Ÿãƒªã‚¹ãƒˆ (æ”¹è¡ŒåŒºåˆ‡ã‚Š)</label><textarea id="batchFreshmen" class="form-control batch-textarea shadow-sm" style="min-height:200px; background-color: var(--input-bg); color: var(--text-main);"></textarea></div><div class="col-md-4"><label class="form-label fw-bold small text-secondary">é‹è»¢æ‰‹ãƒªã‚¹ãƒˆ (æ”¹è¡ŒåŒºåˆ‡ã‚Š)</label><textarea id="batchDrivers" class="form-control batch-textarea shadow-sm" style="min-height:200px; background-color: var(--input-bg); color: var(--text-main);"></textarea></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button type="button" class="btn btn-primary px-4" id="execBatchBtn">ç™»éŒ²å®Ÿè¡Œ</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCBJhqD5T05TTQqWw3d2bFbr6keSe9mRyE",
  authDomain: "syawari-maker.firebaseapp.com",
  databaseURL: "https://syawari-maker-default-rtdb.firebaseio.com",
  projectId: "syawari-maker",
  storageBucket: "syawari-maker.firebasestorage.app",
  messagingSenderId: "1050069471490",
  appId: "1:1050069471490:web:fd91fb2b0b54edb46ef21b"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
let dbRef;
let isRemoteUpdate = false;

const urlParams = new URLSearchParams(window.location.search);
let roomId = urlParams.get('room');
if (!roomId) {
    roomId = Math.random().toString(36).substring(2, 8);
    const newUrl = `${window.location.pathname}?room=${roomId}`;
    window.history.replaceState(null, null, newUrl);
}
dbRef = ref(db, 'rooms/' + roomId);

const D=document, L=localStorage, J=JSON;
const $=(s,p=D)=>p.querySelector(s), $$=(s,p=D)=>p.querySelectorAll(s), ce=(t,c)=>{const e=D.createElement(t);if(c)e.className=c;return e}, getInt=v=>parseInt(v)||0;

const CFG = {
    KEY:'6974b918d0998f075852411e', 
    STORE:'sampokai_car_data_v8_compact',
    ICONS:{male:'fa-mars',female:'fa-venus',unknown:'fa-venus-mars'}, 
    TITLES:{male:'ç”·æ€§',female:'å¥³æ€§',unknown:'æœªè¨­å®š'}
};
let modals={}, saveCb;
let genderQueue = [];
let isProcessingQueue = false;
let saveTimer = null; 

D.addEventListener('DOMContentLoaded', () => {
    modals = { edit: new bootstrap.Modal($('#commonEditModal')), batch: new bootstrap.Modal($('#batchImportModal')) };
    
    D.body.onclick = e => {
        const t = e.target, d = t.dataset;
        const act = d.action || t.getAttribute('action'); 
        const cls = t.classList;
        
        if (cls.contains('member-name-text') || cls.contains('driver-name-disp')) { toggleGender(t); return; }
        
        if (cls.contains('edit-btn') || cls.contains('edit-name-btn') || d.edit) { handleEdit(d.edit || (cls.contains('edit-name-btn')?(t.closest('.member-card')?'name':'carName'):(t.closest('.driver-seat')?'driverMemo':'memo')), t); return; }
        if (cls.contains('lock-btn')) { toggleLock(t.closest('.member-card')); return; }
        
        if (!act) return;
        const box = t.closest('.car-box'), card = t.closest('.member-card');
        const ACTIONS = {
            delete: () => {
                if(card && card.dataset.locked==='true') return alert('ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™');
                if(card && card.closest('#waiting-list') && confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) card.remove();
                else if(card) $('#waiting-list').appendChild(card);
                else if(box && confirm('è»Šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { 
                    $$('.member-card', box).forEach(m => {
                         if(m.dataset.locked!=='true') $('#waiting-list').appendChild(m);
                         else if(confirm(`${$('.member-name-text',m).innerText}ã¯ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ãŒã€å‰Šé™¤ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) $('#waiting-list').appendChild(m);
                    }); 
                    if($$('.member-card', box).length === 0) box.closest('.col-md-6').remove();
                }
                updateUI(); save();
            },
            return: () => { if(card.dataset.locked==='true') return; $('#waiting-list').appendChild(card); updateUI(); save(); },
            batch: () => { $$('.batch-textarea').forEach(e=>e.value=''); modals.batch.show(); },
            addCar: () => addCar(), addMember: () => addMember(),
            auto: () => autoAssign(d.mode),
            clear: () => { if(confirm('ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„ãƒ¡ãƒ³ãƒãƒ¼ã‚’å…¨è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ')) { $$('.car-interior-layout .member-card:not([data-locked="true"])').forEach(m => $('#waiting-list').appendChild(m)); updateUI(); save(); } },
            reset: () => { if(confirm('ãƒªã‚»ãƒƒãƒˆï¼Ÿ')) { L.removeItem(CFG.STORE + '_' + roomId); location.href = location.pathname; }},
            copyUrl: () => copy(window.location.href),
            copyLine: () => copyLine()
        };
        if(ACTIONS[act]) ACTIONS[act]();
    };

    $('#saveEditBtn').onclick = () => { saveCb && saveCb(); };
    $('#execBatchBtn').onclick = executeBatch;
    $('#editModalInput').onkeypress = e => { if(e.key==='Enter' && saveCb) saveCb(); };
    $('#newMemberName').onkeypress = e => { if(e.key==='Enter') addMember(); };

    load(); 
    setupSortable($('#waiting-list'));
    const mql = window.matchMedia('(prefers-color-scheme: dark)');
    const checkTheme = () => D.body.dataset.theme = mql.matches ? 'dark' : 'light';
    checkTheme();
    mql.addEventListener('change', checkTheme);
});

function save() { 
    const d = getData();
    L.setItem(CFG.STORE + '_' + roomId, J.stringify(d)); 
    if (!isRemoteUpdate && dbRef) {
        clearTimeout(saveTimer);
        saveTimer = setTimeout(() => { set(dbRef, d).catch(e => console.error("Firebase Error:", e)); }, 500); 
    }
}

function detectGender(name) {
    if (!name) return;
    genderQueue.push(name); 
    processGenderQueue();
}

async function processGenderQueue() {
    if (isProcessingQueue) return; 
    isProcessingQueue = true; 
    try {
        while (genderQueue.length > 0) {
            const name = genderQueue.shift();
            let gender = 'unknown';
            try { gender = await fetchGenderFromApi(name); } catch (e) { console.warn(`API Failed for ${name}:`, e); }

            if (gender !== 'unknown') {
                const targets = document.querySelectorAll(`[data-name="${name}"]`);
                if (targets.length > 0) {
                    targets.forEach(el => {
                        const card = el.closest('.member-card') || el.closest('.driver-seat');
                        if (card) {
                            card.dataset.gender = gender;
                            // ã‚¢ã‚¤ã‚³ãƒ³ã¯ãªããªã£ãŸã®ã§æç”»å‡¦ç†ã¯ä¸è¦
                        }
                    });
                    save(); 
                }
            }
            await new Promise(resolve => setTimeout(resolve, 200));
        }
    } finally { isProcessingQueue = false; }
}

async function fetchGenderFromApi(name) {
    if (name.endsWith('å­') || name.endsWith('ç¾') || name.endsWith('ä»£') || name.endsWith('å¥ˆ') || name.endsWith('é¦™') || name.endsWith('éŸ³')) return 'female';
    if (name.endsWith('éƒ') || name.endsWith('å¤ª') || name.endsWith('åŠ©') || name.endsWith('å¤«') || name.endsWith('ç”·') || name.endsWith('å¹³')) return 'male';

    try {
        const url = `https://api.genderapi.io/api/?name=${encodeURIComponent(name)}&key=${CFG.KEY}`;
        const res = await fetch(url);
        if (res.ok) {
            const data = await res.json();
            if (data.gender === 'male') return 'male';
            if (data.gender === 'female') return 'female';
        }
    } catch(e) { console.error("Fetch Error:", e); }
    return 'unknown';
}

function toggleGender(target) {
    const p = target.closest(target.closest('.member-card') ? '.member-card' : '.driver-seat');
    const next = {unknown:'male',male:'female',female:'unknown'}[p.dataset.gender]||'male';
    p.dataset.gender = next; 
    save();
}
function toggleLock(card) {
    const isLocked = card.dataset.locked === 'true';
    card.dataset.locked = !isLocked;
    const icon = $('.lock-btn', card);
    icon.className = `fas lock-btn action-btn ${!isLocked ? 'fa-lock' : 'fa-unlock'}`;
    icon.title = !isLocked ? 'å›ºå®šä¸­' : 'å›ºå®šè§£é™¤';
    save();
}

function addMember(n, m='', g='unknown', f=false, parent=$('#waiting-list'), locked=false) {
    const name = n || $('#newMemberName').value; if(!name) return;
    const d = ce('div', 'member-card'); 
    Object.assign(d.dataset, {gender:g, freshman:f, locked:locked});
    d.setAttribute('data-name', name); 

    // æ€§åˆ¥ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‰Šé™¤ (card-top-rowå†…)
    d.innerHTML = `
        <div class="handle"><i class="fas fa-grip-vertical"></i></div>
        <div class="card-top-row">${f?'<i class="fas fa-leaf freshman-icon" title="1å¹´ç”Ÿ"></i>':''}<span class="member-name-text" title="${name}">${name}</span><i class="fas fa-pencil-alt edit-name-btn"></i></div>
        <div class="memo-popup" style="display:${m?'block':'none'}">${m}</div>
        <div class="card-bottom-row"><div class="d-flex align-items-center"><i class="fas fa-sticky-note memo-indicator ${m?'':'empty'} edit-btn"></i></div><div class="d-flex align-items-center"><i class="fas ${locked?'fa-lock':'fa-unlock'} action-btn lock-btn" title="${locked?'å›ºå®šä¸­':'å›ºå®šè§£é™¤'}"></i><i class="fas action-btn state-action-btn" data-action="${parent.id==='waiting-list'?'delete':'return'}"></i></div></div>
    `;
    parent.appendChild(d);
    
    if(!n) { $('#newMemberName').value=''; detectGender(name); save(); }
    return d;
}

function addCar(n, cap, mems=[], dm='', dg='unknown') {
    const name = n || $('#newCarName').value, c = cap || $('#newCarCapacity').value; if(!name) return;
    const col = ce('div', 'col-md-6 mb-2');
    // æ€§åˆ¥ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‰Šé™¤ (driver-seatå†…)
    col.innerHTML = `<div class="car-box" data-capacity="${c}"><div class="car-header"><div class="d-flex align-items-center"><i class="fas fa-car me-2"></i><span class="car-name-text">${name} è»Š</span></div><div><span class="badge capacity-badge me-2 bg-secondary" style="cursor:pointer;" data-edit="capacity">0/${c}</span><i class="fas fa-trash-alt action-btn delete-btn" data-action="delete"></i></div></div><div class="car-interior-layout"><div class="front-row"><div class="seat-area sortable-area passenger-seat"></div><div class="seat-area driver-seat" data-gender="${dg}" data-name="${name}"><div class="w-100"><span class="driver-label">DRIVER</span><div class="card-top-row"><span class="driver-name-disp fw-bold text-truncate" style="flex:1; margin:0 4px;">${name}</span><i class="fas fa-pencil-alt edit-name-btn"></i></div></div><div class="memo-popup driver-memo-text" style="display:${dm?'block':'none'}">${dm}</div><div class="card-bottom-row mt-1 w-100" style="border-top:1px dashed rgba(0,0,0,0.1); padding-top:2px;"><i class="fas fa-sticky-note memo-indicator ${dm?'':'empty'} edit-btn"></i></div></div></div><div class="seat-area sortable-area rear-seats"></div></div></div>`;
    $('#cars-container').appendChild(col);
    const [pS, rS] = [$('.passenger-seat',col), $('.rear-seats',col)];
    setupSortable(pS); setupSortable(rS);
    mems.forEach((m,i) => addMember(m.name,m.memo,m.gender,m.isFreshman,i===0?pS:rS, m.locked));
    if(!n) { $('#newCarName').value=''; detectGender(name); save(); }
    updateUI();
}

function setupSortable(el) { 
    new Sortable(el,{
        group: 'shared',
        animation: 150,
        handle: '.handle', 
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        fallbackClass: 'sortable-fallback',
        forceFallback: true,
        fallbackOnBody: true,
        touchStartThreshold: 3,
        scroll: true, 
        scrollSensitivity: 30,
        delay: 0, 
        onEnd: () => { updateUI(); save(); }
    }); 
}

function autoAssign(mode) {
    const opts = { f: $('#optFemale').checked, m: $('#optMale').checked, g: $('#optGrade').checked };
    const isSmartMode = opts.f || opts.m || opts.g;
    
    // ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„ãƒ¡ãƒ³ãƒãƒ¼ã‚’å…¨å›å
    const getM = el => Array.from(el.children).filter(c => c.dataset.locked !== 'true').map(c => { const d = getMemData(c); c.remove(); return d; });
    let mems = getM($('#waiting-list'));
    
    if (mode === 'shuffle') {
        if (!confirm("ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„ãƒ¡ãƒ³ãƒãƒ¼ã‚’å†ç·¨æˆã—ã¾ã™ã‹ï¼Ÿ")) { 
            mems.forEach(m => addMember(m.name, m.memo, m.gender, m.isFreshman, $('#waiting-list'), m.locked)); 
            return; 
        }
        $$('.car-box').forEach(c => { mems.push(...getM($('.passenger-seat', c)), ...getM($('.rear-seats', c))); });
    }
    
    if (!mems.length) return;
    
    // Fisher-Yates shuffle
    const shuffle = a => { for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; };
    
    let cars = Array.from($$('.car-box'));
    cars = shuffle(cars); 

    // æ–°ã‚·ãƒ£ãƒƒãƒ•ãƒ«ãƒ­ã‚¸ãƒƒã‚¯: ä¸Šç´šç”Ÿã‚µãƒãƒ¼ãƒˆé‡è¦–
    if (mode === 'shuffle') {
        const seniors = mems.filter(m => !m.isFreshman);
        const freshmen = mems.filter(m => m.isFreshman);

        shuffle(seniors);
        shuffle(freshmen);

        // å„è»Šã«ã¾ãšã€Œé‹è»¢æ‰‹ä»¥å¤–ã®ä¸Šç´šç”Ÿã€ã‚’1äººãšã¤é…ã‚‹ï¼ˆã‚µãƒãƒ¼ãƒˆå½¹ã®ç¢ºä¿ï¼‰
        cars.forEach(car => {
            const cap = getInt(car.dataset.capacity);
            const currentMems = getCarMembersData(car);
            if (currentMems.length >= cap) return;
            const hasSeniorPassenger = currentMems.some(m => !m.isFreshman);
            if (!hasSeniorPassenger && seniors.length > 0) {
                const s = seniors.pop();
                addMemberToCar(s, car);
            }
        });

        // æ®‹ã‚Šã®å…¨ãƒ¡ãƒ³ãƒãƒ¼ï¼ˆ1å¹´ç”Ÿï¼‹ä½™ã£ãŸä¸Šç´šç”Ÿï¼‰ã‚’æ··ãœã¦ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        let remain = [...seniors, ...freshmen];
        remain = shuffle(remain);

        // æ®‹ã‚Šã®ç©ºãåº§å¸­ã«ã€ãƒã‚±ãƒƒãƒˆåˆ¶ã§å…¬å¹³ã«ãƒ©ãƒ³ãƒ€ãƒ é…ç½®
        let slots = [];
        cars.forEach(car => {
            const cap = getInt(car.dataset.capacity);
            const cur = getCarMembers(car).length;
            for(let i=0; i < (cap - cur); i++) slots.push(car);
        });
        
        slots = shuffle(slots);

        remain.forEach((member, i) => {
            if (i < slots.length) {
                addMemberToCar(member, slots[i]);
            } else {
                addMember(member.name, member.memo, member.gender, member.isFreshman, $('#waiting-list'), member.locked);
            }
        });

        updateUI(); save(); 
        return;
    }

    // ã‚¹ãƒãƒ¼ãƒˆå‰²ã‚Šå½“ã¦ï¼ˆæ¡ä»¶ã‚ã‚Šï¼‰ã®ãƒ­ã‚¸ãƒƒã‚¯
    mems.sort((a, b) => {
        let pA = 0, pB = 0;
        if (opts.f && a.gender === 'female') pA += 20; if (opts.m && a.gender === 'male') pA += 20; if (opts.g && a.isFreshman) pA += 10;
        if (opts.f && b.gender === 'female') pB += 20; if (opts.m && b.gender === 'male') pB += 20; if (opts.g && b.isFreshman) pB += 10;
        return pB - pA;
    });
    
    mems.forEach(member => {
        let bestCar = null, bestScore = -Infinity;
        cars.forEach(car => {
            if (getCarMembers(car).length >= getInt(car.dataset.capacity)) return;
            const score = calculateMemberScore(member, [getDriverData(car), ...getCarMembersData(car)], opts);
            const jitter = Math.random(); 
            if (score + jitter > bestScore) { bestScore = score + jitter; bestCar = car; }
        });
        if (bestCar) addMemberToCar(member, bestCar);
        else addMember(member.name, member.memo, member.gender, member.isFreshman, $('#waiting-list'), member.locked);
    });
    
    optimizeDistribution(cars, opts);
    updateUI(); save();
}

function addMemberToCar(member, carElement) {
    const target = ($('.passenger-seat', carElement).children.length ? $('.rear-seats', carElement) : $('.passenger-seat', carElement));
    addMember(member.name, member.memo, member.gender, member.isFreshman, target, member.locked);
}
function getCarMembers(car) { return [...$$('.passenger-seat .member-card', car), ...$$('.rear-seats .member-card', car)]; }
function getCarMembersData(car) { return getCarMembers(car).map(getMemData); }
function getDriverData(car) { return { gender: $('.driver-seat', car).dataset.gender, isFreshman: false, isDriver: true }; }

function optimizeDistribution(cars, opts) {
    for (let i = 0; i < 1000; i++) {
        const carA = cars[Math.floor(Math.random() * cars.length)];
        const carB = cars[Math.floor(Math.random() * cars.length)];
        if (carA === carB) continue;
        
        const memsA = getCarMembers(carA), memsB = getCarMembers(carB);
        const candA = memsA.length ? memsA[Math.floor(Math.random() * memsA.length)] : null;
        const candB = memsB.length ? memsB[Math.floor(Math.random() * memsB.length)] : null;
        
        if (!candA && !candB) continue;
        if ((candA && candA.dataset.locked==='true') || (candB && candB.dataset.locked==='true')) continue;

        const scoreBefore = getCarTotalScore(carA, opts) + getCarTotalScore(carB, opts);
        
        const dataA = getCarMembersData(carA), dataB = getCarMembersData(carB);
        const driverA = getDriverData(carA), driverB = getDriverData(carB);
        
        let newDataA = [...dataA], newDataB = [...dataB];
        if (candA) newDataA = newDataA.filter(m => m.name !== getMemData(candA).name);
        if (candB) newDataB = newDataB.filter(m => m.name !== getMemData(candB).name);
        if (candB) newDataA.push(getMemData(candB));
        if (candA) newDataB.push(getMemData(candA));
        
        if (newDataA.length > getInt(carA.dataset.capacity) || newDataB.length > getInt(carB.dataset.capacity)) continue;
        
        const scoreAfter = calcGroupScore(newDataA, driverA, opts) + calcGroupScore(newDataB, driverB, opts);
        
        if (scoreAfter > scoreBefore || (scoreAfter === scoreBefore && Math.random() < 0.2)) {
            performSwap(carA, candA, carB, candB);
        }
    }
}
function performSwap(carA, memElA, carB, memElB) {
    const dataA = memElA ? getMemData(memElA) : null, dataB = memElB ? getMemData(memElB) : null;
    if (memElA) memElA.remove(); if (memElB) memElB.remove();
    if (dataA) addMemberToCar(dataA, carB); if (dataB) addMemberToCar(dataB, carA);
}
function getCarTotalScore(car, opts) { return calcGroupScore(getCarMembersData(car), getDriverData(car), opts); }

function calcGroupScore(mems, driver, opts) {
    let score = 0;
    const occupants = [driver, ...mems];
    if (mems.length > 0) score += 100;
    
    // å­¦å¹´ãƒã‚§ãƒƒã‚¯ï¼ˆä¸Šç´šç”Ÿã‚µãƒãƒ¼ãƒˆé‡è¦–ï¼‰
    if (opts.g) {
        const freshCount = mems.filter(m => m.isFreshman).length;
        const seniorCount = mems.filter(m => !m.isFreshman).length;
        if (seniorCount >= 1) score += 5000;
        if (freshCount > 0 && seniorCount === 0) score -= 20000;
        if (freshCount === 1) score -= 10000; 
        if (freshCount >= 2) score += 2000;
    }
    
    // ç”·å¥³ãƒã‚§ãƒƒã‚¯
    const targetFemale = opts.f, targetMale = opts.m;
    if (targetFemale || targetMale) {
        const females = occupants.filter(o => o.gender === 'female').length;
        const males = occupants.filter(o => o.gender === 'male').length;
        if (targetFemale && females > 0 && males > 0) score -= 50000;
        if (targetMale && males > 0 && females > 0) score -= 50000;
        if ((targetFemale && females === 1) || (targetMale && males === 1)) score -= 10000;
    }
    return score;
}

function calculateMemberScore(member, occupants, opts) {
    let score = 0;
    const passengers = occupants.filter(o => !o.isDriver);
    if (passengers.length === 0) score += 50; else score += 100;
    
    if (opts.g) {
        if (!member.isFreshman) {
            const hasSenior = passengers.some(m => !m.isFreshman);
            if (!hasSenior) score += 5000; 
        } else {
            const freshInCar = passengers.filter(o => o.isFreshman).length;
            const seniorInCar = passengers.filter(o => !o.isFreshman).length;
            if (seniorInCar > 0) score += 3000;
            if (freshInCar >= 1) score += 3000;
        }
    }
    
    if ((opts.f && member.gender === 'female') || (opts.m && member.gender === 'male')) {
        if (occupants.filter(o => o.gender !== member.gender && o.gender !== 'unknown').length > 0) score -= 20000;
        else if (occupants.filter(o => o.gender === member.gender).length > 0) score += 5000;
    }
    return score;
}

function executeBatch() {
    const p=id=>$(id).value.split(/\n/).map(s=>s.trim()).filter(Boolean);
    const m=p('#batchMembers'), f=p('#batchFreshmen'), d=p('#batchDrivers');
    if(!m.length&&!f.length&&!d.length) return alert('ç©ºã§ã™');
    m.forEach(n=>detectGender(addMember(n).dataset.name));
    f.forEach(n=>detectGender(addMember(n,'','unknown',true).dataset.name));
    d.forEach(n=>{
        addCar(n,3);
        const cars = $$('.car-box');
        detectGender($('.driver-seat', cars[cars.length-1]).dataset.name);
    });
    save(); modals.batch.hide(); alert(`å®Œäº†: åŒä¹—${m.length+f.length} è»Š${d.length}`);
}

function handleEdit(type, el) {
    const box=el.closest('.car-box'), card=el.closest('.member-card');
    const MAP = {
        capacity: { t:'å®šå“¡å¤‰æ›´', v:()=>box.dataset.capacity, set:v=>{if(getInt(v)>0)box.dataset.capacity=getInt(v);} },
        carName: { t:'è»Šåå¤‰æ›´', v:()=>$('.driver-name-disp',box).innerText, set:v=>{if(v){$('.driver-name-disp',box).innerText=v;$('.car-name-text',box).innerText=v+' è»Š';box.querySelector('.driver-seat').dataset.name=v;}} },
        name: { t:'åå‰ä¿®æ­£', v:()=>$('.member-name-text',card).innerText, set:v=>{if(v){$('.member-name-text',card).innerText=v;card.dataset.name=v;}} },
        memo: { t:'ãƒ¡ãƒ¢', v:()=>$('.memo-popup',card).innerText, set:v=>upMemo(card,v) },
        driverMemo: { t:'é‹è»¢æ‰‹ãƒ¡ãƒ¢', v:()=>$('.driver-memo-text',el.closest('.driver-seat')).innerText, set:v=>upMemo(el.closest('.driver-seat'),v,'.driver-memo-text') }
    };
    const c=MAP[type]; $('#editModalTitle').innerText=c.t; $('#editModalInput').value=c.v();
    saveCb=()=>{c.set($('#editModalInput').value); updateUI(); save(); modals.edit.hide();};
    modals.edit.show(); setTimeout(()=>$('#editModalInput').focus(),500);
}
const upMemo = (p,v,s='.memo-popup') => { const m=$(s,p),i=$('.memo-indicator',p); m.innerText=v; m.style.display=v?'block':'none'; i.classList.toggle('empty',!v); };
function updateUI() {
    $$('.car-box').forEach(b => {
        const c=getInt(b.dataset.capacity), n=$$('.member-card',b).length, bad=$('.capacity-badge',b);
        bad.textContent=`åŒä¹— ${n} / ${c}`; b.classList.toggle('over-capacity',n>c);
        bad.className=`badge capacity-badge me-2 bg-${n>c?'danger':(n===c?'success':'secondary')}`;
        $$('.state-action-btn',b).forEach(e=>{e.className='fas fa-reply action-btn return-btn state-action-btn';e.title='æˆ»ã™';e.setAttribute('data-action','return');});
    });
    $$('#waiting-list .state-action-btn').forEach(e=>{e.className='fas fa-times action-btn delete-btn state-action-btn';e.title='å‰Šé™¤';e.setAttribute('data-action','delete');});
}

function getMemData(el) { return {name:$('.member-name-text',el).innerText, memo:$('.memo-popup',el).innerText, gender:el.dataset.gender, isFreshman:el.dataset.freshman==='true', locked:el.dataset.locked==='true'}; }
function getData() { return { waiting: Array.from($$('#waiting-list .member-card')).map(getMemData), cars: Array.from($$('.car-box')).map(c=>({ name:$('.driver-name-disp',c).innerText, capacity:c.dataset.capacity, driverMemo:$('.driver-memo-text',c).innerText, driverGender:$('.driver-seat',c).dataset.gender, members:[...$$('.passenger-seat .member-card',c),...$$('.rear-seats .member-card',c)].map(getMemData) })) }; }

function load() { 
    onValue(dbRef, (snapshot) => {
        const val = snapshot.val();
        if (val) {
            isRemoteUpdate = true; 
            restore(val);
            isRemoteUpdate = false;
        } else {
            const local = J.parse(L.getItem(CFG.STORE + '_' + roomId));
            if(local) { restore(local); save(); } 
        }
    });
}

function restore(d) { 
    const knownGenders = {};
    const scan = (el) => { if(el && el.dataset.name && el.dataset.gender!=='unknown') knownGenders[el.dataset.name] = el.dataset.gender; };
    $$('.member-card').forEach(scan);
    $$('.driver-seat').forEach(scan);

    $('#waiting-list').innerHTML=''; 
    $('#cars-container').innerHTML=''; 
    const n = m => {
        let obj = typeof m==='string' ? {name:m} : m;
        if (knownGenders[obj.name] && (obj.gender === 'unknown' || !obj.gender)) {
            obj.gender = knownGenders[obj.name];
        }
        return obj;
    };

    (d.waiting||[]).forEach(m=>{const x=n(m);addMember(x.name,x.memo,x.gender,x.isFreshman, $('#waiting-list'), x.locked);}); 
    (d.cars||[]).forEach(c=>{
        let dG = c.driverGender;
        if(knownGenders[c.name] && (dG === 'unknown' || !dG)) dG = knownGenders[c.name];
        addCar(c.name,c.capacity,(c.members||[]).map(n),c.driverMemo,dG);
    }); 
    updateUI(); 
}

function copy(t) { navigator.clipboard.writeText(t).then(()=>alert('ã‚³ãƒ”ãƒ¼å®Œäº†'),()=>alert('å¤±æ•—')); }
function copyLine() {
    const d=getData(); let t="ã€å±±æ­©ä¼š è»Šå‰²è¡¨ã€‘\n\n";
    d.cars.forEach(c=>{ t+=`ğŸš— ${c.name} è»Š ${c.members.length>=c.capacity?"ğŸˆµ":`(ã‚ã¨${c.capacity-c.members.length}äºº)`}\n  [é‹è»¢] ${c.name}${c.driverMemo?` (${c.driverMemo})`:''}\n  [åŒä¹—] ${c.members.map(m=>m.name+(m.isFreshman?'ğŸ”°':'')+(m.memo?`(${m.memo})`:'')).join(", ")||"ãªã—"}\n\n`;});
    if(d.waiting.length) t+="ğŸ“ æœªå‰²å½“\n"+d.waiting.map(m=>m.name+(m.isFreshman?'ğŸ”°':'')+(m.memo?`(${m.memo})`:'')).join(", ")+"\n";
    copy(t+"\nãƒ„ãƒ¼ãƒ«: "+location.href.split('?')[0]);
}
</script>
</body>
</html>
