<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å±±æ­©ä¼šä¼šè¨ˆç²¾ç®—ãƒ„ãƒ¼ãƒ« Pro</title>

<style>
:root {
    --primary: #2e7d32; /* è‡ªç„¶ã‚’æ„Ÿã˜ã‚‹æ·±ç·‘ */
    --primary-light: #e8f5e9;
    --accent: #f57c00; /* æ³¨æ„ãƒ»å¼·èª¿ã®ã‚ªãƒ¬ãƒ³ã‚¸ */
    --danger: #d32f2f;
    --history: #0288d1;
    --text-main: #2c3e50;
    --text-sub: #546e7a;
    --bg: #f0f2f5;
    --card: #ffffff;
    --radius: 12px;
    --shadow: 0 4px 20px rgba(0,0,0,0.08);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
    font-family: "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
    margin: 0;
    padding: 20px 15px;
    background: var(--bg);
    color: var(--text-main);
    line-height: 1.6;
}

.container {
    max-width: 500px;
    margin: 0 auto;
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
header {
    text-align: center;
    margin-bottom: 25px;
}
h1 { font-size: 1.6rem; margin: 0; color: var(--primary); display: flex; align-items: center; justify-content: center; gap: 8px; }
h1 span { font-size: 1.2rem; display: block; color: var(--text-sub); font-weight: normal; }

/* ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
.card {
    background: var(--card);
    padding: 20px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    margin-bottom: 20px;
}

h2 { font-size: 1.1rem; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px; border-bottom: 2px solid var(--primary-light); padding-bottom: 8px; }

/* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
.input-group { margin-bottom: 15px; }
label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 6px; color: var(--text-sub); }
input[type="number"], input[type="text"] {
    width: 100%; padding: 12px; border: 1px solid #cfd8dc; border-radius: 8px; font-size: 16px; transition: border 0.2s;
}
input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }

.flex-row { display: flex; gap: 10px; }
.flex-row > div { flex: 1; }

/* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
.checkbox-card {
    display: flex; align-items: center; gap: 10px; background: var(--primary-light);
    padding: 12px; border-radius: 8px; cursor: pointer; user-select: none;
}
.checkbox-card input { width: 18px; height: 18px; cursor: pointer; }

/* è»Šä¸¡ã‚«ãƒ¼ãƒ‰ */
.car-card {
    border: 1.5px solid #e0e0e0; border-radius: 10px; padding: 15px; margin-bottom: 15px; position: relative;
    background: #fff; transition: transform 0.2s;
}
.car-card:hover { border-color: var(--primary); }
.car-badge {
    position: absolute; top: -10px; left: 15px; background: var(--primary);
    color: white; padding: 2px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold;
}
.remove-btn { 
    position: absolute; top: 10px; right: 10px; color: var(--danger); 
    background: #ffebee; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer;
}

/* çµŒè²»ãƒªã‚¹ãƒˆ */
.extra-section { background: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 10px; }
.extra-item { display: flex; gap: 5px; margin-bottom: 8px; }

/* ãƒœã‚¿ãƒ³ */
.btn {
    width: 100%; border: none; border-radius: 50px; font-size: 1rem; font-weight: bold;
    padding: 14px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
}
.btn-primary { background: var(--primary); color: white; margin-top: 10px; box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3); }
.btn-primary:active { transform: scale(0.98); }
.btn-outline { background: white; border: 2px dashed #b0bec5; color: var(--text-sub); margin-bottom: 15px; padding: 10px; }
.btn-reset { background: none; color: var(--text-sub); font-size: 0.85rem; margin-top: 15px; text-decoration: underline; }

/* çµæœè¡¨ç¤º */
#resultArea { display: none; animation: slideUp 0.4s ease-out; }
@keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

.result-header { text-align: center; margin-bottom: 20px; }
.price-tag { font-size: 2.2rem; font-weight: 900; color: var(--primary); display: block; }
.driver-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
.driver-info small { color: var(--text-sub); display: block; font-size: 0.75rem; }

.copy-box { background: #37474f; padding: 15px; border-radius: 8px; margin-top: 10px; }
#copyTextarea { 
    width: 100%; height: 100px; background: transparent; border: none; color: #eceff1; 
    font-size: 0.85rem; resize: none; font-family: monospace;
}
.btn-copy { background: var(--accent); color: white; padding: 10px; margin-top: 10px; border-radius: 6px; border: none; width: 100%; font-weight: bold; cursor: pointer; }

/* å±¥æ­´ */
.history-item { 
    background: #fff; border-left: 4px solid var(--history); padding: 12px; 
    margin-bottom: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.h-date { font-size: 0.75rem; color: var(--text-sub); }
.h-summary { font-weight: bold; font-size: 0.9rem; }
.history-btns { display: flex; gap: 10px; }

</style>
</head>
<body>

<div class="container">
    <header>
        <h1>â›°ï¸ å±±æ­©ä¼šç”¨ç²¾ç®— <span>Gasoline Calculator</span></h1>
    </header>

    <div class="card">
        <h2>âš™ï¸ åŸºæœ¬è¨­å®š</h2>
        <div class="input-group">
            <label>åˆè¨ˆå‚åŠ äººæ•°</label>
            <input type="number" id="totalPeople" placeholder="ä¾‹: 12" inputmode="numeric">
        </div>
        <label class="checkbox-card">
            <input type="checkbox" id="organizerFree">
            <span>ä¼ç”»è€…ã¯ã‚¬ã‚½ãƒªãƒ³ä»£ã‚’å…é™¤ã™ã‚‹</span>
        </label>
    </div>

    <div class="card">
        <h2>ğŸš— è»Šä¸¡ãƒ»ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ç™»éŒ²</h2>
        <div id="carList"></div>
        <button class="btn btn-outline" onclick="addCar()">+ è»Šä¸¡ã‚’è¿½åŠ </button>
    </div>

    <button class="btn btn-primary" onclick="calculate()">ğŸš€ ç²¾ç®—ã‚’å®Ÿè¡Œã™ã‚‹</button>
    <button class="btn btn-reset" onclick="resetAll()">å…¨ã¦ã®å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ</button>

    <div id="resultArea">
        <div class="card" style="border-top: 6px solid var(--primary);">
            <div class="result-header">
                <label>1äººã‚ãŸã‚Šã®å¾´åé¡</label>
                <span class="price-tag" id="resPerPerson">0å††</span>
                <small id="resTargetDetail" style="color:var(--text-sub)"></small>
            </div>

            <div class="res-section">
                <label>ğŸš• ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¸ã®æ”¯æ‰•ã„</label>
                <div id="resDriverList"></div>
            </div>

            <div class="res-section" style="margin-top:20px; padding-top:15px; border-top: 1px dashed #ccc;">
                <label>ğŸ’° ã‚µãƒ¼ã‚¯ãƒ«ä¼šè¨ˆç²¾ç®—</label>
                <div style="font-size:0.9rem; display: flex; justify-content: space-between; margin-top:5px;">
                    <span>çµŒè²»ãƒ»èª¿æ•´é‡‘åˆè¨ˆ</span>
                    <span id="resCircleExpense">0å††</span>
                </div>
                <div style="font-size:0.9rem; display: flex; justify-content: space-between; color: var(--primary);">
                    <span>ç«¯æ•°å……å½“é¡</span>
                    <span id="resGasSurplus">0å††</span>
                </div>
                <div style="font-size:1.1rem; font-weight: bold; display: flex; justify-content: space-between; margin-top:10px; color: var(--danger);">
                    <span>ä¼šè¨ˆã‹ã‚‰ã®å®Ÿæ”¯å‡º</span>
                    <span id="resWithdraw">0å††</span>
                </div>
            </div>
        </div>

        <div class="card" style="background: #37474f; color: white;">
            <h2 style="color: white; border-color: #546e7a;">ğŸ“± LINEé€ä¿¡ç”¨ãƒ†ã‚­ã‚¹ãƒˆ</h2>
            <div class="copy-box">
                <textarea id="copyTextarea" readonly></textarea>
                <button class="btn-copy" onclick="copyToClipboard()">ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>
        </div>
    </div>

    <div class="history-section" style="margin-top: 40px;">
        <h2 style="border:none; color: var(--history);">ğŸ•’ æœ€è¿‘ã®å±¥æ­´</h2>
        <div id="historyList"></div>
    </div>
</div>

<script>
// --- åŸºæœ¬æ©Ÿèƒ½ã®JSãƒ­ã‚¸ãƒƒã‚¯ ---
const DEFAULT_CAR = { name: "", dist: "", eco: "", price: "", extras: [] };

window.onload = function() {
    loadDraft();
    updateHistory();
};

function addCar(data = null) {
    const list = document.getElementById('carList');
    const idx = list.children.length;
    const c = data || { ...DEFAULT_CAR, extras: [] };

    const div = document.createElement('div');
    div.className = 'car-card';
    div.innerHTML = `
        <span class="car-badge">è»Šä¸¡ ${idx+1}</span>
        <button class="remove-btn" onclick="removeCar(this)">Ã—</button>
        
        <div class="input-group" style="margin-top:10px;">
            <label>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼å</label>
            <input type="text" class="inp-name" value="${c.name}" placeholder="æ°å">
        </div>
        
        <div class="flex-row">
            <div class="input-group">
                <label>è·é›¢(km)</label>
                <input type="number" class="inp-dist" value="${c.dist}" placeholder="0" inputmode="decimal">
            </div>
            <div class="input-group">
                <label>ç‡ƒè²»(L)</label>
                <input type="number" class="inp-eco" value="${c.eco}" placeholder="15" inputmode="decimal">
            </div>
            <div class="input-group">
                <label>å˜ä¾¡(å††)</label>
                <input type="number" class="inp-price" value="${c.price}" placeholder="170" inputmode="numeric">
            </div>
        </div>

        <div class="extra-section">
            <label style="margin-bottom:8px; display:block;">â• è«¸è²»ç”¨ï¼ˆé«˜é€Ÿãƒ»é§è»Šå ´ç­‰ï¼‰</label>
            <div id="extras-${idx}"></div>
            <button class="btn-reset" style="padding:0; margin:5px 0 0 0;" onclick="addExtra(${idx})">+ é …ç›®ã‚’è¿½åŠ </button>
        </div>
    `;
    list.appendChild(div);
    if(c.extras) c.extras.forEach(ex => addExtra(idx, ex.name, ex.amount));
}

function addExtra(idx, name="", amount="") {
    const box = document.getElementById(`extras-${idx}`);
    const div = document.createElement('div');
    div.className = 'extra-item';
    div.innerHTML = `
        <input type="text" class="ex-name" placeholder="åç›®" value="${name}" style="flex:2; padding:8px; font-size:14px;">
        <input type="number" class="ex-amount" placeholder="é‡‘é¡" value="${amount}" style="flex:1; padding:8px; font-size:14px;" inputmode="numeric">
        <button class="remove-btn" style="position:static; width:35px; height:35px;" onclick="this.parentElement.remove()">Ã—</button>
    `;
    box.appendChild(div);
}

function removeCar(btn){ 
    if(confirm("ã“ã®è»Šä¸¡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        btn.closest('.car-card').remove(); 
        saveDraft(); 
    }
}

function calculate() {
    const totalPeople = parseInt(document.getElementById('totalPeople').value);
    const isOrgFree = document.getElementById('organizerFree').checked;
    
    if (!totalPeople || totalPeople <= 0) { 
        alert("æœ‰åŠ¹ãªå‚åŠ äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); 
        return; 
    }

    const cards = document.querySelectorAll('.car-card');
    if (cards.length === 0) {
        alert("è»Šä¸¡ã‚’å°‘ãªãã¨ã‚‚1å°ç™»éŒ²ã—ã¦ãã ã•ã„");
        return;
    }

    let totalGas = 0; 
    let totalExtras = 0; 
    let totalReward = 0;
    let drivers = [];
    let carDatas = [];

    cards.forEach((card) => {
        const name = card.querySelector('.inp-name').value || "ãƒ‰ãƒ©ã‚¤ãƒãƒ¼";
        const dist = parseFloat(card.querySelector('.inp-dist').value) || 0;
        const eco = parseFloat(card.querySelector('.inp-eco').value) || 1;
        const price = parseFloat(card.querySelector('.inp-price').value) || 0;
        const gas = Math.round((dist / eco) * price);
        
        let extras = 0; 
        let exs = [];
        card.querySelectorAll('.extra-item').forEach(row => {
            const val = parseInt(row.querySelector('.ex-amount').value) || 0;
            const nm = row.querySelector('.ex-name').value || "çµŒè²»";
            if(val > 0) { extras += val; exs.push({name: nm, amount: val}); }
        });

        totalGas += gas; 
        totalExtras += extras; 
        totalReward += 1000; // é‹è»¢èª¿æ•´æ‰‹å½“
        
        drivers.push({ 
            name, 
            pay: gas + extras + 1000, 
            desc: `ã‚¬ã‚¹:${gas.toLocaleString()} / è«¸è²»:${extras.toLocaleString()} / èª¿æ•´:1,000` 
        });
        carDatas.push({ name, dist, eco, price, extras: exs });
    });

    const payers = isOrgFree ? (totalPeople - 1) : totalPeople;
    // 100å††å˜ä½åˆ‡ã‚Šä¸Šã’
    const perPersonGas = Math.ceil((totalGas / payers) / 100) * 100;
    const collectedGasTotal = perPersonGas * payers;
    const gasSurplus = collectedGasTotal - totalGas;
    const circleNeed = (totalExtras + totalReward) - gasSurplus;

    // --- è¡¨ç¤ºåæ˜  ---
    document.getElementById('resPerPerson').textContent = perPersonGas.toLocaleString() + " å††";
    document.getElementById('resTargetDetail').innerHTML = `å¯¾è±¡è€…: ${payers}å / ã‚¬ã‚½ãƒªãƒ³ç·é¡: ${totalGas.toLocaleString()}å††`;
    
    const dList = document.getElementById('resDriverList');
    dList.innerHTML = "";
    drivers.forEach(d => {
        const row = document.createElement('div');
        row.className = 'driver-row';
        row.innerHTML = `
            <div class="driver-info">
                <strong>${d.name} æ§˜</strong>
                <small>${d.desc}</small>
            </div>
            <div style="font-weight:bold; color:var(--text-main);">${d.pay.toLocaleString()} å††</div>`;
        dList.appendChild(row);
    });

    document.getElementById('resCircleExpense').textContent = (totalExtras + totalReward).toLocaleString() + " å††";
    document.getElementById('resGasSurplus').textContent = "-" + gasSurplus.toLocaleString() + " å††";
    document.getElementById('resWithdraw').textContent = circleNeed.toLocaleString() + " å††";
    
    document.getElementById('resultArea').style.display = 'block';
    window.scrollTo({ top: document.getElementById('resultArea').offsetTop - 20, behavior: 'smooth' });

    // --- LINEãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ ---
    let lineText = `ã€ç²¾ç®—å ±å‘Š ğŸš™ã€‘\n`;
    lineText += `â– å‚åŠ è€…å¾´åï¼ˆã‚¬ã‚½ãƒªãƒ³ä»£ï¼‰\n1äººï¼š${perPersonGas.toLocaleString()}å††\n`;
    if(isOrgFree) lineText += `ï¼ˆâ€»ä¼ç”»è€…ã¯å…é™¤ã¨ãªã‚Šã¾ã™ï¼‰\n`;
    lineText += `\nâ– å„ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¸ã®æ”¯æ‰•é¡\n`;
    drivers.forEach(d => { lineText += `ãƒ»${d.name}ã•ã‚“ï¼š${d.pay.toLocaleString()}å††\n`; });
    lineText += `\nâ– ã‚µãƒ¼ã‚¯ãƒ«ä¼šè¨ˆã‚ˆã‚Šè£œå¡«\nè¨ˆï¼š${circleNeed.toLocaleString()}å††\n`;
    lineText += `ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼`;
    document.getElementById('copyTextarea').value = lineText;

    saveToHistory({
        date: new Date().toLocaleString('ja-JP', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'}),
        totalPeople,
        isOrgFree,
        cars: carDatas,
        perPersonGas
    });
}

// --- ä»¥ä¸‹ã€ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç³» ---

function copyToClipboard() {
    const textarea = document.getElementById('copyTextarea');
    textarea.select();
    document.execCommand('copy');
    const btn = document.querySelector('.btn-copy');
    btn.textContent = "âœ… ã‚³ãƒ”ãƒ¼å®Œäº†ï¼";
    setTimeout(() => { btn.textContent = "ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼"; }, 2000);
}

function saveToHistory(data) {
    let history = JSON.parse(localStorage.getItem('gas_history_v2') || "[]");
    history.unshift(data);
    if(history.length > 5) history.pop();
    localStorage.setItem('gas_history_v2', JSON.stringify(history));
    updateHistory();
}

function updateHistory() {
    const history = JSON.parse(localStorage.getItem('gas_history_v2') || "[]");
    const container = document.getElementById('historyList');
    container.innerHTML = history.length === 0 ? "<p style='font-size:0.85rem; color:#999; text-align:center;'>å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>" : "";
    history.forEach((h, i) => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
            <div>
                <div class="h-date">${h.date}</div>
                <div class="h-summary">${h.totalPeople}å / 1äºº ${h.perPersonGas.toLocaleString()}å††</div>
            </div>
            <div class="history-btns">
                <button class="btn-reset" style="color:var(--history); margin:0;" onclick="restoreHistory(${i})">å¾©å…ƒ</button>
                <button class="btn-reset" style="color:var(--danger); margin:0;" onclick="deleteHistory(${i})">å‰Šé™¤</button>
            </div>
        `;
        container.appendChild(div);
    });
}

function restoreHistory(index) {
    if(!confirm("ç¾åœ¨ã®å…¥åŠ›ã‚’ä¸Šæ›¸ãã—ã¦å±¥æ­´ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")) return;
    const history = JSON.parse(localStorage.getItem('gas_history_v2') || "[]");
    const data = history[index];
    document.getElementById('totalPeople').value = data.totalPeople;
    document.getElementById('organizerFree').checked = data.isOrgFree;
    document.getElementById('carList').innerHTML = "";
    data.cars.forEach(c => addCar(c));
    document.getElementById('resultArea').style.display = 'none';
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function deleteHistory(index) {
    let history = JSON.parse(localStorage.getItem('gas_history_v2') || "[]");
    history.splice(index, 1);
    localStorage.setItem('gas_history_v2', JSON.stringify(history));
    updateHistory();
}

function saveDraft() {
    const cards = document.querySelectorAll('.car-card');
    const carDatas = Array.from(cards).map(card => {
        const exs = Array.from(card.querySelectorAll('.extra-item')).map(row => ({
            name: row.querySelector('.ex-name').value,
            amount: row.querySelector('.ex-amount').value
        }));
        return {
            name: card.querySelector('.inp-name').value,
            dist: card.querySelector('.inp-dist').value,
            eco: card.querySelector('.inp-eco').value,
            price: card.querySelector('.inp-price').value,
            extras: exs
        };
    });
    const draft = {
        total: document.getElementById('totalPeople').value,
        org: document.getElementById('organizerFree').checked,
        cars: carDatas
    };
    localStorage.setItem('gas_draft_v2', JSON.stringify(draft));
}

function loadDraft() {
    const raw = localStorage.getItem('gas_draft_v2');
    if(!raw) { addCar(); return; }
    const d = JSON.parse(raw);
    document.getElementById('totalPeople').value = d.total;
    document.getElementById('organizerFree').checked = d.org;
    if(d.cars && d.cars.length) d.cars.forEach(c => addCar(c)); else addCar();
}

function resetAll() {
    if(confirm("å…¨ã¦ã®å…¥åŠ›ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿï¼ˆå±¥æ­´ã¯æ®‹ã‚Šã¾ã™ï¼‰")) {
        localStorage.removeItem('gas_draft_v2');
        location.reload();
    }
}

document.addEventListener('input', saveDraft);
</script>

</body>
</html>
