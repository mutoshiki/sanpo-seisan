<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>å±±æ­©ä¼šä¼šè¨ˆç²¾ç®—ãƒ„ãƒ¼ãƒ« v6.2</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
:root {
    /* --- ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ: Cafe Theme (Light) --- */
    --primary: #558b2f;       /* ãƒ¡ã‚¤ãƒ³ï¼šæŠ¹èŒ¶ã‚°ãƒªãƒ¼ãƒ³ */
    --primary-hover: #33691e;
    --primary-light: #f1f8e9; /* èƒŒæ™¯ç”¨ï¼šè–„ã„æŠ¹èŒ¶ */
    
    --accent: #f9a825;        /* å¼·èª¿ï¼šãƒã‚¹ã‚¿ãƒ¼ãƒ‰ã‚¤ã‚¨ãƒ­ãƒ¼ */
    --danger: #d32f2f;        /* è­¦å‘Šï¼šè½ã¡ç€ã„ãŸèµ¤ */
    
    --bg: #f2efe9;            /* èƒŒæ™¯ï¼šãƒ©ãƒ†ãƒ™ãƒ¼ã‚¸ãƒ¥ */
    --card-bg: #fdfbf7;       /* ã‚«ãƒ¼ãƒ‰ï¼šã‚¯ãƒªãƒ¼ãƒ ãƒ›ãƒ¯ã‚¤ãƒˆ */
    
    --text-main: #4e342e;     /* æ–‡å­—ï¼šã‚¨ã‚¹ãƒ—ãƒ¬ãƒƒã‚½ */
    --text-sub: #8d6e63;      /* ã‚µãƒ–æ–‡å­—ï¼šã‚³ã‚³ã‚¢ãƒ–ãƒ©ã‚¦ãƒ³ */
    
    --border: #d7ccc8;        /* æ ç·šï¼šãƒŸãƒ«ã‚¯ã‚³ã‚³ã‚¢ */
    --input-bg: #faf8f5;      /* å…¥åŠ›æ¬„èƒŒæ™¯ */
    
    --radius: 12px;
    --shadow: 0 4px 10px rgba(78, 52, 46, 0.08);

    /* ãƒ«ãƒ¼ãƒ å›ºæœ‰ã‚«ãƒ©ãƒ¼ï¼ˆJSã§å‹•çš„ã«ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰ */
    --room-hue: 120; 
    --room-color: hsl(var(--room-hue), 60%, 45%);
    --room-bg: hsl(var(--room-hue), 70%, 95%);
}

@media (prefers-color-scheme: dark) {
    :root {
        /* --- ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ: Cafe Theme (Dark) --- */
        --primary: #aed581;       
        --primary-hover: #7cb342;
        --primary-light: #33691e;
        
        --accent: #ffd54f;
        --danger: #e57373;
        
        --bg: #251d1a;            
        --card-bg: #3e2723;       
        
        --text-main: #d7ccc8;     
        --text-sub: #a1887f;      
        
        --border: #5d4037;
        --input-bg: #4e342e;
        
        --shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        
        --room-color: hsl(var(--room-hue), 70%, 65%);
        --room-bg: hsl(var(--room-hue), 30%, 25%);
    }
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    margin: 0; padding: 20px 12px;
    background: var(--bg); color: var(--text-main);
    line-height: 1.6; font-size: 15px;
}

.container { max-width: 600px; margin: 0 auto; padding-bottom: 100px; }

/* --- æ–°ã—ã„ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
header { margin-bottom: 24px; text-align: center; }

.app-brand {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    background: var(--card-bg);
    padding: 16px 30px;
    border-radius: 20px;
    box-shadow: 
        0 6px 15px rgba(0,0,0,0.05), 
        0 0 0 4px rgba(255,255,255,0.5); /* äºŒé‡ç·šé¢¨ã®å¤–æ  */
    border: 1px solid var(--border);
    position: relative;
    margin-top: 10px;
}

.app-logo-area {
    display: flex; align-items: center; gap: 10px;
    margin-bottom: 4px;
}
.app-icon {
    font-size: 1.8rem;
    color: var(--primary);
    background: var(--primary-light);
    width: 44px; height: 44px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 50%;
}
.app-title {
    font-size: 1.3rem; font-weight: 800; color: var(--text-main); letter-spacing: 0.05em;
    margin: 0;
}
.app-version {
    font-size: 0.7rem; color: var(--card-bg); background: var(--text-sub);
    padding: 2px 8px; border-radius: 10px; font-weight: bold;
    position: absolute; top: -8px; right: -8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.sync-status {
    font-size: 0.75rem; color: var(--primary); font-weight: 600;
    display: flex; align-items: center; justify-content: center; gap: 6px;
    margin-top: 12px;
}
.sync-dot { width: 8px; height: 8px; background: currentColor; border-radius: 50%; display: inline-block; animation: pulse 2s infinite; }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

/* --- æ–°ã—ã„ã‚·ã‚§ã‚¢ãƒ»ãƒ«ãƒ¼ãƒ IDã‚¨ãƒªã‚¢ --- */
.room-invite-card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 0; /* paddingãªã—ã§ä¸­èº«ã‚’è©°ã‚ã‚‹ */
    margin-bottom: 24px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    overflow: hidden;
    position: relative;
}
/* å·¦å´ã«è‰²ä»˜ããƒãƒ¼ã‚’è¡¨ç¤º */
.room-invite-card::before {
    content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px;
    background: var(--room-color);
}

.room-id-section {
    background: var(--room-bg); /* ãƒ«ãƒ¼ãƒ å›ºæœ‰ã®æ·¡ã„èƒŒæ™¯è‰² */
    padding: 16px;
    display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px dashed var(--border);
}
.room-id-label {
    display: flex; align-items: center; gap: 10px;
}
.room-avatar {
    width: 36px; height: 36px; 
    background: var(--room-color); color: #fff;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-weight: bold; font-size: 1.1rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.room-code-group {
    display: flex; flex-direction: column;
}
.room-label-tiny { font-size: 0.7rem; color: var(--text-sub); font-weight: bold; }
.room-id-text { 
    font-family: "OCR-B", monospace; font-size: 1.2rem; font-weight: 700; 
    color: var(--text-main); letter-spacing: 1px; 
}

.share-actions {
    padding: 12px;
    display: flex; gap: 10px;
}
.btn-share-sub {
    flex: 1;
    background: transparent; border: 1px solid var(--border);
    color: var(--text-sub); padding: 8px; border-radius: 8px;
    font-size: 0.85rem; font-weight: 600; cursor: pointer;
    display: flex; align-items: center; justify-content: center; gap: 6px;
    transition: 0.2s;
}
.btn-share-sub:hover { background: var(--bg); color: var(--primary); border-color: var(--primary); }


/* --- å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ --- */
.card {
    background: var(--card-bg); padding: 20px; border-radius: var(--radius);
    box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid var(--border);
}

h2 { 
    font-size: 1.1rem; margin: 0 0 16px 0; 
    display: flex; align-items: center; gap: 8px; 
    color: var(--text-main); border-bottom: 2px solid var(--border); padding-bottom: 10px;
}
h2 i { color: var(--primary); font-size: 1.3rem; }

/* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
.input-group { margin-bottom: 16px; }
label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: var(--text-sub); }

input[type="number"], input[type="text"], select {
    width: 100%; padding: 12px; 
    border: 1px solid var(--border); border-radius: 8px; 
    font-size: 16px; background: var(--input-bg); color: var(--text-main);
    transition: 0.2s;
}
input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(85, 139, 47, 0.2); }
input::placeholder { color: var(--text-sub); opacity: 0.5; }

.flex-row { display: flex; gap: 12px; }
.flex-row > div { flex: 1; }

/* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ */
.checkbox-card {
    display: flex; align-items: center; justify-content: space-between;
    background: var(--input-bg); padding: 12px 16px; border-radius: 8px; 
    cursor: pointer; user-select: none; border: 1px solid var(--border);
}
.checkbox-card input { display: none; }
.toggle-switch {
    width: 44px; height: 24px; background: var(--border); border-radius: 20px; position: relative; transition: 0.3s;
}
.toggle-switch::after {
    content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px;
    background: var(--card-bg); border-radius: 50%; transition: 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.2);
}
.checkbox-card input:checked + .toggle-switch { background: var(--primary); }
.checkbox-card input:checked + .toggle-switch::after { transform: translateX(20px); }

/* è»Šä¸¡ã‚«ãƒ¼ãƒ‰ */
.car-card {
    border: 1px solid var(--border); border-radius: 10px; margin-bottom: 12px;
    background: var(--card-bg); overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.03);
}
.car-header {
    background: var(--primary-light); padding: 12px 16px;
    display: flex; justify-content: space-between; align-items: center;
    cursor: pointer; font-weight: 600; font-size: 1rem; color: var(--text-main);
}
.car-header i { margin-right: 6px; color: var(--primary); }
.car-body { padding: 16px; display: none; border-top: 1px solid var(--border); background: var(--card-bg); }
.car-card.open .car-body { display: block; }
.toggle-icon { transition: transform 0.3s; font-size: 1.1rem; color: var(--text-sub); }
.car-card.open .toggle-icon { transform: rotate(180deg); }

.btn-icon-only {
    background: none; border: none; color: var(--text-sub); font-size: 1.1rem; 
    cursor: pointer; padding: 6px; display: flex; align-items: center; transition: color 0.2s;
    flex-shrink: 0;
}
.btn-icon-only:hover { color: var(--danger); }

/* è«¸çµŒè²»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.extra-section { 
    background: var(--input-bg); padding: 12px; border-radius: 8px; margin-top: 16px; 
    border: 1px dashed var(--border); 
}
.extra-item { 
    display: flex; 
    gap: 6px; /* ã‚®ãƒ£ãƒƒãƒ—ã‚’å°‘ã—ç‹­ã‚ã‚‹ */
    margin-bottom: 10px; 
    align-items: center; 
    flex-wrap: nowrap; /* æ”¹è¡Œã‚’ç¦æ­¢ã™ã‚‹ */
    border-bottom:1px dashed rgba(0,0,0,0.05); 
    padding-bottom:8px; 
}
.extra-item:last-child { border-bottom: none; }
.extra-item .ex-name { 
    flex: 2; 
    min-width: 0; /* ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ã‚¢ã‚¤ãƒ†ãƒ ãŒç¸®å°ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ */
}
.extra-item .ex-amount { 
    flex: 1.5; 
    min-width: 0; /* ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ã‚¢ã‚¤ãƒ†ãƒ ãŒç¸®å°ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ */
}

/* éƒ¨è²»/å‰²å‹˜ é¸æŠãƒœã‚¿ãƒ³ */
.type-selector {
    display: flex;
    background: #e0e0e0;
    border-radius: 8px;
    padding: 3px;
    width: 90px; /* å¹…ã‚’ã‚¹ãƒªãƒ åŒ– (å…ƒ130px) */
    flex-shrink: 0; /* ã“ã‚Œä»¥ä¸Šç¸®ã‚ãªã„ */
}
.type-selector input { display: none; }
.type-selector label {
    flex: 1;
    text-align: center;
    padding: 6px 0; /* ä¸Šä¸‹ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ */
    font-size: 0.75rem; /* ãƒ•ã‚©ãƒ³ãƒˆã‚’å°‘ã—å°ã•ã */
    cursor: pointer;
    border-radius: 6px;
    color: var(--text-sub);
    transition: 0.2s;
    font-weight: 600;
    margin: 0;
    white-space: nowrap;
}
.type-selector input:checked + label {
    background: #fff;
    color: var(--primary);
    box-shadow: 0 1px 3px rgba(0,0,0,0.15);
}
@media (prefers-color-scheme: dark) {
    .type-selector { background: #333; }
    .type-selector input:checked + label { background: #555; color: #fff; }
}


/* ãƒœã‚¿ãƒ³é¡ */
.btn {
    width: 100%; border: none; border-radius: 50px; font-size: 1rem; font-weight: 700;
    padding: 14px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
    text-decoration: none;
}
.btn-primary { 
    background: var(--primary); color: #fff; margin-top: 10px; 
    box-shadow: 0 4px 10px rgba(85, 139, 47, 0.3);
}
.btn-primary:hover { background: var(--primary-hover); }
.btn-primary:active { transform: scale(0.98); }

.btn-outline { 
    background: transparent; border: 2px dashed var(--border); color: var(--text-main); 
    padding: 12px; font-weight: 600;
}
.btn-outline:hover { background: var(--primary-light); border-color: var(--primary); color: var(--primary); }
.btn-sm { padding: 6px 12px; font-size: 0.85rem; width: auto; display: inline-flex; border-radius: 6px; }

/* --- ãƒ¬ã‚·ãƒ¼ãƒˆé¢¨ãƒ‡ã‚¶ã‚¤ãƒ³ (Receipt Style) --- */
#resultArea { display: none; }

.receipt-wrapper {
    padding: 20px; 
    margin: 20px -20px; 
}

.receipt-paper {
    background: #fff;
    color: #2c2c2c;
    font-family: 'Courier New', Courier, "OCR-B", monospace;
    padding: 30px 25px;
    position: relative;
    box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    max-width: 380px;
    margin: 0 auto;
    
    margin-top: 10px;
    margin-bottom: 10px;
}

.receipt-paper::before, .receipt-paper::after {
    content: "";
    position: absolute;
    left: 0;
    width: 100%;
    height: 10px;
    background-size: 20px 20px;
    background-repeat: repeat-x;
}

.receipt-paper::before {
    top: -10px;
    background-image: linear-gradient(135deg, transparent 50%, #fff 50%), linear-gradient(-135deg, transparent 50%, #fff 50%);
    background-position: top left, top left;
}

.receipt-paper::after {
    bottom: -10px;
    background-image: linear-gradient(-45deg, transparent 50%, #fff 50%), linear-gradient(45deg, transparent 50%, #fff 50%);
    background-position: bottom left, bottom left;
}

.receipt-header {
    text-align: center;
    border-bottom: 2px dashed #444;
    padding-bottom: 15px;
    margin-bottom: 15px;
}
.receipt-logo { font-size: 2.5rem; color: #333; margin-bottom: 5px; }
.receipt-title { font-size: 1.1rem; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; margin: 0; }
.receipt-meta { font-size: 0.7rem; color: #666; margin-top: 5px; }

.receipt-total-section {
    text-align: center;
    padding: 15px 0;
    border-bottom: 2px dashed #444;
}
.receipt-label-main { font-size: 0.8rem; font-weight: bold; display: block; margin-bottom: 5px; }
.receipt-amount-main { font-size: 2.4rem; font-weight: 900; line-height: 1; display: block; }
.receipt-note { font-size: 0.7rem; color: #666; margin-top: 5px; display: block;}

.receipt-section {
    padding: 15px 0;
    border-bottom: 1px dashed #bbb;
}
.receipt-section-title {
    font-size: 0.8rem; font-weight: bold; margin-bottom: 8px; display: block; text-align: left;
    text-transform: uppercase; letter-spacing: 1px;
}

.receipt-row {
    display: flex; justify-content: space-between; align-items: baseline;
    font-size: 0.9rem; margin-bottom: 6px;
    line-height: 1.4;
}
.receipt-row.bold { font-weight: 800; font-size: 0.95rem; }
.receipt-row span:last-child { white-space: nowrap; margin-left: 10px; }
.receipt-detail { font-size: 0.7rem; color: #666; margin-left: 10px; margin-bottom: 8px; display: block; line-height: 1.3;}

.receipt-footer {
    text-align: center; margin-top: 20px; font-size: 0.7rem; opacity: 0.7;
    font-weight: bold;
}

/* ã‚³ãƒ”ãƒ¼ã‚¨ãƒªã‚¢ */
.copy-area {
    background: var(--text-main); color: var(--card-bg); padding: 15px; border-radius: 8px; margin-top: 20px;
}
#copyTextarea { width: 100%; background: transparent; border: none; color: inherit; font-family: monospace; height: 120px; resize: none; font-size: 0.8rem; outline: none; opacity: 0.9; }
.btn-copy { background: rgba(255,255,255,0.1); color: inherit; padding: 10px; width: 100%; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; margin-top: 10px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: background 0.2s; }
.btn-copy:hover { background: rgba(255,255,255,0.2); }

/* å±¥æ­´ãƒªã‚¹ãƒˆ */
.history-container { margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px; }
.history-item { 
    background: var(--card-bg); padding: 12px 14px; border-radius: 8px; margin-bottom: 8px;
    display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border);
}
.history-meta { font-size: 0.75rem; color: var(--text-sub); }
.btn-restore { background: var(--primary); color: #fff; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; }

/* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
#toast {
    visibility: hidden; min-width: 250px; background-color: var(--text-main); color: var(--card-bg); text-align: center;
    border-radius: 50px; padding: 14px; position: fixed; z-index: 100; left: 50%; bottom: 30px;
    transform: translateX(-50%); font-size: 0.9rem; opacity: 0; transition: opacity 0.3s, bottom 0.3s;
    display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
#toast.show { visibility: visible; opacity: 1; bottom: 50px; }

</style>
</head>
<body>

<div class="container">
    
    <header>
        <div class="app-brand">
            <span class="app-version">v6.2</span>
            <div class="app-logo-area">
                <div class="app-icon"><i class='fa-solid fa-mountain'></i></div>
                <h1 class="app-title">å±±æ­©ä¼š ç²¾ç®—ãƒ„ãƒ¼ãƒ«</h1>
            </div>
        </div>
        
        <div class="sync-status">
            <span class="sync-dot"></span>
            <span id="syncText">åŒæœŸä¸­...</span>
        </div>
    </header>

    <div class="room-invite-card">
        <div class="room-id-section">
            <div class="room-id-label">
                <div class="room-avatar" id="roomAvatarIcon">
                    <i class='fa-solid fa-hashtag'></i>
                </div>
                <div class="room-code-group">
                    <span class="room-label-tiny">Room ID</span>
                    <span id="dispRoomId" class="room-id-text">...</span>
                </div>
            </div>
            <button class="btn btn-outline btn-sm" style="border:1px solid var(--border); background:#fff; color:var(--text-sub);" onclick="copyRoomLink()">
                <i class='fa-regular fa-copy'></i>
            </button>
        </div>
        <div class="share-actions">
            <button class="btn-share-sub" onclick="shareToLine()">
                <i class='fa-brands fa-line' style="color:#06c755; font-size:1.2rem;"></i> LINEã§é€ã‚‹
            </button>
            <button class="btn-share-sub" onclick="copyRoomLink()">
                <i class='fa-solid fa-link'></i> URLã‚³ãƒ”ãƒ¼
            </button>
        </div>
    </div>

    <div class="card">
        <h2><i class='fa-solid fa-car'></i> è»Šä¸¡æƒ…å ±ã®ç™»éŒ²</h2>
        <div id="carList"></div>
        <button class="btn btn-outline" onclick="handleAddCarBtn()">
            <i class='fa-solid fa-plus'></i> è»Šä¸¡ã‚’è¿½åŠ 
        </button>
    </div>

    <div class="card">
        <h2><i class='fa-solid fa-gear'></i> ç²¾ç®—ã®è¨­å®š</h2>
        
        <div class="input-group">
            <label>ç«¯æ•°å‡¦ç†ï¼ˆåˆ‡ã‚Šä¸Šã’å˜ä½ï¼‰</label>
            <select id="roundingUnit" onchange="pushData()">
                <option value="100" selected>100å†† (æ¨å¥¨)</option>
                <option value="50">50å††</option>
                <option value="10">10å††</option>
                <option value="1">1å††</option>
            </select>
        </div>

        <div class="input-group">
            <label>ä¼ç”»ã®å‚åŠ äººæ•° (ä¼ç”»è€…å«ã‚€)</label>
            <div style="position: relative;">
                <input type="number" id="totalPeople" placeholder="ä¾‹: 4" inputmode="numeric" oninput="pushData()" style="padding-left: 40px;">
                <i class='fa-solid fa-users' style="position: absolute; left: 12px; top: 13px; color: var(--text-sub);"></i>
            </div>
        </div>
        
        <label class="checkbox-card">
            <span>ä¼ç”»è€…ã¯ã‚¬ã‚½ãƒªãƒ³ä»£ã‚’æ”¯æ‰•ã‚ãªã„</span>
            <input type="checkbox" id="organizerFree" onchange="pushData()">
            <div class="toggle-switch"></div>
        </label>
    </div>

    <button class="btn btn-primary" onclick="calculate()">
        <i class='fa-solid fa-calculator'></i> ç²¾ç®—ã‚’å®Ÿè¡Œã™ã‚‹
    </button>

   <div id="resultArea">
        <div id="captureTarget" class="receipt-wrapper">
            <div class="receipt-paper">
                <div class="receipt-header">
                    <div class="receipt-logo"><i class='fa-solid fa-mountain-sun'></i></div>
                    <h3 class="receipt-title">ã‚¬ã‚½ãƒªãƒ³ä»£ç²¾ç®—æ›¸</h3>
                    <div class="receipt-meta" id="receiptDate">2024.01.01 12:00</div>
                </div>

                <div class="receipt-total-section">
                    <span class="receipt-label-main">1äººã‚ãŸã‚Šã®å¾´åé¡</span>
                    <span class="receipt-amount-main" id="resPerPerson">0</span>
                    <span class="receipt-note" id="resTargetDetail">--</span>
                </div>

                <div class="receipt-section">
                    <span class="receipt-section-title">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¸ã®æ”¯æ‰•ã„</span>
                    <div id="resDriverList"></div>
                </div>

                <div class="receipt-section">
                    <span class="receipt-section-title">ã‚µãƒ¼ã‚¯ãƒ«ä¼šè¨ˆæƒ…å ±</span>
                    <div class="receipt-row">
                        <span>éƒ¨è²»è² æ‹…åˆ†ã®çµŒè²»åˆè¨ˆ</span>
                        <span id="resCircleExpense">0</span>
                    </div>
                    <div class="receipt-row">
                        <span>ç«¯æ•°èª¿æ•´ã®ä½™ã‚Š (ã‚µãƒ¼ã‚¯ãƒ«è²»ã¸)</span>
                        <span id="resGasSurplus">0</span>
                    </div>
                    <div class="receipt-row bold">
                        <span>ä¼šè¨ˆã‹ã‚‰ã®å®Ÿæ”¯å‡º</span>
                        <span id="resWithdraw">0</span>
                    </div>
                </div>

                <div class="receipt-footer">
                    ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼<br>
                    å±±æ­©ä¼š
                </div>
            </div>
        </div>

        <div class="copy-area">
            <h3 style="margin:0 0 10px 0; font-size:1rem; display:flex; align-items:center; gap:8px;">
                <i class='fa-solid fa-share-nodes'></i> çµæœã®å…±æœ‰
            </h3>
            <textarea id="copyTextarea" readonly></textarea>
            <div style="display: flex; gap: 10px;">
                <button class="btn-copy" onclick="copyToClipboard()">
                    <i class='fa-solid fa-copy'></i> ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼
                </button>
                <button class="btn" style="background: var(--text-main); color: var(--primary-light); font-size:0.9rem; border: none; border-radius: 6px; width: 100%; margin-top:10px;" onclick="downloadResultImage()">
                    <i class='fa-solid fa-download'></i> ç”»åƒã‚’ä¿å­˜
                </button>
            </div>
        </div>
    </div>

    <div class="history-container">
        <details>
            <summary style="cursor: pointer; color: var(--text-sub); font-weight: bold; outline:none;">
                <i class='fa-solid fa-clock-rotate-left'></i> è¨ˆç®—å±¥æ­´ (ä¿å­˜æ¸ˆã¿)
            </summary>
            <div style="margin-top: 15px;">
                <ul id="historyList" style="list-style: none; padding: 0;">
                    <li style="text-align:center; color:var(--text-sub); padding:10px; font-size:0.85rem;">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</li>
                </ul>
                <button class="btn btn-outline btn-sm" style="width:100%; margin-top:10px; font-weight:normal;" onclick="resetRoom()">
                    <i class='fa-solid fa-trash'></i> å…¥åŠ›ã‚’å…¨ã¦ã‚¯ãƒªã‚¢
                </button>
            </div>
        </details>
    </div>
    <div style="margin-top: 40px; text-align: center; border-top: 1px dashed var(--border); padding-top: 20px;">
        <button class="btn btn-sm" style="background: var(--text-sub); color: var(--card-bg); width: auto; margin: 0 auto;" onclick="fillTestData()">
            <i class='fa-solid fa-flask'></i> ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥
        </button>
        <p style="font-size: 0.7rem; color: var(--text-sub); margin-top: 8px;">
            â€»æ—¢å­˜ã®å…¥åŠ›ã¯å…¨ã¦ä¸Šæ›¸ãã•ã‚Œã¾ã™
        </p>
    </div>

</div>

<div id="toast"><i class='fa-solid fa-circle-check'></i> <span>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</span></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// --- Global Assignments ---
window.pushData = debounce(pushDataToFirebase, 500);
window.handleAddCarBtn = handleAddCarBtn;
window.resetRoom = resetRoom;
window.loadFromHistory = loadFromHistory;
window.deleteHistory = deleteHistory;
window.fillTestData = fillTestData;
window.downloadResultImage = downloadResultImage;
window.addCarToDOM = addCarToDOM;
window.removeCar = removeCar;
window.handleAddExtra = handleAddExtra;
window.calculate = calculate;
window.copyRoomLink = copyRoomLink;
window.shareToLine = shareToLine;
window.copyToClipboard = copyToClipboard;

const firebaseConfig = {
  apiKey: "AIzaSyAypqRPRn-YHWLwjT3lQ6pN6_bWBqzUvp4",
  authDomain: "sanpo-seisan.firebaseapp.com",
  databaseURL: "https://sanpo-seisan-default-rtdb.firebaseio.com",
  projectId: "sanpo-seisan",
  storageBucket: "sanpo-seisan.firebasestorage.app",
  messagingSenderId: "709215338656",
  appId: "1:709215338656:web:c2b0dbc9aceb0fa60f89c5"
};

let app, db, roomRef, roomId;

try {
    app = initializeApp(firebaseConfig);
    db = getDatabase(app);

    // URLã‹ã‚‰ãƒ«ãƒ¼ãƒ IDå–å¾—
    roomId = new URLSearchParams(window.location.search).get("room");
    if (!roomId) {
        roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
        const newUrl = window.location.pathname + "?room=" + roomId;
        window.history.replaceState(null, null, newUrl);
    }
    const dispEl = document.getElementById('dispRoomId');
    if(dispEl) dispEl.textContent = roomId;

    // --- ã“ã“ã§IDã«åŸºã¥ã„ã¦è‰²ã‚’ç”Ÿæˆ ---
    updateRoomColor(roomId);

    roomRef = ref(db, 'sessions/' + roomId);

    // Start sync and history load
    renderHistoryList();
    onValue(roomRef, (snapshot) => {
        const data = snapshot.val();
        const syncText = document.getElementById("syncText");
        
        if (data) {
            if(syncText) syncText.textContent = "åŒæœŸå®Œäº†";
            renderForm(data);
        } else {
            if(syncText) syncText.textContent = "æ–°è¦ãƒ«ãƒ¼ãƒ ";
            const list = document.getElementById('carList');
            if(list && list.children.length === 0) {
                addCarToDOM(null, 0, true);
            }
        }
    });

} catch (e) {
    console.error("Initialization Error:", e);
    showToast("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
}

// --- IDã‹ã‚‰è‰²ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•° ---
function updateRoomColor(id) {
    // æ–‡å­—åˆ—ã‹ã‚‰æ•°å€¤ã‚’ç”Ÿæˆï¼ˆãƒãƒƒã‚·ãƒ¥åŒ–ï¼‰
    let hash = 0;
    for (let i = 0; i < id.length; i++) {
        hash = id.charCodeAt(i) + ((hash << 5) - hash);
    }
    // 0ã€œ360ã®è‰²ç›¸(Hue)ã«å¤‰æ›
    const hue = Math.abs(hash % 360);
    
    // CSSå¤‰æ•°ã‚’æ›´æ–°
    document.documentElement.style.setProperty('--room-hue', hue);
}


function downloadResultImage() {
    const target = document.getElementById('captureTarget');
    showToast("ç”»åƒã‚’ç”Ÿæˆä¸­...");

    if (typeof html2canvas === 'undefined') {
        alert("ç”»åƒç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        return;
    }

    const options = {
        scale: 2,
        backgroundColor: null,
        logging: false,
        useCORS: true
    };

    html2canvas(target, options).then(canvas => {
        // Blobã«å¤‰æ›
        canvas.toBlob(async (blob) => {
            if (!blob) {
                showToast("ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
                return;
            }

            const fileName = `receipt_${roomId}_${Date.now()}.png`;

            // Web Share API (File Sharing) ãŒä½¿ãˆã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆä¸»ã«iOS/Androidç”¨ï¼‰
            // filesé…åˆ—ã‚’å«ã‚ã¦canShareã§ç¢ºèªã™ã‚‹ã®ãŒç¢ºå®Ÿ
            const file = new File([blob], fileName, { type: "image/png" });
            const shareData = {
                files: [file],
                title: 'ç²¾ç®—çµæœ',
                text: 'ç²¾ç®—çµæœã®ç”»åƒã§ã™'
            };

            if (navigator.canShare && navigator.canShare(shareData)) {
                try {
                    await navigator.share(shareData);
                    // å…±æœ‰ï¼ˆä¿å­˜ï¼‰ãŒå®Œäº†ã€ã¾ãŸã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸ
                } catch (err) {
                    console.error("Share failed", err);
                    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãªã©ã®å ´åˆã‚‚ã“ã“ã«æ¥ã‚‹ãŒã€ç‰¹ã«å¯¾å‡¦ä¸è¦
                }
            } else {
                // PCã‚„éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã®å ´åˆã¯å¾“æ¥ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const link = document.createElement('a');
                link.download = fileName;
                link.href = canvas.toDataURL('image/png');
                link.click();
                showToast("âœ… ç”»åƒã‚’ä¿å­˜ã—ã¾ã—ãŸ");
            }
        }, 'image/png');
    }).catch(err => {
        console.error(err);
        showToast("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
    });
}

function renderForm(data) {
    setValIfDiff('totalPeople', data.total);
    setCheckIfDiff('organizerFree', data.org);
    setValIfDiff('roundingUnit', data.rounding);

    const carList = document.getElementById('carList');
    const remoteCars = data.cars || [];
    const currentCards = carList.getElementsByClassName('car-card');
    
    while(currentCards.length < remoteCars.length) {
        addCarToDOM(null, currentCards.length, true);
    }
    while(currentCards.length > remoteCars.length) {
        carList.removeChild(carList.lastChild);
    }

    Array.from(currentCards).forEach((card, i) => {
        const cData = remoteCars[i];
        
        const inputs = {
            name: card.querySelector('.inp-name'),
            dist: card.querySelector('.inp-dist'),
            eco: card.querySelector('.inp-eco'),
            price: card.querySelector('.inp-price')
        };
        
        if(document.activeElement !== inputs.name) inputs.name.value = cData.name || "";
        if(document.activeElement !== inputs.dist) inputs.dist.value = cData.dist || "";
        if(document.activeElement !== inputs.eco) inputs.eco.value = cData.eco || "";
        if(document.activeElement !== inputs.price) inputs.price.value = cData.price || "";
        
        const title = card.querySelector('.car-title-text');
        const dName = cData.name || `è»Šä¸¡ ${i + 1}`;
        title.innerHTML = `<i class='fa-solid fa-car'></i> ${dName}`;

        const extrasBox = card.querySelector('.extra-section div[id^="extras-"]');
        if(!extrasBox) return;

        const remoteExtras = cData.extras || [];
        const currentExtras = extrasBox.getElementsByClassName('extra-item');

        while(currentExtras.length < remoteExtras.length) {
            addExtraToDOM(extrasBox, "", "", "club");
        }
        while(currentExtras.length > remoteExtras.length) {
            extrasBox.removeChild(extrasBox.lastChild);
        }

        Array.from(currentExtras).forEach((row, j) => {
            const exData = remoteExtras[j];
            const nameInp = row.querySelector('.ex-name');
            const amtInp = row.querySelector('.ex-amount');
            
            if(document.activeElement !== nameInp) nameInp.value = exData.name || "";
            if(document.activeElement !== amtInp) amtInp.value = exData.amount || "";
            
            // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å€¤ã‚’åæ˜ 
            const typeVal = exData.type || "club";
            const radio = row.querySelector(`input[type="radio"][value="${typeVal}"]`);
            if(radio && !radio.checked) {
                radio.checked = true;
            }
        });
    });
}

function setValIfDiff(id, val) {
    const el = document.getElementById(id);
    if (el && document.activeElement !== el && el.value != val) {
        el.value = val || "";
    }
}
function setCheckIfDiff(id, val) {
    const el = document.getElementById(id);
    if (el && el.checked != val) {
        el.checked = val || false;
    }
}

function pushDataToFirebase() {
    if(!roomRef) return; 
    const data = getFormData();
    const syncText = document.getElementById("syncText");
    if(syncText) syncText.textContent = "ä¿å­˜ä¸­...";
    set(roomRef, data).then(() => {
        if(syncText) syncText.textContent = "åŒæœŸå®Œäº†";
    }).catch((e) => {
        if(syncText) syncText.textContent = "ã‚¨ãƒ©ãƒ¼";
        console.error(e);
    });
}

function debounce(func, wait) {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
    };
}

function getFormData() {
    const cards = document.querySelectorAll('.car-card');
    const carDatas = Array.from(cards).map(card => ({
        name: card.querySelector('.inp-name').value, 
        dist: card.querySelector('.inp-dist').value,
        eco: card.querySelector('.inp-eco').value, 
        price: card.querySelector('.inp-price').value,
        extras: Array.from(card.querySelectorAll('.extra-item')).map(row => {
            // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‹ã‚‰å€¤ã‚’å–å¾—
            const checkedRadio = row.querySelector('input[type="radio"]:checked');
            return { 
                name: row.querySelector('.ex-name').value, 
                amount: row.querySelector('.ex-amount').value,
                type: checkedRadio ? checkedRadio.value : "club"
            };
        })
    }));
    return {
        total: document.getElementById('totalPeople').value,
        org: document.getElementById('organizerFree').checked,
        rounding: document.getElementById('roundingUnit').value,
        cars: carDatas,
        updatedAt: Date.now()
    };
}

function resetRoom() {
    if(!roomRef) return;
    if(confirm("å…¨ã¦ã®å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ç”»é¢ã‹ã‚‰ã‚‚æ¶ˆãˆã¾ã™ï¼‰")) {
        set(roomRef, null).then(() => {
            window.location.reload();
        });
    }
}

function fillTestData() {
    if(!confirm("ç¾åœ¨ã®å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¾ã™ã‹ï¼Ÿ")) return;

    document.getElementById('carList').innerHTML = "";

    const totalPeople = 11;
    document.getElementById('totalPeople').value = totalPeople;
    document.getElementById('roundingUnit').value = "100";
    document.getElementById('organizerFree').checked = true;

    const testData = [
        { 
            name: "ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼A", dist: [200, 240], eco: [12, 16], price: [165, 175], 
            extras: [
                ["é«˜é€Ÿä»£", 4500, "split"],
                ["ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼ä»£", 8000, "club"],
                ["é§è»Šå ´", 1200, "split"]
            ] 
        },
        { 
            name: "éˆ´æœ¨ä¸€éƒ", dist: [180, 220], eco: [20, 25], price: [160, 170], 
            extras: [
                ["ã‚¢ã‚¤ã‚¹ä»£", 800, "club"],
                ["ã‚¯ãƒ¼ãƒãƒ³å‰²å¼•", -500, "club"] 
            ] 
        },
        { 
            name: "ä½è—¤èŠ±å­", dist: [190, 230], eco: [15, 19], price: [168, 178], 
            extras: [
                ["æœ‰æ–™é“è·¯", 1200, "split"],
                ["æ¸©æ³‰ä»£ç«‹æ›¿", 5000, "club"]
            ] 
        }
    ];

    const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

    testData.forEach((d, i) => {
        addCarToDOM(null, -1, true);
        const card = document.getElementById('carList').lastElementChild;
        
        card.querySelector('.inp-name').value = d.name;
        card.querySelector('.inp-dist').value = rand(d.dist[0], d.dist[1]);
        card.querySelector('.inp-eco').value  = rand(d.eco[0], d.eco[1]);
        card.querySelector('.inp-price').value = rand(d.price[0], d.price[1]);

        const extraBox = card.querySelector('.extra-section > div');
        d.extras.forEach(ex => {
            addExtraToDOM(extraBox, ex[0], ex[1], ex[2]);
        });
    });

    pushDataToFirebase();
    showToast("ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿(æ··åœ¨)ã‚’æŠ•å…¥ã—ã¾ã—ãŸ");
    document.getElementById('resultArea').style.display = 'none';
}

function saveToHistory() {
    const data = getFormData();
    if(!data.total && data.cars.length === 1 && !data.cars[0].dist) return;
    
    try {
        const history = JSON.parse(localStorage.getItem('sanpo_history_v5') || "[]");
        
        if(history.length > 0) {
            const last = history[0].data;
            if(JSON.stringify(last) === JSON.stringify(data)) return; 
        }

        const summary = `${data.total || "?"}å / è»Š${data.cars.length}å°`;
        history.unshift({ 
            date: new Date().toLocaleString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' }), 
            summary: summary,
            data: data 
        });
        
        localStorage.setItem('sanpo_history_v5', JSON.stringify(history.slice(0, 10)));
        renderHistoryList();
    } catch(e) {
        console.error("History Save Error:", e);
    }
}

function renderHistoryList() {
    const list = document.getElementById('historyList');
    if(!list) return;

    let history = [];
    try {
        history = JSON.parse(localStorage.getItem('sanpo_history_v5') || "[]");
    } catch(e) {
        console.error("History Load Error", e);
    }
    
    if (history.length === 0) {
        list.innerHTML = `<li style="text-align:center; color:var(--text-sub); padding:10px; font-size:0.8rem;">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</li>`;
        return;
    }

    list.innerHTML = "";
    history.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = 'history-item';
        li.innerHTML = `
            <div>
                <span class="history-meta">${item.date}</span>
                <div style="font-weight:600; font-size:0.9rem;">${item.summary}</div>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn-restore" onclick="loadFromHistory(${index})">å¾©å…ƒ</button>
                <button class="btn-icon-only" style="color:var(--text-sub); font-size:1rem;" onclick="deleteHistory(${index})"><i class='fa-solid fa-xmark'></i></button>
            </div>
        `;
        list.appendChild(li);
    });
}

function loadFromHistory(index) {
    if(!roomRef) return;
    if(!confirm("ç¾åœ¨ã®å…¥åŠ›ã‚’ä¸Šæ›¸ãã—ã¦å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")) return;
    try {
        const history = JSON.parse(localStorage.getItem('sanpo_history_v5') || "[]");
        const item = history[index];
        if(item && item.data) {
            set(roomRef, item.data).then(() => {
                showToast("ğŸ“‚ å±¥æ­´ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸ");
            });
        }
    } catch(e) { console.error(e); }
}

function deleteHistory(index) {
    if(!confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    try {
        const history = JSON.parse(localStorage.getItem('sanpo_history_v5') || "[]");
        history.splice(index, 1);
        localStorage.setItem('sanpo_history_v5', JSON.stringify(history));
        renderHistoryList();
    } catch(e) { console.error(e); }
}

function handleAddCarBtn() {
    addCarToDOM();
    pushDataToFirebase();
}

function addCarToDOM(data = null, idx = -1, forceOpen = false) {
    const list = document.getElementById('carList');
    if(!list) return;
    if (idx === -1) idx = list.children.length;
    
    if(list.children[idx]) return;

    const div = document.createElement('div');
    const isOpen = forceOpen ? 'open' : 'open';
    div.className = `car-card ${isOpen}`;
    const onInput = `oninput="window.pushData()"`;
    const extrasId = `extras-${Date.now()}-${Math.random().toString(36).substr(2,5)}`;

    div.innerHTML = `
        <div class="car-header" onclick="this.parentElement.classList.toggle('open')">
            <span class="car-title-text"><i class='fa-solid fa-car'></i> è»Šä¸¡ ${idx + 1}</span>
            <div style="display:flex; align-items:center; gap:8px;">
                <button class="btn-icon-only" onclick="removeCar(event, this)" title="å‰Šé™¤"><i class='fa-solid fa-trash'></i></button>
                <i class='fa-solid fa-chevron-down toggle-icon'></i>
            </div>
        </div>
        <div class="car-body">
            <div class="input-group">
                <label>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼åï¼ˆä»»æ„ï¼‰</label>
                <div style="position:relative;">
                    <i class='fa-solid fa-user' style="position:absolute; left:12px; top:13px; color:var(--text-sub);"></i>
                    <input type="text" class="inp-name" placeholder="æ°å" ${onInput} style="padding-left:36px;">
                </div>
            </div>
            <div class="flex-row">
                <div class="input-group"><label>è·é›¢ (km)<span style="color:var(--danger)">*</span></label><input type="number" class="inp-dist" placeholder="ä¾‹: 240" inputmode="decimal" ${onInput}></div>
                <div class="input-group"><label>ç‡ƒè²» (km/L)<span style="color:var(--danger)">*</span></label><input type="number" class="inp-eco" placeholder="ä¾‹: 15" inputmode="decimal" ${onInput}></div>
                <div class="input-group"><label>ä¾¡æ ¼ (å††)<span style="color:var(--danger)">*</span></label><input type="number" class="inp-price" placeholder="ä¾‹: 160" inputmode="numeric" ${onInput}></div>
            </div>
            <div class="extra-section">
                <label style="margin-bottom:8px; display:block; font-size:0.8rem; color:var(--text-sub);">â• è«¸çµŒè²»ï¼ˆé«˜é€Ÿãƒ»é§è»Šå ´ãƒ»å‰²å¼•ãªã©ï¼‰</label>
                <div id="${extrasId}"></div>
                <button class="btn-reset" style="background:none; border:none; color:var(--primary); font-size:0.8rem; cursor:pointer; padding:0; margin-top:5px; font-weight:bold;" onclick="handleAddExtra(this)">
                    + çµŒè²»ã‚’è¿½åŠ 
                </button>
            </div>
        </div>
    `;
    list.appendChild(div);
}

function removeCar(e, btn){ 
    e.stopPropagation(); 
    if(confirm("ã“ã®è»Šä¸¡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { 
        btn.closest('.car-card').remove(); 
        pushDataToFirebase();
    } 
}

function handleAddExtra(btn) {
    const box = btn.previousElementSibling;
    addExtraToDOM(box);
    pushDataToFirebase();
}

function addExtraToDOM(container, name="", amount="", type="club") {
    const div = document.createElement('div');
    div.className = 'extra-item';
    
    const isSplit = (type === 'split') ? 'checked' : '';
    const isClub = (type === 'club') ? 'checked' : '';
    
    // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®nameå±æ€§ã‚’ä¸€æ„ã«ã™ã‚‹ãŸã‚ã®ID
    const uniqueName = "type-" + Date.now() + Math.random().toString(36).substr(2,5);

    // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’å»ƒæ­¢ã—ã€ãƒœã‚¿ãƒ³å¼ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã«å¤‰æ›´
    div.innerHTML = `
        <input type="text" class="ex-name" placeholder="é …ç›®" value="${name}" oninput="window.pushData()">
        <input type="text" class="ex-amount" placeholder="é‡‘é¡" value="${amount}" oninput="window.pushData()">
        
        <div class="type-selector">
            <input type="radio" id="${uniqueName}-c" name="${uniqueName}" value="club" ${isClub} onchange="window.pushData()">
            <label for="${uniqueName}-c">éƒ¨è²»</label>
            
            <input type="radio" id="${uniqueName}-s" name="${uniqueName}" value="split" ${isSplit} onchange="window.pushData()">
            <label for="${uniqueName}-s">å‰²å‹˜</label>
        </div>

        <button class="btn-icon-only" style="color:var(--text-sub);" onclick="this.parentElement.remove(); window.pushData();"><i class='fa-solid fa-xmark'></i></button>
    `;
    container.appendChild(div);
}

function calculate() {
    const data = getFormData();
    const totalPeople = parseInt(data.total);
    const isOrgFree = data.org;
    
    let errorMsgs = [];
    if (!totalPeople || totalPeople <= 0) errorMsgs.push("å‚åŠ äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    if (data.cars.length === 0) errorMsgs.push("è»Šä¸¡ãŒ1å°ã‚‚ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“");

    data.cars.forEach((c, index) => {
        const dName = c.name || `è»Šä¸¡ ${index + 1}`;
        if(!c.dist) errorMsgs.push(`${dName}: èµ°è¡Œè·é›¢ãŒæœªå…¥åŠ›ã§ã™`);
        if(!c.eco) errorMsgs.push(`${dName}: ç‡ƒè²»ãŒæœªå…¥åŠ›ã§ã™`);
        if(!c.price) errorMsgs.push(`${dName}: ã‚¬ã‚½ãƒªãƒ³ä¾¡æ ¼ãŒæœªå…¥åŠ›ã§ã™`);
    });

    if (errorMsgs.length > 0) { alert("âš ï¸ ã‚¨ãƒ©ãƒ¼:\nãƒ»" + errorMsgs.join("\nãƒ»")); return; }

    let totalGas = 0; 
    let totalExtrasSplit = 0; 
    let totalExtrasClub = 0; 
    let totalReward = 0;

    let driverResults = []; 

    data.cars.forEach((c) => {
        const name = c.name || "ãƒ‰ãƒ©ã‚¤ãƒãƒ¼";
        const dist = parseFloat(c.dist) || 0;
        const eco = parseFloat(c.eco) || 1;
        const price = parseFloat(c.price) || 0;
        const gasCost = Math.round((dist / eco) * price);
        
        let driverExtrasTotal = 0; 
        let exs = [];

        c.extras.forEach(ex => {
            const val = parseInt(ex.amount) || 0;
            const nm = ex.name || "è«¸çµŒè²»";
            const tp = ex.type || "club"; 

            if(val !== 0) { 
                driverExtrasTotal += val; 
                exs.push({name: nm, amount: val, type: tp});
                
                if(tp === 'split') {
                    totalExtrasSplit += val;
                } else {
                    totalExtrasClub += val;
                }
            }
        });

        const reward = 1000; 
        totalGas += gasCost; 
        totalReward += reward;

        driverResults.push({
            name,
            totalPay: gasCost + driverExtrasTotal + reward, 
            gasCost,
            reward,
            extras: exs,
            extrasTotal: driverExtrasTotal
        });
    });

    const totalCollectionTarget = totalGas + totalExtrasSplit;

    const payers = isOrgFree ? (totalPeople - 1) : totalPeople;
    const roundUnit = parseInt(data.rounding);
    
    const perPersonPay = payers > 0 ? Math.ceil((totalCollectionTarget / payers) / roundUnit) * roundUnit : 0;
    
    const totalCollected = perPersonPay * payers;
    
    const surplus = totalCollected - totalCollectionTarget;

    const circleNeed = (totalExtrasClub + totalReward) - surplus;


    document.getElementById('receiptDate').textContent = new Date().toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });

    document.getElementById('resPerPerson').textContent = "Â¥ " + perPersonPay.toLocaleString();
    
    let detailText = `å¯¾è±¡: ${payers}å / å®Ÿè²»è¨ˆ: Â¥${totalCollectionTarget.toLocaleString()}`;
    
    if (totalExtrasSplit > 0) {
        detailText += ` (å†…:è«¸çµŒè²»${totalExtrasSplit.toLocaleString()})`;
    }

    document.getElementById('resTargetDetail').textContent = detailText;
    
    const dList = document.getElementById('resDriverList'); 
    dList.innerHTML = "";
    driverResults.forEach(d => {
        const row = document.createElement('div'); 
        row.className = 'receipt-row';
        
        let extrasHtml = "";
        if(d.extras.length > 0) {
            d.extras.forEach(ex => {
                const mark = ex.type === 'split' ? '[å‰²å‹˜]' : '[éƒ¨è²»]';
                extrasHtml += `<span class="receipt-detail">- ${ex.name} ${mark}: Â¥${ex.amount.toLocaleString()}</span>`;
            });
        }

        row.innerHTML = `
            <div style="flex:1;">
                <div style="display:flex; justify-content:space-between; font-weight:bold;">
                    <span>${d.name} ã•ã‚“</span>
                    <span>Â¥${d.totalPay.toLocaleString()}</span>
                </div>
                <span class="receipt-detail">- ã‚¬ã‚½ãƒªãƒ³ä»£: Â¥${d.gasCost.toLocaleString()}</span>
                <span class="receipt-detail">- ãƒ‰ãƒ©ã‚¤ãƒãƒ¼èª¿æ•´è²»: Â¥${d.reward.toLocaleString()}</span>
                ${extrasHtml}
            </div>
        `;
        dList.appendChild(row);
    });

    document.getElementById('resCircleExpense').textContent = "Â¥" + (totalExtrasClub + totalReward).toLocaleString();
    document.getElementById('resGasSurplus').textContent = "-Â¥" + surplus.toLocaleString();
    document.getElementById('resWithdraw').textContent = "Â¥" + circleNeed.toLocaleString();
    
    const resultArea = document.getElementById('resultArea');
    resultArea.style.display = 'block';
    resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });

    saveToHistory();

    // LINEå…±æœ‰ãƒ†ã‚­ã‚¹ãƒˆã®ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯å¤‰æ›´
    let lineText = `ã€ç²¾ç®—å ±å‘Š â›°ï¸ã€‘\n`;
    lineText += `â– å¾´åé¡ï¼ˆ1äººã‚ãŸã‚Šï¼‰\n`;
    lineText += `${perPersonPay.toLocaleString()}å††\n`;
    if(isOrgFree) lineText += `ï¼ˆâ€»ä¼ç”»è€…ã¯å…é™¤ï¼‰\n`;
    
    lineText += `\nâ– ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¸ã®æ”¯æ‰•é¡\n`;
    driverResults.forEach(d => {
        lineText += `ãƒ»${d.name}ã•ã‚“ï¼š${d.totalPay.toLocaleString()}å††\n`;
        
        // å†…è¨³ã‚’è©³ç´°è¡¨ç¤º
        lineText += `  - ã‚¬ã‚½ãƒªãƒ³ä»£: ${d.gasCost.toLocaleString()}\n`;
        
        if(d.extras.length > 0) {
            d.extras.forEach(ex => {
                const typeStr = ex.type === 'split' ? '(å‰²å‹˜)' : '(éƒ¨è²»)';
                const exName = ex.name || 'è«¸çµŒè²»';
                lineText += `  - ${exName}${typeStr}: ${parseInt(ex.amount).toLocaleString()}\n`;
            });
        }
        
        lineText += `  - èª¿æ•´è²»: ${d.reward.toLocaleString()}\n`;
    });
    
    lineText += `\nâ– ã‚µãƒ¼ã‚¯ãƒ«ä¼šè¨ˆã‹ã‚‰ã®æ”¯å‡º\nè¨ˆï¼š${circleNeed.toLocaleString()}å††\n`;
    if(surplus > 0) lineText += `(ç«¯æ•°ä½™å‰° ${surplus}å††å……å½“æ¸ˆã¿)\n`;

    lineText += `\n\nâ–¼è¨ˆç®—ãƒ»ç·¨é›†URL\n${window.location.href}`;

    document.getElementById('copyTextarea').value = lineText;

    showToast("âœ… ç²¾ç®—å®Œäº†ï¼å±¥æ­´ã«ä¿å­˜ã—ã¾ã—ãŸ");
}

function copyRoomLink() {
    const url = window.location.href;
    if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => showToast("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼"));
    } else {
        const ta = document.createElement("textarea");
        ta.value = url;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        showToast("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
    }
}

function shareToLine() {
    const url = window.location.href;
    const text = "ç²¾ç®—ãƒ„ãƒ¼ãƒ«ã®ãƒªãƒ³ã‚¯ã§ã™ã€‚å…¥åŠ›ã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼";
    window.open(`https://line.me/R/msg/text/?${encodeURIComponent(text + "\n" + url)}`, '_blank');
}

function copyToClipboard() {
    const textarea = document.getElementById('copyTextarea');
    textarea.select(); document.execCommand('copy');
    showToast("ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
}

function showToast(msg) {
    const toast = document.getElementById("toast");
    toast.innerHTML = `<i class='fa-solid fa-circle-check'></i> <span>${msg}</span>`;
    toast.className = "show";
    setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
}
</script>
</body>
</html>
