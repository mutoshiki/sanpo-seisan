<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å±±æ­©ä¼šä¼šè¨ˆç²¾ç®—ãƒ„ãƒ¼ãƒ« v3</title>

<style>
/* --- ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ --- */
:root {
    --primary: #2e7d32;      /* ãƒ¡ã‚¤ãƒ³ç·‘ */
    --primary-light: #e8f5e9;
    --accent: #f57c00;
    --danger: #d32f2f;
    --danger-bg: #ffebee;
    --line-color: #06c755;
    --history: #0288d1;
    --text-main: #333333;
    --text-sub: #666666;
    --bg: #f0f2f5;
    --card: #ffffff;
    --input-bg: #fafafa;
    --input-border: #cfd8dc;
    --header-bg: #f5f5f5;
    --guide-bg: #fff8e1;
    --guide-border: #ffe0b2;
    --guide-text: #5d4037;
    --radius: 12px;
    --shadow: 0 4px 15px rgba(0,0,0,0.05);
}

/* --- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚¹ãƒãƒ›è¨­å®šé€£å‹•ï¼‰ --- */
@media (prefers-color-scheme: dark) {
    :root {
        --primary: #81c784;      /* æš—ã„èƒŒæ™¯ã«æ˜ ãˆã‚‹æ˜ã‚‹ã„ç·‘ */
        --primary-light: #1b5e20; /* æš—ç·‘è‰²ã®èƒŒæ™¯ */
        --accent: #ffb74d;       /* æ˜ã‚‹ã„ã‚ªãƒ¬ãƒ³ã‚¸ */
        --danger: #ef5350;       /* æ˜ã‚‹ã„èµ¤ */
        --danger-bg: #4a1515;    /* æš—ã„èµ¤èƒŒæ™¯ */
        --history: #4fc3f7;
        --text-main: #e0e0e0;    /* ç™½ã£ã½ã„ã‚°ãƒ¬ãƒ¼ */
        --text-sub: #b0bec5;
        --bg: #121212;           /* ã»ã¼é»’ */
        --card: #1e1e1e;         /* ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼ */
        --input-bg: #2c2c2c;
        --input-border: #424242;
        --header-bg: #2c2c2c;
        --guide-bg: #3e2723;     /* ã“ã’èŒ¶ */
        --guide-border: #5d4037;
        --guide-text: #fff8e1;
        --shadow: 0 4px 15px rgba(0,0,0,0.5);
    }
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
    margin: 0;
    padding: 20px 15px;
    background: var(--bg);
    color: var(--text-main);
    line-height: 1.6;
    font-size: 16px;
    transition: background 0.3s, color 0.3s;
}

.container { max-width: 500px; margin: 0 auto; }
header { text-align: center; margin-bottom: 25px; }
h1 { font-size: 1.4rem; margin: 0; color: var(--primary); display: flex; flex-direction: column; align-items: center; justify-content: center; }
h1 span { font-size: 0.9rem; margin-top: 5px; color: var(--text-sub); font-weight: normal; }

/* æ¡ˆå†…ãƒœãƒƒã‚¯ã‚¹ */
.usage-guide {
    background: var(--guide-bg);
    border: 1px solid var(--guide-border);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 25px;
    font-size: 0.9rem;
    color: var(--guide-text);
}
.usage-guide h3 {
    margin: 0 0 8px 0;
    color: var(--accent);
    font-size: 1rem;
    display: flex; align-items: center; gap: 6px;
}
.usage-guide ul { margin: 0; padding-left: 20px; font-size: 0.85rem; }

.card {
    background: var(--card);
    padding: 20px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    margin-bottom: 20px;
}

h2 { font-size: 1.1rem; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px; border-bottom: 2px solid var(--primary-light); padding-bottom: 8px; color: var(--primary); }
.sub-title { font-size: 0.8rem; font-weight: normal; color: var(--text-sub); margin-left: auto; }

.input-group { margin-bottom: 15px; }
label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 6px; color: var(--text-sub); }

/* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
input[type="number"], input[type="text"], select {
    width: 100%; padding: 12px; 
    border: 1px solid var(--input-border); 
    border-radius: 8px; 
    font-size: 16px; 
    background: var(--input-bg);
    color: var(--text-main);
    font-family: "SF Mono", "Menlo", "Consolas", "Courier New", monospace;
    font-feature-settings: "tnum";
    transition: 0.2s;
}
input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-light); }

.flex-row { display: flex; gap: 10px; }
.flex-row > div { flex: 1; }

.checkbox-card {
    display: flex; align-items: center; gap: 10px; background: var(--primary-light);
    padding: 12px; border-radius: 8px; cursor: pointer; user-select: none; color: var(--text-main);
}
.checkbox-card input { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); }

/* è»Šä¸¡ã‚«ãƒ¼ãƒ‰ */
.car-card {
    border: 1px solid var(--input-border); border-radius: 10px; margin-bottom: 15px;
    background: var(--card); overflow: hidden;
}
.car-header {
    background: var(--header-bg); padding: 12px 15px;
    display: flex; justify-content: space-between; align-items: center;
    cursor: pointer; user-select: none;
    font-weight: bold; color: var(--text-main);
    transition: background 0.2s;
}
.car-header:active { opacity: 0.8; }
.car-title-text { display: flex; align-items: center; gap: 10px; font-size: 0.95rem; }
.toggle-icon { font-size: 0.8rem; color: var(--text-sub); transition: transform 0.3s; }
.car-card.open .toggle-icon { transform: rotate(180deg); }

.car-body {
    padding: 15px; display: none; animation: fadeIn 0.3s ease;
}
.car-card.open .car-body { display: block; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.remove-btn { 
    color: var(--danger); background: none; border: 1px solid var(--danger);
    font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; cursor: pointer;
}

.extra-section { background: var(--header-bg); padding: 12px; border-radius: 8px; margin-top: 15px; border: 1px dashed var(--input-border); }
.extra-item { display: flex; gap: 8px; margin-bottom: 8px; }

.btn {
    width: 100%; border: none; border-radius: 50px; font-size: 1rem; font-weight: bold;
    padding: 16px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
    text-decoration: none;
}
.btn-primary { background: var(--primary); color: white; margin-top: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
.btn-primary:active { transform: scale(0.98); }
.btn-outline { background: var(--card); border: 2px dashed var(--text-sub); color: var(--text-sub); margin-bottom: 15px; padding: 12px; }
.btn-reset { background: none; color: var(--text-sub); font-size: 0.85rem; margin-top: 20px; text-decoration: underline; padding: 10px; border:none; cursor:pointer;}

/* LINEãƒœã‚¿ãƒ³ */
.btn-line { background: var(--line-color); color: white; margin-top: 10px; }
.btn-line:hover { opacity: 0.9; }

#resultArea { display: none; }

.result-header { text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--input-border); }
.price-tag { font-size: 2.4rem; font-weight: 800; color: var(--primary); display: block; line-height: 1.2; margin: 5px 0; }

/* æ”¯æ‰•ã„ãƒªã‚¹ãƒˆ */
.driver-row { 
    background: var(--card); border: 1px solid var(--input-border); border-radius: 8px; 
    padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
}
.driver-main { 
    display: flex; justify-content: space-between; align-items: center; 
    border-bottom: 2px solid var(--primary-light); padding-bottom: 8px; margin-bottom: 8px;
}
.driver-name { font-weight: bold; font-size: 1.05rem; }
.driver-total-price { font-size: 1.1rem; font-weight: bold; color: var(--primary); }

.detail-line { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.85rem; color: var(--text-sub); }
.detail-group { margin-top: 8px; padding-top: 8px; border-top: 1px dashed var(--input-border); }
.detail-label { color: var(--text-sub); font-size: 0.75rem; margin-bottom: 2px; opacity: 0.8; }

/* æ”¯å‡ºãƒœãƒƒã‚¯ã‚¹ */
.withdraw-box {
    font-size: 1.1rem; font-weight: bold; display: flex; justify-content: space-between; margin-top: 10px;
    color: var(--danger); border: 2px solid var(--danger); padding: 10px; border-radius: 8px;
    background: var(--danger-bg);
}

.copy-box { background: #263238; padding: 15px; border-radius: 8px; margin-top: 10px; }
#copyTextarea { 
    width: 100%; height: 160px; background: transparent; border: none; color: #eceff1; 
    font-size: 0.85rem; resize: none; font-family: monospace; outline: none;
}
.btn-copy { background: var(--accent); color: white; padding: 12px; margin-top: 10px; border-radius: 6px; border: none; width: 100%; font-weight: bold; cursor: pointer; }

/* å±¥æ­´ãƒ‡ã‚¶ã‚¤ãƒ³ */
.history-item { 
    background: var(--card); border-left: 4px solid var(--history); padding: 12px; 
    margin-bottom: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.h-date { font-size: 0.75rem; color: var(--text-sub); margin-bottom: 2px;}
.h-summary { font-weight: bold; font-size: 0.9rem; }
.history-btns { display: flex; gap: 8px; }
.btn-h-restore { font-size: 0.8rem; background: var(--primary-light); color: var(--primary); border:none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
.btn-h-delete { font-size: 0.8rem; background: var(--danger-bg); color: var(--danger); border:none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }

</style>
</head>
<body>

<div class="container">
    <header>
        <h1>â›°ï¸ å±±æ­©ä¼šç”¨ ã‚¬ã‚½ãƒªãƒ³ç²¾ç®—ãƒ„ãƒ¼ãƒ«</h1>
        <h1><span>v3.0 Dark Mode å¯¾å¿œç‰ˆ</span></h1>
    </header>

    <div class="usage-guide">
        <h3>âš ï¸ å‚åŠ è€…ãƒ»ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã®çš†æ§˜ã¸</h3>
        <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€<strong>ä»£è¡¨è€…ï¼ˆä¼šè¨ˆæ‹…å½“ï¼‰1åãŒå…¥åŠ›ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«</strong>ã§ã™ã€‚å„è‡ªã§ç²¾ç®—è¨ˆç®—ã¯è¡Œã‚ãšã€ä»¥ä¸‹ã®æƒ…å ±ã‚’ä»£è¡¨è€…ã«LINEç­‰ã§ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚</p>
        <ul style="margin-top:10px;">
            <li>èµ°è¡Œè·é›¢</li>
            <li>ç‡ƒè²»</li>
            <li>ã‚¬ã‚½ãƒªãƒ³ä¾¡æ ¼</li>
            <li>è«¸è²»ç”¨ï¼ˆé«˜é€Ÿä»£ãƒ»é§è»Šå ´ä»£ãªã©ï¼‰</li>
        </ul>
    </div>

    <div class="card" style="padding-bottom: 10px;">
        <h2>ğŸš— è»Šä¸¡æƒ…å ±ã®ç™»éŒ² <span class="sub-title">ï¼ˆä»£è¡¨è€…ãŒå…¥åŠ›ï¼‰</span></h2>
        <div id="carList"></div>
        <button class="btn btn-outline" onclick="addCar()">+ è»Šä¸¡ã‚’è¿½åŠ </button>
    </div>

    <div class="card">
        <h2>ğŸ‘¥ ç²¾ç®—ã®è¨­å®š</h2>
        
        <div class="input-group">
            <label>ç«¯æ•°å‡¦ç†ï¼ˆåˆ‡ã‚Šä¸Šã’å˜ä½ï¼‰</label>
            <select id="roundingUnit">
                <option value="100" selected>100å††</option>
                <option value="50">50å††</option>
                <option value="10">10å††</option>
                <option value="1">1å††</option>
            </select>
        </div>

        <div class="input-group">
            <label>ä»Šå›ã®ä¼ç”»ã®å‚åŠ äººæ•°(ä¼ç”»è€…å«ã‚€)</label>
            <input type="number" id="totalPeople" placeholder="ä¾‹: 4" inputmode="numeric">
        </div>
        
        <label class="checkbox-card" style="margin-bottom: 15px;">
            <input type="checkbox" id="organizerFree">
            <span>ä¼ç”»è€…ã¯ã‚¬ã‚½ãƒªãƒ³ä»£ã‚’æ”¯æ‰•ã‚ãªã„</span>
        </label>
    </div>

    <button class="btn btn-primary" onclick="calculate()">ğŸš€ ç²¾ç®—ã‚’å®Ÿè¡Œã™ã‚‹</button>
    <button class="btn btn-reset" onclick="resetAll()">å…¨ã¦ã®å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ</button>

    <div id="resultArea">
        <div class="card" style="border-top: 6px solid var(--primary); margin-top:30px;">
            <div class="result-header">
                <label>1äººã‚ãŸã‚Šã®å¾´åé¡ï¼ˆã‚¬ã‚½ãƒªãƒ³ä»£ï¼‰</label>
                <span class="price-tag" id="resPerPerson">0å††</span>
                <small id="resTargetDetail" style="color:var(--text-sub)"></small>
            </div>

            <div class="res-section">
                <label style="margin-bottom:10px; display:block;">ğŸš— ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¸ã®æ”¯æ‰•ã„å†…è¨³</label>
                <div id="resDriverList"></div>
            </div>

            <div class="res-section" style="margin-top:20px; padding-top:15px; border-top: 1px dashed var(--input-border);">
                <label>ğŸ’° ã‚µãƒ¼ã‚¯ãƒ«ä¼šè¨ˆã‹ã‚‰ã®æ”¯å‡º</label>
                <div style="font-size:0.9rem; display: flex; justify-content: space-between; margin-top:5px;">
                    <span>çµŒè²»ãƒ»èª¿æ•´è²»ã®åˆè¨ˆ</span>
                    <span id="resCircleExpense">0å††</span>
                </div>
                <div style="font-size:0.9rem; display: flex; justify-content: space-between; color: var(--primary);">
                    <span>ç«¯æ•°å……å½“é¡ï¼ˆå‚åŠ è€…ã‹ã‚‰ã®ä½™å‰°é‡‘ï¼‰</span>
                    <span id="resGasSurplus">0å††</span>
                </div>
                
                <div class="withdraw-box">
                    <span>ä¼šè¨ˆã‹ã‚‰ã®å®Ÿæ”¯å‡º</span>
                    <span id="resWithdraw">0å††</span>
                </div>
            </div>
        </div>

        <div class="card" style="background: #263238; color: white;">
            <h2 style="color: white; border-color: #546e7a;">ğŸ“± LINEé€ä¿¡ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h2>
            <div class="copy-box">
                <textarea id="copyTextarea" readonly></textarea>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-copy" onclick="copyToClipboard()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                    <a id="btnLineShare" href="#" target="_blank" class="btn btn-line" style="display:none; width:100%;">ğŸ’¬ LINEã§é€ã‚‹</a>
                </div>
            </div>
        </div>
    </div>

    <div class="history-section" style="margin-top: 40px; margin-bottom: 40px;">
        <h2 style="border:none; color: var(--history);">ğŸ•’ æœ€è¿‘ã®è¨ˆç®—å±¥æ­´</h2>
        <div id="historyList"></div>
    </div>
</div>

<script>
const DEFAULT_CAR = { name: "", dist: "", eco: "", price: "", extras: [] };

window.onload = function() {
    loadDraft();
    updateHistory();
};

function addCar(data = null) {
    const list = document.getElementById('carList');
    const idx = list.children.length;
    const c = data || { ...DEFAULT_CAR, extras: [] };
    const isOpen = data ? '' : 'open';

    const div = document.createElement('div');
    div.className = `car-card ${isOpen}`;
    div.id = `car-card-${idx}`;
    
    const displayName = c.name ? c.name : `è»Šä¸¡ ${idx + 1}`;

    div.innerHTML = `
        <div class="car-header" onclick="toggleCar(this)">
            <span class="car-title-text" id="car-title-${idx}">ğŸš™ ${displayName}</span>
            <div style="display:flex; align-items:center; gap:10px;">
                <button class="remove-btn" onclick="removeCar(event, this)">å‰Šé™¤</button>
                <span class="toggle-icon">â–¼</span>
            </div>
        </div>
        <div class="car-body">
            <div class="input-group">
                <label>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼åï¼ˆä»»æ„ï¼‰</label>
                <input type="text" class="inp-name" value="${c.name}" placeholder="æ°å" oninput="updateHeaderName(${idx}, this.value)">
            </div>
            <div class="flex-row">
                <div class="input-group"><label>èµ°è¡Œè·é›¢(km)<span style="color:var(--danger)">*</span></label><input type="number" class="inp-dist" value="${c.dist}" placeholder="ä¾‹: 250" inputmode="decimal"></div>
                <div class="input-group"><label>ç‡ƒè²»(km/L)<span style="color:var(--danger)">*</span></label><input type="number" class="inp-eco" value="${c.eco}" placeholder="ä¾‹: 15" inputmode="decimal"></div>
                <div class="input-group"><label>ã‚¬ã‚½ãƒªãƒ³ä¾¡æ ¼(å††)<span style="color:var(--danger)">*</span></label><input type="number" class="inp-price" value="${c.price}" placeholder="ä¾‹: 170" inputmode="numeric"></div>
            </div>
            <div class="extra-section">
                <label style="margin-bottom:8px; display:block; font-size:0.8rem;">â• è«¸è²»ç”¨ï¼ˆé«˜é€Ÿãƒ»é§è»Šå ´ä»£ãªã©ï¼‰</label>
                <div id="extras-${idx}"></div>
                <button class="btn-reset" style="padding:0; margin:10px 0 0 0; text-align:left; font-size:0.8rem;" onclick="addExtra(${idx})">+ çµŒè²»ã‚’è¿½åŠ </button>
            </div>
        </div>
    `;
    list.appendChild(div);
    if(c.extras) c.extras.forEach(ex => addExtra(idx, ex.name, ex.amount));
}

function toggleCar(header) {
    const card = header.parentElement;
    card.classList.toggle('open');
}

function updateHeaderName(idx, val) {
    const title = document.getElementById(`car-title-${idx}`);
    title.textContent = val ? `ğŸš™ ${val}` : `ğŸš™ è»Šä¸¡ ${idx + 1}`;
}

function addExtra(idx, name="", amount="") {
    const box = document.getElementById(`extras-${idx}`);
    const div = document.createElement('div');
    div.className = 'extra-item';
    div.innerHTML = `
        <input type="text" class="ex-name" placeholder="åç›®" value="${name}" style="flex:2; padding:10px;">
        <input type="number" class="ex-amount" placeholder="é‡‘é¡" value="${amount}" style="flex:1; padding:10px;" inputmode="numeric">
        <button class="remove-btn" style="width:35px; border-radius:4px; font-size:1.2rem; padding:0;" onclick="this.parentElement.remove()">Ã—</button>
    `;
    box.appendChild(div);
}

function removeCar(e, btn){ 
    e.stopPropagation(); 
    if(confirm("ã“ã®è»Šä¸¡æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { 
        btn.closest('.car-card').remove(); 
        saveDraft(); 
    } 
}

function calculate() {
    const totalPeople = parseInt(document.getElementById('totalPeople').value);
    const isOrgFree = document.getElementById('organizerFree').checked;
    
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    let errorMsgs = [];
    if (!totalPeople || totalPeople <= 0) errorMsgs.push("ãƒ»å‚åŠ äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    const cards = document.querySelectorAll('.car-card');
    if (cards.length === 0) errorMsgs.push("ãƒ»è»Šä¸¡ãŒ1å°ã‚‚ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“");

    cards.forEach((card, index) => {
        const name = card.querySelector('.inp-name').value || `è»Šä¸¡ ${index + 1}`;
        const dist = card.querySelector('.inp-dist').value;
        const eco = card.querySelector('.inp-eco').value;
        const price = card.querySelector('.inp-price').value;
        if(!dist) errorMsgs.push(`ãƒ»${name}: èµ°è¡Œè·é›¢ãŒæœªå…¥åŠ›ã§ã™`);
        if(!eco) errorMsgs.push(`ãƒ»${name}: ç‡ƒè²»ãŒæœªå…¥åŠ›ã§ã™`);
        if(!price) errorMsgs.push(`ãƒ»${name}: ã‚¬ã‚½ãƒªãƒ³ä¾¡æ ¼ãŒæœªå…¥åŠ›ã§ã™`);
    });

    if (errorMsgs.length > 0) { alert("âš ï¸ å…¥åŠ›ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™:\n" + errorMsgs.join("\n")); return; }

    let totalGas = 0; let totalExtras = 0; let totalReward = 0;
    let driverResults = []; 

    cards.forEach((card) => {
        const name = card.querySelector('.inp-name').value || "ãƒ‰ãƒ©ã‚¤ãƒãƒ¼";
        const dist = parseFloat(card.querySelector('.inp-dist').value) || 0;
        const eco = parseFloat(card.querySelector('.inp-eco').value) || 1;
        const price = parseFloat(card.querySelector('.inp-price').value) || 0;
        const gasCost = Math.round((dist / eco) * price);
        
        let extrasTotal = 0; 
        let exs = [];
        card.querySelectorAll('.extra-item').forEach(row => {
            const val = parseInt(row.querySelector('.ex-amount').value) || 0;
            const nm = row.querySelector('.ex-name').value || "è«¸çµŒè²»";
            if(val > 0) { extrasTotal += val; exs.push({name: nm, amount: val}); }
        });

        const reward = 1000; 
        totalGas += gasCost; 
        totalExtras += extrasTotal; 
        totalReward += reward;

        driverResults.push({
            name,
            totalPay: gasCost + extrasTotal + reward,
            gasCost,
            reward,
            extras: exs,
            extrasTotal,
            dist: card.querySelector('.inp-dist').value,
            eco: card.querySelector('.inp-eco').value,
            price: card.querySelector('.inp-price').value
        });
    });

    const payers = isOrgFree ? (totalPeople - 1) : totalPeople;

    // ç«¯æ•°å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯
    const roundUnit = parseInt(document.getElementById('roundingUnit').value);
    const perPersonGas = payers > 0 ? Math.ceil((totalGas / payers) / roundUnit) * roundUnit : 0;
    
    const collectedGasTotal = perPersonGas * payers;
    const gasSurplus = collectedGasTotal - totalGas;
    const circleNeed = (totalExtras + totalReward) - gasSurplus;

    document.getElementById('resPerPerson').textContent = perPersonGas.toLocaleString() + " å††";
    document.getElementById('resTargetDetail').innerHTML = `å¾´åäººæ•°ï¼š${payers}å ï¼ ã‚¬ã‚½ãƒªãƒ³ä»£å®Ÿè²»åˆè¨ˆï¼š${totalGas.toLocaleString()}å††<br>ï¼ˆç«¯æ•°å‡¦ç†: ${roundUnit}å††å˜ä½ï¼‰`;
    
    const dList = document.getElementById('resDriverList'); 
    dList.innerHTML = "";
    driverResults.forEach(d => {
        const row = document.createElement('div'); 
        row.className = 'driver-row';
        let extrasHtml = "";
        if(d.extras.length > 0) {
            d.extras.forEach(ex => {
                extrasHtml += `<div class="detail-line"><span>${ex.name}</span><span>${ex.amount.toLocaleString()}å††</span></div>`;
            });
            extrasHtml = `<div class="detail-group"><div class="detail-label">ç«‹æ›¿çµŒè²»</div>${extrasHtml}</div>`;
        }
        row.innerHTML = `
            <div class="driver-main">
                <span class="driver-name">${d.name} æ§˜</span>
                <span class="driver-total-price">${d.totalPay.toLocaleString()} å††</span>
            </div>
            <div>
                <div class="detail-line"><span>ã‚¬ã‚½ãƒªãƒ³ä»£</span><span>${d.gasCost.toLocaleString()}å††</span></div>
                <div class="detail-line"><span>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼èª¿æ•´è²»</span><span>${d.reward.toLocaleString()}å††</span></div>
            </div>
            ${extrasHtml}
        `;
        dList.appendChild(row);
    });

    document.getElementById('resCircleExpense').textContent = (totalExtras + totalReward).toLocaleString() + " å††";
    document.getElementById('resGasSurplus').textContent = "-" + gasSurplus.toLocaleString() + " å††";
    document.getElementById('resWithdraw').textContent = circleNeed.toLocaleString() + " å††";
    document.getElementById('resultArea').style.display = 'block';
    
    document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });

    // LINEãƒ†ã‚­ã‚¹ãƒˆ
    let lineText = `ã€å±±æ­©ä¼š ç²¾ç®—å ±å‘Š ğŸš™ã€‘\n`;
    lineText += `â– å¾´åé¡ï¼ˆã‚¬ã‚½ãƒªãƒ³ä»£ï¼‰\n1äººï¼š${perPersonGas.toLocaleString()}å††\n`;
    if(isOrgFree) lineText += `ï¼ˆâ€»ä¼ç”»è€…ã¯å…é™¤ï¼‰\n`;
    
    lineText += `\nâ– ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¸ã®æ”¯æ‰•é¡\n`;
    driverResults.forEach(d => {
        lineText += `ãƒ»${d.name}ã•ã‚“ï¼š${d.totalPay.toLocaleString()}å††\n`;
        lineText += `  (ã‚¬ã‚¹:${d.gasCost.toLocaleString()} / èª¿æ•´:${d.reward.toLocaleString()}`;
        if (d.extrasTotal > 0) lineText += ` / ç«‹æ›¿:${d.extrasTotal.toLocaleString()}`;
        lineText += `)\n`;
    });
    
    lineText += `\nâ– ã‚µãƒ¼ã‚¯ãƒ«ä¼šè¨ˆã‹ã‚‰ã®æ”¯å‡º\nè¨ˆï¼š${circleNeed.toLocaleString()}å††\n\nãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼`;
    document.getElementById('copyTextarea').value = lineText;

    const encodedText = encodeURIComponent(lineText);
    const lineBtn = document.getElementById('btnLineShare');
    lineBtn.href = `https://line.me/R/msg/text/?${encodedText}`;
    lineBtn.style.display = 'flex';

    saveToHistory({ 
        date: new Date().toLocaleString('ja-JP', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'}), 
        totalPeople, 
        isOrgFree, 
        cars: driverResults, 
        perPersonGas 
    });
}

function copyToClipboard() {
    const textarea = document.getElementById('copyTextarea');
    textarea.select(); document.execCommand('copy');
    const btn = document.querySelector('.btn-copy'); 
    const originalText = btn.textContent;
    btn.textContent = "âœ… ã‚³ãƒ”ãƒ¼å®Œäº†ï¼";
    setTimeout(() => { btn.textContent = originalText; }, 2000);
}

function saveDraft() {
    const cards = document.querySelectorAll('.car-card');
    const carDatas = Array.from(cards).map(card => ({
        name: card.querySelector('.inp-name').value, 
        dist: card.querySelector('.inp-dist').value,
        eco: card.querySelector('.inp-eco').value, 
        price: card.querySelector('.inp-price').value,
        extras: Array.from(card.querySelectorAll('.extra-item')).map(row => ({ name: row.querySelector('.ex-name').value, amount: row.querySelector('.ex-amount').value }))
    }));
    const settings = {
        total: document.getElementById('totalPeople').value,
        org: document.getElementById('organizerFree').checked,
        rounding: document.getElementById('roundingUnit').value
    };
    localStorage.setItem('gas_draft_v3', JSON.stringify({ ...settings, cars: carDatas }));
}

function loadDraft() {
    const raw = localStorage.getItem('gas_draft_v3'); 
    if(!raw) { addCar(); return; }
    
    const d = JSON.parse(raw); 
    document.getElementById('totalPeople').value = d.total || "";
    document.getElementById('organizerFree').checked = d.org || false;
    if(d.rounding) document.getElementById('roundingUnit').value = d.rounding;
    
    document.getElementById('carList').innerHTML = "";
    if(d.cars && d.cars.length) {
        d.cars.forEach(c => addCar(c));
    } else {
        addCar();
    }
}

function saveToHistory(record) {
    let history = JSON.parse(localStorage.getItem('gas_history_v2') || "[]");
    history.unshift(record);
    if(history.length > 5) history.pop();
    localStorage.setItem('gas_history_v2', JSON.stringify(history));
    updateHistory();
}

function updateHistory() {
    const history = JSON.parse(localStorage.getItem('gas_history_v2') || "[]");
    const container = document.getElementById('historyList');
    container.innerHTML = history.length === 0 ? "<p style='font-size:0.85rem; color:var(--text-sub); text-align:center;'>å±¥æ­´ãªã—</p>" : "";
    history.forEach((h, i) => {
        const div = document.createElement('div'); div.className = 'history-item';
        div.innerHTML = `
            <div>
                <div class="h-date">${h.date}</div>
                <div class="h-summary">${h.totalPeople}å / 1äºº ${h.perPersonGas.toLocaleString()}å††</div>
            </div>
            <div class="history-btns">
                <button class="btn-h-restore" onclick="restoreHistory(${i})">å¾©å…ƒ</button>
                <button class="btn-h-delete" onclick="deleteHistory(${i})">å‰Šé™¤</button>
            </div>`;
        container.appendChild(div);
    });
}

function restoreHistory(index) {
    if(!confirm("ç¾åœ¨ã®å…¥åŠ›ã‚’ç ´æ£„ã—ã¦ã€ã“ã®å±¥æ­´ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")) return;
    const history = JSON.parse(localStorage.getItem('gas_history_v2') || "[]");
    const data = history[index];
    document.getElementById('totalPeople').value = data.totalPeople;
    document.getElementById('organizerFree').checked = data.isOrgFree;
    document.getElementById('carList').innerHTML = "";
    
    data.cars.forEach(c => {
        addCar({
            name: c.name,
            dist: c.dist || "",
            eco: c.eco || "",
            price: c.price || "",
            extras: c.extras || []
        });
    });
    calculate();
}

function deleteHistory(index) {
    if(!confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    let history = JSON.parse(localStorage.getItem('gas_history_v2') || "[]");
    history.splice(index, 1);
    localStorage.setItem('gas_history_v2', JSON.stringify(history));
    updateHistory();
}

function resetAll() { if(confirm("å…¥åŠ›ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.removeItem('gas_draft_v3'); location.reload(); } }
document.addEventListener('input', saveDraft);
</script>

</body>
</html>
