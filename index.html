<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>å±±æ­©ä¼šä¼šè¨ˆç²¾ç®—ãƒ„ãƒ¼ãƒ« v7.3</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
:root {
    /* --- ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ: Mature Tool Theme (Light) --- */
    --primary: #2c4c3b;       
    --primary-hover: #1a3326;
    --primary-bg: #e8ece9;    
    --accent: #d4a017;        
    --danger: #b71c1c;        
    --bg: #f4f6f8;            
    --card-bg: #ffffff;       
    --text-main: #333333;     
    --text-sub: #5f6368;      
    --border: #cfd8dc;        
    --input-bg: #f8f9fa;      
    --radius: 6px;            
    --shadow: 0 2px 5px rgba(0,0,0,0.08); 
    --room-hue: 120; 
    --room-color: hsl(var(--room-hue), 40%, 40%);
}

@media (prefers-color-scheme: dark) {
    :root {
        --primary: #768f80;       
        --primary-hover: #8da595;
        --primary-bg: #2d3330;
        --accent: #cfa855;        
        --danger: #ef9a9a;
        --bg: #121212;            
        --card-bg: #1e1e1e;       
        --text-main: #e0e0e0;     
        --text-sub: #a0a0a0;      
        --border: #333333;
        --input-bg: #252525;
        --shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        --room-color: hsl(var(--room-hue), 30%, 60%);
    }
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
    font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
    margin: 0; padding: 0;
    background: var(--bg); color: var(--text-main);
    line-height: 1.6; font-size: 15px;
}

.container { max-width: 600px; margin: 0 auto; padding: 20px 16px 100px 16px; }

/* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
header {
    background: var(--card-bg);
    border-bottom: 1px solid var(--border);
    padding: 12px 16px;
    margin: -20px -16px 20px -16px; 
    display: flex; justify-content: space-between; align-items: center;
    position: sticky; top: 0; z-index: 100;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.brand-area { display: flex; align-items: center; gap: 12px; }
.brand-logo {
    font-size: 1.4rem; color: var(--primary);
    background: var(--primary-bg);
    width: 36px; height: 36px;
    border-radius: var(--radius);
    display: flex; align-items: center; justify-content: center;
}
.brand-text { display: flex; flex-direction: column; }
.app-title { font-size: 1.1rem; font-weight: 700; color: var(--text-main); line-height: 1.2; letter-spacing: 0.02em; margin: 0; }
.app-version { font-size: 0.7rem; color: var(--text-sub); font-family: monospace; }

.header-actions { display: flex; align-items: center; gap: 10px; }

.sync-status {
    font-size: 0.7rem; color: var(--text-sub); font-weight: 600;
    display: flex; align-items: center; gap: 5px;
    background: var(--input-bg); padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border);
}
.sync-dot { width: 6px; height: 6px; background: var(--primary); border-radius: 50%; display: inline-block; animation: pulse 2s infinite; }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

.btn-help {
    background: transparent; border: 1px solid var(--border);
    color: var(--text-main); width: 36px; height: 36px; border-radius: var(--radius);
    font-size: 1rem; display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: 0.2s;
}
.btn-help:hover { background: var(--input-bg); border-color: var(--text-sub); }

/* --- ãƒãƒŠãƒ¼ãƒ»ã‚«ãƒ¼ãƒ‰ --- */
.guide-banner {
    background: linear-gradient(to right, #37474f, #455a64);
    color: #fff; padding: 12px 16px; border-radius: var(--radius);
    margin-bottom: 24px; box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    cursor: pointer; display: flex; align-items: center; justify-content: space-between;
    transition: transform 0.2s;
}
.guide-banner:active { transform: scale(0.98); }
.guide-content { display: flex; align-items: center; gap: 12px; font-weight: bold; font-size: 0.95rem; }

.card {
    background: var(--card-bg); padding: 20px; border-radius: var(--radius);
    box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid var(--border);
}

h2 { 
    font-size: 1rem; margin: 0 0 16px 0; 
    display: flex; align-items: center; gap: 8px; 
    color: var(--text-main); border-bottom: 1px solid var(--border); padding-bottom: 10px;
    text-transform: uppercase; letter-spacing: 0.05em;
}
h2 i { color: var(--text-sub); font-size: 1.1rem; }

/* --- ãƒ«ãƒ¼ãƒ ID --- */
.room-invite-card {
    background: var(--card-bg); border-radius: var(--radius);
    margin-bottom: 24px; box-shadow: var(--shadow); border: 1px solid var(--border);
    overflow: hidden; position: relative;
    border-left: 4px solid var(--room-color);
}
.room-id-section {
    background: var(--input-bg); padding: 12px 16px;
    display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px dashed var(--border);
}
.room-id-label { display: flex; align-items: center; gap: 10px; }
.room-icon-box { color: var(--room-color); font-size: 1.2rem; }
.room-code-group { display: flex; flex-direction: column; }
.room-label-tiny { font-size: 0.65rem; color: var(--text-sub); font-weight: bold; text-transform: uppercase; }
.room-id-text { font-family: "OCR-B", monospace; font-size: 1.1rem; font-weight: 700; color: var(--text-main); letter-spacing: 1px; }

.share-actions { padding: 12px; display: flex; gap: 10px; }
.btn-share-sub {
    flex: 1; background: var(--card-bg); border: 1px solid var(--border);
    color: var(--text-main); padding: 10px; border-radius: var(--radius);
    font-size: 0.85rem; font-weight: 600; cursor: pointer;
    display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;
}
.btn-share-sub:hover { background: var(--bg); border-color: var(--text-sub); }

/* --- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  --- */
.input-group { margin-bottom: 16px; }
label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 6px; color: var(--text-sub); }

input[type="number"], input[type="text"], select {
    width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: var(--radius); 
    font-size: 16px; background: var(--input-bg); color: var(--text-main); transition: 0.2s;
    font-family: inherit;
}
input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(44, 76, 59, 0.15); }

.flex-row { display: flex; gap: 12px; }
.flex-row > div { flex: 1; }

/* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ */
.checkbox-card {
    display: flex; align-items: center; justify-content: space-between;
    background: var(--input-bg); padding: 12px 16px; border-radius: var(--radius); 
    cursor: pointer; user-select: none; border: 1px solid var(--border);
}
.checkbox-card input { display: none; }
.toggle-switch {
    width: 40px; height: 22px; background: var(--border); border-radius: 4px; position: relative; transition: 0.3s;
}
.toggle-switch::after {
    content: ''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px;
    background: #fff; border-radius: 2px; transition: 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.2);
}
.checkbox-card input:checked + .toggle-switch { background: var(--primary); }
.checkbox-card input:checked + .toggle-switch::after { transform: translateX(18px); }

/* è»Šä¸¡ã‚«ãƒ¼ãƒ‰ */
.car-card {
    border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 12px;
    background: var(--card-bg); overflow: hidden;
}
.car-header {
    background: var(--input-bg); padding: 10px 16px;
    display: flex; justify-content: space-between; align-items: center;
    cursor: pointer; font-weight: 600; font-size: 0.95rem; color: var(--text-main);
    border-bottom: 1px solid var(--border);
}
.car-header i { margin-right: 8px; color: var(--text-sub); }
.car-body { padding: 16px; display: none; background: var(--card-bg); }
.car-card.open .car-body { display: block; }
.toggle-icon { transition: transform 0.3s; font-size: 1rem; color: var(--text-sub); }
.car-card.open .toggle-icon { transform: rotate(180deg); }

.btn-icon-only {
    background: none; border: none; color: var(--text-sub); font-size: 1rem; 
    cursor: pointer; padding: 6px; display: flex; align-items: center; transition: color 0.2s;
    flex-shrink: 0;
}
.btn-icon-only:hover { color: var(--danger); }

/* --- è«¸çµŒè²» --- */
.extra-section { 
    background: var(--input-bg); padding: 12px; border-radius: var(--radius); margin-top: 16px; 
    border: 1px solid var(--border); 
}
.extra-item { 
    display: flex; gap: 8px; margin-bottom: 10px; align-items: center; 
    border-bottom:1px solid var(--border); padding-bottom:8px; 
}
.extra-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0;}

.type-selector {
    display: flex; background: var(--border); border-radius: 4px; padding: 2px; width: 90px; flex-shrink: 0;
}
.type-selector input { display: none; }
.type-selector label {
    flex: 1; text-align: center; padding: 6px 0; font-size: 0.7rem; cursor: pointer;
    border-radius: 2px; color: var(--text-sub); transition: 0.2s; font-weight: 600; margin: 0;
}
.type-selector input:checked + label {
    background: var(--card-bg); color: var(--text-main); box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

/* ãƒœã‚¿ãƒ³é¡ */
.btn {
    width: 100%; border: none; border-radius: var(--radius); font-size: 1rem; font-weight: 600;
    padding: 14px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
    text-decoration: none;
}
.btn-primary { 
    background: var(--primary); color: #fff; margin-top: 10px; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.btn-primary:hover { background: var(--primary-hover); }
.btn-primary:active { transform: translateY(1px); }

.btn-outline { 
    background: transparent; border: 1px dashed var(--text-sub); color: var(--text-sub); 
    padding: 10px; font-weight: 600;
}
.btn-outline:hover { background: var(--input-bg); border-color: var(--primary); color: var(--primary); }
.btn-sm { padding: 6px 12px; font-size: 0.8rem; width: auto; display: inline-flex; border-radius: 4px; }

/* --- ãƒ¬ã‚·ãƒ¼ãƒˆ --- */
#resultArea { 
    display: none; 
    opacity: 0.5; /* è¨ˆç®—ä¸­ã¯å°‘ã—è–„ãã™ã‚‹ãªã©ã®æ¼”å‡ºç”¨ */
    transition: opacity 0.3s;
}
#resultArea.active { opacity: 1; }

.receipt-wrapper { padding: 20px; margin: 20px -16px; }
.receipt-paper {
    background: #fff; color: #222; font-family: 'Courier New', Courier, "Hiragino Sans", monospace;
    padding: 25px 20px; position: relative; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    max-width: 400px; margin: 0 auto; border-top: 4px solid #333;
}
.receipt-paper::after { content: ""; display: block; height: 1px; border-bottom: 2px dashed #ccc; margin-top: 20px; }
.receipt-header { text-align: center; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 15px; }
.receipt-logo { font-size: 2rem; color: #333; margin-bottom: 5px; }
.receipt-title { font-size: 1.2rem; font-weight: 900; letter-spacing: 1px; margin: 0; }
.receipt-meta { font-size: 0.75rem; color: #555; margin-top: 5px; }
.receipt-total-section { text-align: right; padding: 15px 0; border-bottom: 2px solid #333; }
.receipt-label-main { font-size: 0.85rem; font-weight: bold; display: block; margin-bottom: 4px; }
.receipt-amount-main { font-size: 2.2rem; font-weight: 900; line-height: 1; display: block; letter-spacing: -1px;}
.receipt-note { font-size: 0.75rem; color: #555; margin-top: 5px; display: block; font-style: italic;}
.receipt-section { padding: 12px 0; border-bottom: 1px dashed #aaa; }
.receipt-section-title {
    font-size: 0.75rem; font-weight: bold; margin-bottom: 6px; display: block; text-align: left;
    background: #eee; display:inline-block; padding: 2px 4px;
}
.receipt-row {
    display: flex; justify-content: space-between; align-items: baseline;
    font-size: 0.9rem; margin-bottom: 4px; line-height: 1.4;
}
.receipt-row.bold { font-weight: 800; font-size: 0.95rem; }
.receipt-detail { font-size: 0.75rem; color: #666; margin-left: 12px; display: block; }
.receipt-footer { text-align: center; margin-top: 20px; font-size: 0.8rem; font-weight: bold; }

.copy-area { background: var(--text-main); color: var(--card-bg); padding: 15px; border-radius: var(--radius); margin-top: 20px; }
#copyTextarea { width: 100%; background: transparent; border: none; color: inherit; font-family: monospace; height: 100px; resize: none; font-size: 0.8rem; outline: none; opacity: 0.8; }
.btn-copy { background: rgba(255,255,255,0.15); color: inherit; padding: 10px; width: 100%; border: 1px solid rgba(255,255,255,0.3); border-radius: var(--radius); margin-top: 10px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }

/* --- å±¥æ­´ --- */
.history-container { margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px; }
.history-item { 
    background: var(--card-bg); padding: 10px 12px; border-radius: var(--radius); margin-bottom: 8px;
    display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border);
}
.history-meta { font-size: 0.75rem; color: var(--text-sub); }
.btn-restore { background: var(--text-sub); color: #fff; border: none; padding: 4px 8px; border-radius: 2px; cursor: pointer; font-size: 0.7rem; font-weight:bold; }

/* ãƒˆãƒ¼ã‚¹ãƒˆ */
#toast {
    visibility: hidden; min-width: 250px; background-color: var(--text-main); color: var(--card-bg); text-align: center;
    border-radius: 50px; padding: 12px 20px; position: fixed; z-index: 2000; left: 50%; bottom: 30px;
    transform: translateX(-50%); font-size: 0.9rem; opacity: 0; transition: opacity 0.3s, bottom 0.3s;
    display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-weight: bold;
}
#toast.show { visibility: visible; opacity: 1; bottom: 50px; }

/* --- ãƒ¢ãƒ¼ãƒ€ãƒ« --- */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.7); z-index: 9999;
    display: none; align-items: center; justify-content: center;
    backdrop-filter: blur(4px);
}
.modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
.modal-content {
    background: var(--card-bg); width: 92%; max-width: 480px; max-height: 85vh;
    border-radius: var(--radius); overflow-y: auto; position: relative;
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    display: flex; flex-direction: column;
}
.modal-header {
    background: var(--input-bg); color: var(--text-main);
    padding: 16px; display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 10;
}
.modal-title { font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
.modal-close-btn {
    background: none; border: none; color: var(--text-sub); font-size: 1.5rem; cursor: pointer; line-height: 1;
}
.modal-body { padding: 20px; overflow-y: auto; }

/* ã‚¬ã‚¤ãƒ‰ç”¨ */
.guide-step { margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
.guide-step:last-child { border: none; margin-bottom: 0; }
.guide-step h4 { margin: 0 0 10px 0; color: var(--primary); font-size: 1rem; font-weight:bold; display:flex; align-items:center; gap:8px;}
.guide-step p { font-size: 0.9rem; color: var(--text-main); margin-bottom: 12px; }
.guide-img-box { 
    border: 1px solid var(--border); border-radius: 4px; overflow: hidden; 
    min-height: 100px; display: flex; align-items: center; justify-content: center;
    background: var(--input-bg);
}
.guide-img-box img { width: 100%; display: block; opacity: 0; transition: opacity 0.5s;}
.guide-img-box img.loaded { opacity: 1; }

.image-modal-content {
    background: transparent; max-width: 90%; text-align: center; box-shadow: none; overflow: visible;
}
.image-modal-content img {
    max-width: 100%; height: auto; border-radius: var(--radius);
    box-shadow: 0 5px 20px rgba(0,0,0,0.5); border: 2px solid #fff;
}
.modal-guide-text { color: #fff; margin-top: 15px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* --- Hidden Guide Templates Container --- */
#guide-templates {
    position: fixed; left: -9999px; top: 0; width: 380px;
    background: var(--bg); pointer-events: none; opacity: 1; visibility: visible; z-index: -1;
}
.tpl-container { padding: 20px; background: var(--bg); }
.tpl-wrapper { padding-bottom: 20px; }

</style>
</head>
<body>

<header>
    <div class="brand-area">
        <div class="brand-logo"><i class='fa-solid fa-mountain'></i></div>
        <div class="brand-text">
            <h1 class="app-title">å±±æ­©ä¼šç²¾ç®—ãƒ„ãƒ¼ãƒ«</h1>
            <span class="app-version">v7.3</span>
        </div>
    </div>
    <div class="header-actions">
        <div class="sync-status">
            <span class="sync-dot"></span>
            <span id="syncText">SYNC</span>
        </div>
        <button class="btn-help" onclick="openGuide()" title="ä½¿ã„æ–¹">
            <i class="fa-solid fa-question"></i>
        </button>
    </div>
</header>

<div class="container">

    <div class="guide-banner" onclick="openGuide()">
        <div class="guide-content">
            <i class="fa-solid fa-book-open"></i>
            <span>åˆã‚ã¦ã®æ–¹ã¸ï¼ˆä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ï¼‰</span>
        </div>
        <i class="fa-solid fa-chevron-right" style="opacity:0.7;"></i>
    </div>

    <div class="room-invite-card">
        <div class="room-id-section">
            <div class="room-id-label">
                <div class="room-icon-box"><i class='fa-solid fa-users-rectangle'></i></div>
                <div class="room-code-group">
                    <span class="room-label-tiny">ROOM ID</span>
                    <span id="dispRoomId" class="room-id-text">...</span>
                </div>
            </div>
            <button class="btn btn-sm" style="background:#fff; border:1px solid var(--border); color:var(--text-main);" onclick="copyRoomLink()">
                <i class='fa-regular fa-copy'></i>
            </button>
        </div>
        <div class="share-actions">
            <button class="btn-share-sub" onclick="shareToLine()">
                <i class='fa-brands fa-line' style="color:#06c755; font-size:1.1rem;"></i> LINEé€ä¿¡
            </button>
            <button class="btn-share-sub" onclick="copyRoomLink()">
                <i class='fa-solid fa-link'></i> URLã‚³ãƒ”ãƒ¼
            </button>
        </div>
    </div>

    <div class="card">
        <h2><i class='fa-solid fa-car'></i> è»Šä¸¡ãƒªã‚¹ãƒˆ</h2>
        <div id="carList"></div>
        <button class="btn btn-outline" onclick="handleAddCarBtn()">
            <i class='fa-solid fa-plus'></i> è»Šä¸¡ã‚’è¿½åŠ 
        </button>
    </div>

    <div class="card">
        <h2><i class='fa-solid fa-sliders'></i> ç²¾ç®—ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h2>
        
        <div class="input-group">
            <label>ç«¯æ•°å‡¦ç† (åˆ‡ã‚Šä¸Šã’)</label>
            <select id="roundingUnit" onchange="pushData()">
                <option value="100" selected>100å††å˜ä½ (æ¨å¥¨)</option>
                <option value="50">50å††å˜ä½</option>
                <option value="10">10å††å˜ä½</option>
                <option value="1">1å††å˜ä½</option>
            </select>
        </div>

        <div class="input-group">
            <label>ç·å‚åŠ äººæ•° (ä¼ç”»è€…å«ã‚€)</label>
            <div style="position: relative;">
                <input type="number" id="totalPeople" placeholder="ä¾‹: 4" inputmode="numeric" oninput="pushData()" style="padding-left: 40px;">
                <i class='fa-solid fa-users' style="position: absolute; left: 12px; top: 11px; color: var(--text-sub);"></i>
            </div>
        </div>
        
        <label class="checkbox-card">
            <span style="font-weight:600; font-size:0.9rem;">ä¼ç”»è€…ã¯ã‚¬ã‚½ãƒªãƒ³ä»£å…é™¤</span>
            <input type="checkbox" id="organizerFree" onchange="pushData()">
            <div class="toggle-switch"></div>
        </label>
    </div>

    <button class="btn btn-primary" onclick="calculate()">
        <i class='fa-solid fa-calculator'></i> ç²¾ç®—ã‚’å®Ÿè¡Œ
    </button>

    <div id="resultArea">
        <div id="captureTarget" class="receipt-wrapper">
            <div class="receipt-paper">
                <div class="receipt-header">
                    <div class="receipt-logo"><i class='fa-solid fa-mountain'></i></div>
                    <h3 class="receipt-title">ç²¾ç®—ãƒ¬ã‚·ãƒ¼ãƒˆ</h3>
                    <div class="receipt-meta" id="receiptDate">2024.01.01 12:00</div>
                </div>

                <div class="receipt-total-section">
                    <span class="receipt-label-main">1äººã‚ãŸã‚Š</span>
                    <span class="receipt-amount-main" id="resPerPerson">0</span>
                    <span class="receipt-note" id="resTargetDetail">--</span>
                </div>

                <div class="receipt-section">
                    <span class="receipt-section-title">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¸ã®æ”¯æ‰•</span>
                    <div id="resDriverList"></div>
                </div>

                <div class="receipt-section">
                    <span class="receipt-section-title">ä¼šè¨ˆãƒ»éƒ¨è²»ç²¾ç®—</span>
                    <div class="receipt-row">
                        <span>éƒ¨è²»è² æ‹…åˆ†</span>
                        <span id="resCircleExpense">0</span>
                    </div>
                    <div class="receipt-row">
                        <span>ç«¯æ•°èª¿æ•´ (ä½™å‰°)</span>
                        <span id="resGasSurplus">0</span>
                    </div>
                    <div class="receipt-row bold" style="margin-top:4px; border-top:1px dashed #aaa; padding-top:4px;">
                        <span>ä¼šè¨ˆå®Ÿæ”¯å‡º</span>
                        <span id="resWithdraw">0</span>
                    </div>
                </div>

                <div class="receipt-footer">
                    ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼<br>
                    å±±æ­©ä¼š
                </div>
            </div>
        </div>

        <div class="copy-area">
            <h3 style="margin:0 0 10px 0; font-size:0.9rem; text-transform:uppercase; letter-spacing:1px; color:rgba(255,255,255,0.7);">
                <i class='fa-solid fa-share-from-square'></i> çµæœã‚’å…±æœ‰
            </h3>
            <textarea id="copyTextarea" readonly></textarea>
            <div style="display: flex; gap: 10px;">
                <button class="btn-copy" onclick="copyToClipboard()">
                    <i class='fa-solid fa-copy'></i> ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼
                </button>
                <button class="btn" style="background: #fff; color: var(--text-main); font-size:0.9rem; border: none; border-radius: var(--radius); width: 100%; margin-top:10px;" onclick="downloadResultImage()">
                    <i class='fa-solid fa-download'></i> ç”»åƒã‚’ä¿å­˜
                </button>
            </div>
        </div>
    </div>
    
    <div class="history-container">
        <details>
            <summary style="cursor: pointer; color: var(--text-sub); font-weight: bold; outline:none; font-size:0.9rem;">
                <i class='fa-solid fa-clock-rotate-left'></i> è¨ˆç®—å±¥æ­´
            </summary>
            <div style="margin-top: 15px;">
                <ul id="historyList" style="list-style: none; padding: 0;"></ul>
                <button class="btn btn-outline btn-sm" style="width:100%; margin-top:10px; border-color:var(--danger); color:var(--danger);" onclick="resetRoom()">
                    <i class='fa-solid fa-trash-can'></i> ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
                </button>
            </div>
        </details>
    </div>

    <div style="margin-top: 40px; text-align: center; border-top: 1px solid var(--border); padding-top: 20px;">
        <button class="btn btn-sm" style="background: var(--input-bg); color: var(--text-sub); border:1px solid var(--border); width: auto;" onclick="fillTestData()">
            <i class='fa-solid fa-flask'></i> Debug Data
        </button>
    </div>

</div>

<div id="guide-templates">
    <div class="tpl-container">
        
        <div id="tpl-step1" class="tpl-wrapper">
             <div class="room-invite-card" style="margin:0;">
                <div class="room-id-section">
                    <div class="room-id-label">
                        <div class="room-icon-box"><i class='fa-solid fa-users-rectangle'></i></div>
                        <div class="room-code-group">
                            <span class="room-label-tiny">ROOM ID</span>
                            <span class="room-id-text">A7X9</span>
                        </div>
                    </div>
                    <button class="btn btn-sm" style="background:#fff; border:1px solid var(--border); color:var(--text-main);">
                        <i class='fa-regular fa-copy'></i>
                    </button>
                </div>
                <div class="share-actions">
                    <button class="btn-share-sub"><i class='fa-brands fa-line' style="color:#06c755;"></i> LINEé€ä¿¡</button>
                    <button class="btn-share-sub"><i class='fa-solid fa-link'></i> URLã‚³ãƒ”ãƒ¼</button>
                </div>
            </div>
        </div>

        <div id="tpl-step2" class="tpl-wrapper">
            <div class="car-card open" style="margin:0;">
                <div class="car-header">
                    <span style="font-weight:600;"><i class='fa-solid fa-car' style="color:var(--text-sub);"></i> ä½è—¤ã®è»Š</span>
                    <i class='fa-solid fa-chevron-down' style="transform:rotate(180deg); color:var(--text-sub);"></i>
                </div>
                <div class="car-body">
                    <div class="input-group">
                        <label>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼å</label>
                        <input type="text" value="ä½è—¤" readonly>
                    </div>
                    <div class="flex-row">
                        <div class="input-group"><label>è·é›¢ (km)</label><input type="number" value="240" readonly></div>
                        <div class="input-group"><label>ç‡ƒè²» (km/L)</label><input type="number" value="15" readonly></div>
                        <div class="input-group"><label>ä¾¡æ ¼ (å††)</label><input type="number" value="168" readonly></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tpl-step3" class="tpl-wrapper">
            <div class="car-card open" style="margin:0;">
                <div class="car-body" style="padding:10px;">
                    <div class="extra-section" style="margin-top:0;">
                        <label style="margin-bottom:8px;">â• è«¸çµŒè²» (é«˜é€Ÿãƒ»é§è»Šå ´ãªã©)</label>
                        <div class="extra-item">
                            <div style="flex:1;">
                                <input type="text" value="é«˜é€Ÿä»£(ETC)" style="margin-bottom:4px;" readonly>
                                <div style="display:flex; gap:8px;">
                                    <input type="text" value="5600" readonly>
                                    <div class="type-selector">
                                        <input type="radio" checked><label style="background:var(--card-bg); color:var(--text-main); box-shadow:0 1px 2px rgba(0,0,0,0.1);">éƒ¨è²»</label>
                                        <label>å‰²å‹˜</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tpl-step4" class="tpl-wrapper">
            <div class="card" style="margin:0;">
                <h2><i class='fa-solid fa-sliders'></i> ç²¾ç®—ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h2>
                <div class="input-group">
                    <label>ç·å‚åŠ äººæ•° (ä¼ç”»è€…å«ã‚€)</label>
                    <div style="position: relative;">
                        <input type="number" value="4" style="padding-left: 40px;" readonly>
                        <i class='fa-solid fa-users' style="position: absolute; left: 12px; top: 11px; color: var(--text-sub);"></i>
                    </div>
                </div>
                <label class="checkbox-card">
                    <span style="font-weight:600; font-size:0.9rem;">ä¼ç”»è€…ã¯ã‚¬ã‚½ãƒªãƒ³ä»£å…é™¤</span>
                    <div class="toggle-switch" style="background:var(--primary);"><div style="position:absolute; top:2px; left:2px; width:18px; height:18px; background:#fff; border-radius:2px; transform:translateX(18px);"></div></div>
                </label>
            </div>
        </div>

        <div id="tpl-step5" class="tpl-wrapper">
            <div class="receipt-paper" style="max-width:100%; border-top:3px solid #333; padding:15px;">
                <div class="receipt-header" style="margin-bottom:10px; padding-bottom:10px;">
                    <h3 class="receipt-title" style="font-size:1rem;">ç²¾ç®—ãƒ¬ã‚·ãƒ¼ãƒˆ</h3>
                </div>
                <div class="receipt-total-section" style="padding:10px 0;">
                    <span class="receipt-label-main">1äººã‚ãŸã‚Š</span>
                    <span class="receipt-amount-main" style="font-size:1.8rem;">Â¥3,500</span>
                    <span class="receipt-note">3å / å®Ÿè²»: Â¥10,240</span>
                </div>
                <div class="receipt-section">
                    <div class="receipt-row">
                        <span style="font-weight:bold;">ä½è—¤ã•ã‚“</span>
                        <span style="font-weight:bold;">Â¥9,200</span>
                    </div>
                    <span class="receipt-detail" style="font-size:0.7rem;">- ã‚¬ã‚½ãƒªãƒ³: Â¥2,600</span>
                    <span class="receipt-detail" style="font-size:0.7rem;">- é«˜é€Ÿä»£(ETC) (éƒ¨): Â¥5,600</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="guideModal" class="modal-overlay" onclick="if(event.target == this) closeGuide()">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title"><i class="fa-solid fa-book-open" style="color:var(--accent);"></i> ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</div>
            <button class="modal-close-btn" onclick="closeGuide()">&times;</button>
        </div>
        <div class="modal-body">
            
            <div class="guide-step">
                <h4><i class="fa-solid fa-1"></i> ãƒ«ãƒ¼ãƒ ã‚’å…±æœ‰</h4>
                <p>URLã‚’ãƒ¡ãƒ³ãƒãƒ¼ã«é€ã‚‹ã¨ã€å…¨å“¡ã§åŒã˜ç”»é¢ã‚’è¦‹ãªãŒã‚‰å…¥åŠ›ã§ãã¾ã™ã€‚</p>
                <div class="guide-img-box"><img id="guide-img-1" alt="ãƒ«ãƒ¼ãƒ å…±æœ‰"></div>
            </div>

            <div class="guide-step">
                <h4><i class="fa-solid fa-2"></i> è»Šä¸¡ã‚’è¿½åŠ ãƒ»å…¥åŠ›</h4>
                <p>è»Šã‚’å‡ºã—ãŸäººã¯è·é›¢ãƒ»ç‡ƒè²»ãƒ»ã‚¬ã‚½ãƒªãƒ³ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¾ã™ã€‚ã€Œï¼‹ã€ãƒœã‚¿ãƒ³ã§è¤‡æ•°å°ç™»éŒ²ã‚‚å¯èƒ½ã§ã™ã€‚</p>
                <div class="guide-img-box"><img id="guide-img-2" alt="è»Šä¸¡å…¥åŠ›"></div>
            </div>

            <div class="guide-step">
                <h4><i class="fa-solid fa-3"></i> è«¸çµŒè²»ï¼ˆéƒ¨è²»ãƒ»å‰²å‹˜ï¼‰</h4>
                <p>é«˜é€Ÿä»£ã‚„é§è»Šå ´ä»£ãªã©ã‚’è¿½åŠ ã—ã¾ã™ã€‚<br>
                <span style="font-weight:bold; color:var(--primary);">[å‰²å‹˜]</span> å‚åŠ è€…å…¨å“¡ã§å‰²ã‚‹è²»ç”¨ï¼ˆé«˜é€Ÿä»£ãªã©ï¼‰<br>
                <span style="font-weight:bold; color:var(--text-sub);">[éƒ¨è²»]</span> ä¼šè¨ˆã‹ã‚‰å…¨é¡å‡ºã‚‹è²»ç”¨ï¼ˆãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼ä»£ãªã©ï¼‰</p>
                <div class="guide-img-box"><img id="guide-img-3" alt="è«¸çµŒè²»è¨­å®š"></div>
            </div>

            <div class="guide-step">
                <h4><i class="fa-solid fa-4"></i> äººæ•°è¨­å®šã¨è¨ˆç®—</h4>
                <p>å‚åŠ äººæ•°ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€è‡ªå‹•ã§è¨ˆç®—çµæœãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚ç«¯æ•°å‡¦ç†ã®è¨­å®šã‚‚å¯èƒ½ã§ã™ã€‚</p>
                <div class="guide-img-box"><img id="guide-img-4" alt="è¨ˆç®—è¨­å®š"></div>
            </div>

            <div class="guide-step">
                <h4><i class="fa-solid fa-5"></i> çµæœã®ä¿å­˜</h4>
                <p>ç²¾ç®—ãƒ¬ã‚·ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã€Œç”»åƒã‚’ä¿å­˜ã€ã§ã‚¢ãƒ«ãƒãƒ ã«æ®‹ã—ãŸã‚Šã€ãƒ†ã‚­ã‚¹ãƒˆã‚’LINEã«è²¼ã£ã¦å ±å‘Šã§ãã¾ã™ã€‚</p>
                <div class="guide-img-box"><img id="guide-img-5" alt="ç²¾ç®—çµæœ"></div>
            </div>
            
            <div style="text-align:center;">
                <button class="btn btn-primary" onclick="closeGuide()">é–‰ã˜ã‚‹</button>
            </div>

        </div>
    </div>
</div>

<div id="imageModal" class="modal-overlay" onclick="if(event.target == this) closeImageModal()">
    <div class="image-modal-content">
        <img id="generatedImage" src="" alt="ç²¾ç®—çµæœ">
        <div class="modal-guide-text">é•·æŠ¼ã—ã—ã¦ç”»åƒã‚’ä¿å­˜</div>
        <button onclick="closeImageModal()" style="margin-top:20px; background:rgba(255,255,255,0.2); border:1px solid #fff; color:#fff; padding:8px 20px; border-radius:20px;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="toast"><i class='fa-solid fa-circle-check'></i> <span>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</span></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// --- Global Assignments ---
window.pushData = debounce(pushDataToFirebase, 500);
window.handleAddCarBtn = handleAddCarBtn;
window.resetRoom = resetRoom;
window.loadFromHistory = loadFromHistory;
window.deleteHistory = deleteHistory;
window.fillTestData = fillTestData;
window.downloadResultImage = downloadResultImage;
window.closeImageModal = closeImageModal;
window.addCarToDOM = addCarToDOM;
window.removeCar = removeCar;
window.handleAddExtra = handleAddExtra;
window.calculate = () => calculate(false); // Button click (interactive)
window.copyRoomLink = copyRoomLink;
window.shareToLine = shareToLine;
window.copyToClipboard = copyToClipboard;
window.openGuide = openGuide;
window.closeGuide = closeGuide;

// Generate Guide Images on Load
window.addEventListener('load', () => {
    setTimeout(generateGuideImages, 1000); // Wait for fonts/icons to load
});

const firebaseConfig = {
  apiKey: "AIzaSyAypqRPRn-YHWLwjT3lQ6pN6_bWBqzUvp4",
  authDomain: "sanpo-seisan.firebaseapp.com",
  databaseURL: "https://sanpo-seisan-default-rtdb.firebaseio.com",
  projectId: "sanpo-seisan",
  storageBucket: "sanpo-seisan.firebasestorage.app",
  messagingSenderId: "709215338656",
  appId: "1:709215338656:web:c2b0dbc9aceb0fa60f89c5"
};

let app, db, roomRef, roomId;

try {
    app = initializeApp(firebaseConfig);
    db = getDatabase(app);

    roomId = new URLSearchParams(window.location.search).get("room");
    if (!roomId) {
        roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
        const newUrl = window.location.pathname + "?room=" + roomId;
        window.history.replaceState(null, null, newUrl);
    }
    const dispEl = document.getElementById('dispRoomId');
    if(dispEl) dispEl.textContent = roomId;

    updateRoomColor(roomId);
    roomRef = ref(db, 'sessions/' + roomId);

    renderHistoryList();
    onValue(roomRef, (snapshot) => {
        const data = snapshot.val();
        const syncText = document.getElementById("syncText");
        
        if (data) {
            if(syncText) syncText.textContent = "OK";
            renderForm(data);
            calculate(true); // Silent calculation on data load
        } else {
            if(syncText) syncText.textContent = "NEW";
            const list = document.getElementById('carList');
            if(list && list.children.length === 0) {
                addCarToDOM(null, 0, true);
            }
        }
    });

} catch (e) {
    console.error("Initialization Error:", e);
    showToast("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼");
}

function updateRoomColor(id) {
    let hash = 0;
    for (let i = 0; i < id.length; i++) hash = id.charCodeAt(i) + ((hash << 5) - hash);
    const hue = Math.abs(hash % 360);
    document.documentElement.style.setProperty('--room-hue', hue);
}

function generateGuideImages() {
    if (typeof html2canvas === 'undefined') return;
    
    const steps = [
        { src: 'tpl-step1', target: 'guide-img-1' },
        { src: 'tpl-step2', target: 'guide-img-2' },
        { src: 'tpl-step3', target: 'guide-img-3' },
        { src: 'tpl-step4', target: 'guide-img-4' },
        { src: 'tpl-step5', target: 'guide-img-5' }
    ];

    const generateNext = (index) => {
        if (index >= steps.length) return;
        const s = steps[index];
        const el = document.getElementById(s.src);
        const img = document.getElementById(s.target);
        if(el && img) {
            html2canvas(el, { scale: 2, backgroundColor: null, logging: false }).then(canvas => {
                img.src = canvas.toDataURL('image/png');
                img.classList.add('loaded');
                generateNext(index + 1);
            });
        } else {
            generateNext(index + 1);
        }
    };
    generateNext(0);
}

function downloadResultImage() {
    const target = document.getElementById('captureTarget');
    showToast("ç”»åƒç”Ÿæˆä¸­...");

    if (typeof html2canvas === 'undefined') {
        alert("ç”»åƒãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­è¾¼å¤±æ•—");
        return;
    }

    const options = {
        scale: 2,
        backgroundColor: null,
        logging: false,
        useCORS: true
    };

    html2canvas(target, options).then(canvas => {
        const dataUrl = canvas.toDataURL('image/png');
        const ua = navigator.userAgent;
        const isIOS = /iPhone|iPad|iPod/i.test(ua);

        if (isIOS) {
            const img = document.getElementById('generatedImage');
            img.src = dataUrl;
            document.getElementById('imageModal').classList.add('active');
            showToast("ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ä¿å­˜");
        } else {
            const link = document.createElement('a');
            link.download = `receipt_${roomId}.png`;
            link.href = dataUrl;
            link.click();
            showToast("âœ… ä¿å­˜ã—ã¾ã—ãŸ");
        }
    }).catch(err => {
        console.error(err);
        showToast("ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ");
    });
}

function closeImageModal() {
    document.getElementById('imageModal').classList.remove('active');
}

function openGuide() {
    document.getElementById('guideModal').classList.add('active');
}
function closeGuide() {
    document.getElementById('guideModal').classList.remove('active');
}

function renderForm(data) {
    setValIfDiff('totalPeople', data.total);
    setCheckIfDiff('organizerFree', data.org);
    setValIfDiff('roundingUnit', data.rounding);

    const carList = document.getElementById('carList');
    const remoteCars = data.cars || [];
    const currentCards = carList.getElementsByClassName('car-card');
    
    while(currentCards.length < remoteCars.length) {
        addCarToDOM(null, currentCards.length, true);
    }
    while(currentCards.length > remoteCars.length) {
        carList.removeChild(carList.lastChild);
    }

    Array.from(currentCards).forEach((card, i) => {
        const cData = remoteCars[i];
        
        const inputs = {
            name: card.querySelector('.inp-name'),
            dist: card.querySelector('.inp-dist'),
            eco: card.querySelector('.inp-eco'),
            price: card.querySelector('.inp-price')
        };
        
        if(document.activeElement !== inputs.name) inputs.name.value = cData.name || "";
        if(document.activeElement !== inputs.dist) inputs.dist.value = cData.dist || "";
        if(document.activeElement !== inputs.eco) inputs.eco.value = cData.eco || "";
        if(document.activeElement !== inputs.price) inputs.price.value = cData.price || "";
        
        const title = card.querySelector('.car-title-text');
        const dName = cData.name || `è»Šä¸¡ ${i + 1}`;
        title.innerHTML = `<i class='fa-solid fa-car'></i> ${dName}`;

        const extrasBox = card.querySelector('.extra-section div[id^="extras-"]');
        if(!extrasBox) return;

        const remoteExtras = cData.extras || [];
        const currentExtras = extrasBox.getElementsByClassName('extra-item');

        while(currentExtras.length < remoteExtras.length) {
            addExtraToDOM(extrasBox, "", "", "club");
        }
        while(currentExtras.length > remoteExtras.length) {
            extrasBox.removeChild(extrasBox.lastChild);
        }

        Array.from(currentExtras).forEach((row, j) => {
            const exData = remoteExtras[j];
            const nameInp = row.querySelector('.ex-name');
            const amtInp = row.querySelector('.ex-amount');
            
            if(document.activeElement !== nameInp) nameInp.value = exData.name || "";
            if(document.activeElement !== amtInp) amtInp.value = exData.amount || "";
            
            const typeVal = exData.type || "club";
            const radio = row.querySelector(`input[type="radio"][value="${typeVal}"]`);
            if(radio && !radio.checked) {
                radio.checked = true;
            }
        });
    });
}

function setValIfDiff(id, val) {
    const el = document.getElementById(id);
    if (el && document.activeElement !== el && el.value != val) {
        el.value = val || "";
    }
}
function setCheckIfDiff(id, val) {
    const el = document.getElementById(id);
    if (el && el.checked != val) {
        el.checked = val || false;
    }
}

function pushDataToFirebase() {
    if(!roomRef) return; 
    const data = getFormData();
    const syncText = document.getElementById("syncText");
    if(syncText) syncText.textContent = "...";
    
    // Real-time calculation (silent mode)
    calculate(true);

    set(roomRef, data).then(() => {
        if(syncText) syncText.textContent = "OK";
    }).catch((e) => {
        if(syncText) syncText.textContent = "ERR";
        console.error(e);
    });
}

function debounce(func, wait) {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
    };
}

function getFormData() {
    const cards = document.querySelectorAll('#carList .car-card');
    const carDatas = Array.from(cards).map(card => ({
        name: card.querySelector('.inp-name').value, 
        dist: card.querySelector('.inp-dist').value,
        eco: card.querySelector('.inp-eco').value, 
        price: card.querySelector('.inp-price').value,
        extras: Array.from(card.querySelectorAll('.extra-item')).map(row => {
            const checkedRadio = row.querySelector('input[type="radio"]:checked');
            return { 
                name: row.querySelector('.ex-name').value, 
                amount: row.querySelector('.ex-amount').value,
                type: checkedRadio ? checkedRadio.value : "club"
            };
        })
    }));
    return {
        total: document.getElementById('totalPeople').value,
        org: document.getElementById('organizerFree').checked,
        rounding: document.getElementById('roundingUnit').value,
        cars: carDatas,
        updatedAt: Date.now()
    };
}

function resetRoom() {
    if(!roomRef) return;
    if(confirm("å…¨ã¦ã®å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
        set(roomRef, null).then(() => {
            window.location.reload();
        });
    }
}

function fillTestData() {
    if(!confirm("ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¾ã™ã‹ï¼Ÿ")) return;

    document.getElementById('carList').innerHTML = "";
    document.getElementById('totalPeople').value = 8;
    document.getElementById('roundingUnit').value = "100";
    document.getElementById('organizerFree').checked = true;

    // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å®šç¾©
    const testData = [
        { 
            name: "ç¹”ç”°ä¿¡é•·", 
            dist: 245, eco: 12, price: 175, 
            extras: [
                { name: "é«˜é€Ÿä»£(å¾€å¾©)", amount: 5600, type: "split" } 
            ] 
        },
        { 
            name: "å‚æœ¬é¾é¦¬", 
            dist: 220, eco: 20, price: 168, 
            extras: [
                { name: "ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼ä»£", amount: 12000, type: "club" }, 
                { name: "é§è»Šå ´", amount: 1500, type: "split" },       
                { name: "ã‚¯ãƒ¼ãƒãƒ³å‰²å¼•", amount: -1000, type: "club" }   
            ] 
        }
    ];

    testData.forEach((d, i) => {
        addCarToDOM(null, -1, true);
        const card = document.getElementById('carList').lastElementChild;
        
        card.querySelector('.inp-name').value = d.name;
        card.querySelector('.inp-dist').value = d.dist;
        card.querySelector('.inp-eco').value  = d.eco;
        card.querySelector('.inp-price').value = d.price;

        const extraBox = card.querySelector('.extra-section > div');
        d.extras.forEach(ex => {
            addExtraToDOM(extraBox, ex.name, ex.amount, ex.type);
        });
    });

    pushDataToFirebase();
    showToast("ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æŠ•å…¥");
    // setTimeout(calculate, 500); // Triggered by pushData now
}

function saveToHistory() {
    const data = getFormData();
    if(!data.total && data.cars.length === 1 && !data.cars[0].dist) return;
    try {
        const history = JSON.parse(localStorage.getItem('sanpo_history_v7') || "[]");
        if(history.length > 0) {
            const last = history[0].data;
            if(JSON.stringify(last) === JSON.stringify(data)) return; 
        }
        const summary = `${data.total || "?"}å / è»Š${data.cars.length}å°`;
        history.unshift({ 
            date: new Date().toLocaleString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' }), 
            summary: summary,
            data: data 
        });
        localStorage.setItem('sanpo_history_v7', JSON.stringify(history.slice(0, 10)));
        renderHistoryList();
    } catch(e) { console.error("History Save Error:", e); }
}

function renderHistoryList() {
    const list = document.getElementById('historyList');
    if(!list) return;
    let history = [];
    try { history = JSON.parse(localStorage.getItem('sanpo_history_v7') || "[]"); } catch(e) {}
    
    if (history.length === 0) {
        list.innerHTML = `<li style="text-align:center; color:var(--text-sub); padding:10px; font-size:0.8rem;">å±¥æ­´ãªã—</li>`;
        return;
    }
    list.innerHTML = "";
    history.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = 'history-item';
        li.innerHTML = `
            <div>
                <span class="history-meta">${item.date}</span>
                <div style="font-weight:600; font-size:0.9rem;">${item.summary}</div>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn-restore" onclick="loadFromHistory(${index})">å¾©å…ƒ</button>
                <button class="btn-icon-only" style="color:var(--text-sub);" onclick="deleteHistory(${index})"><i class='fa-solid fa-xmark'></i></button>
            </div>
        `;
        list.appendChild(li);
    });
}

function loadFromHistory(index) {
    if(!roomRef) return;
    if(!confirm("ç¾åœ¨ã®å…¥åŠ›ã‚’ä¸Šæ›¸ãã—ã¦å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")) return;
    try {
        const history = JSON.parse(localStorage.getItem('sanpo_history_v7') || "[]");
        const item = history[index];
        if(item && item.data) {
            set(roomRef, item.data).then(() => {
                showToast("ğŸ“‚ å¾©å…ƒã—ã¾ã—ãŸ");
            });
        }
    } catch(e) { console.error(e); }
}

function deleteHistory(index) {
    if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    try {
        const history = JSON.parse(localStorage.getItem('sanpo_history_v7') || "[]");
        history.splice(index, 1);
        localStorage.setItem('sanpo_history_v7', JSON.stringify(history));
        renderHistoryList();
    } catch(e) { console.error(e); }
}

function handleAddCarBtn() {
    addCarToDOM();
    pushDataToFirebase();
}

function addCarToDOM(data = null, idx = -1, forceOpen = false) {
    const list = document.getElementById('carList');
    if(!list) return;
    if (idx === -1) idx = list.children.length;
    if(list.children[idx]) return;

    const div = document.createElement('div');
    div.className = `car-card open`;
    const onInput = `oninput="window.pushData()"`;
    const extrasId = `extras-${Date.now()}-${Math.random().toString(36).substr(2,5)}`;

    div.innerHTML = `
        <div class="car-header" onclick="this.parentElement.classList.toggle('open')">
            <span class="car-title-text"><i class='fa-solid fa-car'></i> è»Šä¸¡ ${idx + 1}</span>
            <div style="display:flex; align-items:center; gap:8px;">
                <button class="btn-icon-only" onclick="removeCar(event, this)" title="å‰Šé™¤"><i class='fa-solid fa-trash'></i></button>
                <i class='fa-solid fa-chevron-down toggle-icon'></i>
            </div>
        </div>
        <div class="car-body">
            <div class="input-group">
                <label>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼å</label>
                <input type="text" class="inp-name" placeholder="æ°å (ä»»æ„)" ${onInput}>
            </div>
            <div class="flex-row">
                <div class="input-group"><label>è·é›¢ (km)</label><input type="number" class="inp-dist" placeholder="240" inputmode="decimal" ${onInput}></div>
                <div class="input-group"><label>ç‡ƒè²» (km/L)</label><input type="number" class="inp-eco" placeholder="15" inputmode="decimal" ${onInput}></div>
                <div class="input-group"><label>ä¾¡æ ¼ (å††)</label><input type="number" class="inp-price" placeholder="165" inputmode="numeric" ${onInput}></div>
            </div>
            <div class="extra-section">
                <label style="margin-bottom:8px;">â• è«¸çµŒè²» (é«˜é€Ÿãƒ»é§è»Šå ´ãªã©)</label>
                <div id="${extrasId}"></div>
                <button class="btn-sm" style="background:#fff; color:var(--text-sub); border:1px solid var(--border); margin-top:8px;" onclick="handleAddExtra(this)">
                    è¿½åŠ 
                </button>
            </div>
        </div>
    `;
    list.appendChild(div);
}

function removeCar(e, btn){ 
    e.stopPropagation(); 
    if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { 
        btn.closest('.car-card').remove(); 
        pushDataToFirebase();
    } 
}

function handleAddExtra(btn) {
    const box = btn.previousElementSibling;
    addExtraToDOM(box);
    pushDataToFirebase();
}

function addExtraToDOM(container, name="", amount="", type="club") {
    const div = document.createElement('div');
    div.className = 'extra-item';
    const isSplit = (type === 'split') ? 'checked' : '';
    const isClub = (type === 'club') ? 'checked' : '';
    const uniqueName = "type-" + Date.now() + Math.random().toString(36).substr(2,5);

    div.innerHTML = `
        <div style="flex:1;">
            <input type="text" class="ex-name" placeholder="é …ç›®" value="${name}" oninput="window.pushData()" style="margin-bottom:4px;">
            <div style="display:flex; gap:8px;">
                <input type="text" class="ex-amount" placeholder="é‡‘é¡" value="${amount}" oninput="window.pushData()">
                <div class="type-selector">
                    <input type="radio" id="${uniqueName}-c" name="${uniqueName}" value="club" ${isClub} onchange="window.pushData()">
                    <label for="${uniqueName}-c">éƒ¨è²»</label>
                    <input type="radio" id="${uniqueName}-s" name="${uniqueName}" value="split" ${isSplit} onchange="window.pushData()">
                    <label for="${uniqueName}-s">å‰²å‹˜</label>
                </div>
            </div>
        </div>
        <button class="btn-icon-only" style="align-self:flex-start; margin-top:8px;" onclick="this.parentElement.remove(); window.pushData();"><i class='fa-solid fa-xmark'></i></button>
    `;
    container.appendChild(div);
}

function calculate(silent = false) {
    const data = getFormData();
    const totalPeople = parseInt(data.total);
    const isOrgFree = data.org;
    
    // Validation
    let errorMsgs = [];
    if (!totalPeople || totalPeople <= 0) errorMsgs.push("å‚åŠ äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    if (data.cars.length === 0) errorMsgs.push("è»Šä¸¡ãŒã‚ã‚Šã¾ã›ã‚“");

    data.cars.forEach((c, index) => {
        const dName = c.name || `è»Šä¸¡ ${index + 1}`;
        if(!c.dist) errorMsgs.push(`${dName}: è·é›¢æœªå…¥åŠ›`);
        if(!c.eco) errorMsgs.push(`${dName}: ç‡ƒè²»æœªå…¥åŠ›`);
        if(!c.price) errorMsgs.push(`${dName}: ä¾¡æ ¼æœªå…¥åŠ›`);
    });

    if (errorMsgs.length > 0) { 
        if (!silent) {
            alert("ç¢ºèªã—ã¦ãã ã•ã„:\nãƒ»" + errorMsgs.join("\nãƒ»")); 
        }
        return; 
    }

    let totalGas = 0; 
    let totalExtrasSplit = 0; 
    let totalExtrasClub = 0; 
    let totalReward = 0;
    let driverResults = []; 

    data.cars.forEach((c) => {
        const name = c.name || "ãƒ‰ãƒ©ã‚¤ãƒãƒ¼";
        const dist = parseFloat(c.dist) || 0;
        const eco = parseFloat(c.eco) || 1;
        const price = parseFloat(c.price) || 0;
        const gasCost = Math.round((dist / eco) * price);
        let driverExtrasTotal = 0; 
        let exs = [];

        c.extras.forEach(ex => {
            const val = parseInt(ex.amount) || 0;
            const nm = ex.name || "è«¸çµŒè²»";
            const tp = ex.type || "club"; 
            if(val !== 0) { 
                driverExtrasTotal += val; 
                exs.push({name: nm, amount: val, type: tp});
                if(tp === 'split') totalExtrasSplit += val;
                else totalExtrasClub += val;
            }
        });

        const reward = 1000; 
        totalGas += gasCost; 
        totalReward += reward;

        driverResults.push({
            name, totalPay: gasCost + driverExtrasTotal + reward, gasCost, reward, extras: exs
        });
    });

    const totalCollectionTarget = totalGas + totalExtrasSplit;
    const payers = isOrgFree ? (totalPeople - 1) : totalPeople;
    const roundUnit = parseInt(data.rounding);
    const perPersonPay = payers > 0 ? Math.ceil((totalCollectionTarget / payers) / roundUnit) * roundUnit : 0;
    const totalCollected = perPersonPay * payers;
    const surplus = totalCollected - totalCollectionTarget;
    const circleNeed = (totalExtrasClub + totalReward) - surplus;

    document.getElementById('receiptDate').textContent = new Date().toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
    document.getElementById('resPerPerson').textContent = "Â¥" + perPersonPay.toLocaleString();
    
    let detailText = `${payers}å / å®Ÿè²»: Â¥${totalCollectionTarget.toLocaleString()}`;
    if (totalExtrasSplit > 0) detailText += ` (å†…:è«¸çµŒè²»${totalExtrasSplit.toLocaleString()})`;
    document.getElementById('resTargetDetail').textContent = detailText;
    
    const dList = document.getElementById('resDriverList'); 
    dList.innerHTML = "";
    driverResults.forEach(d => {
        let extrasHtml = "";
        d.extras.forEach(ex => {
            const mark = ex.type === 'split' ? '(å‰²)' : '(éƒ¨)';
            extrasHtml += `<span class="receipt-detail">- ${ex.name} ${mark}: Â¥${ex.amount.toLocaleString()}</span>`;
        });
        const row = document.createElement('div'); 
        row.className = 'receipt-row';
        row.innerHTML = `
            <div style="flex:1;">
                <div style="display:flex; justify-content:space-between; font-weight:bold;">
                    <span>${d.name}</span>
                    <span>Â¥${d.totalPay.toLocaleString()}</span>
                </div>
                <span class="receipt-detail">- ã‚¬ã‚½ãƒªãƒ³: Â¥${d.gasCost.toLocaleString()}</span>
                <span class="receipt-detail">- èª¿æ•´è²»: Â¥${d.reward.toLocaleString()}</span>
                ${extrasHtml}
            </div>
        `;
        dList.appendChild(row);
    });

    document.getElementById('resCircleExpense').textContent = "Â¥" + (totalExtrasClub + totalReward).toLocaleString();
    document.getElementById('resGasSurplus').textContent = "-Â¥" + surplus.toLocaleString();
    document.getElementById('resWithdraw').textContent = "Â¥" + circleNeed.toLocaleString();
    
    const resultArea = document.getElementById('resultArea');
    resultArea.style.display = 'block';
    resultArea.classList.add('active');

    // Only scroll and show toast if button was clicked
    if (!silent) {
        resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
        saveToHistory();
        showToast("âœ… è¨ˆç®—å®Œäº†");
    }

    let lineText = `ã€ç²¾ç®—å ±å‘Š â›°ï¸ã€‘\n`;
    lineText += `â– å¾´åé¡ï¼ˆ1äººã‚ãŸã‚Šï¼‰\n${perPersonPay.toLocaleString()}å††\n`;
    if(isOrgFree) lineText += `ï¼ˆâ€»ä¼ç”»è€…ã¯å…é™¤ï¼‰\n`;
    
    lineText += `\nâ– ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¸ã®æ”¯æ‰•é¡\n`;
    driverResults.forEach(d => {
        lineText += `ãƒ»${d.name}ã•ã‚“ï¼š${d.totalPay.toLocaleString()}å††\n`;
        lineText += `  - ã‚¬ã‚½ãƒªãƒ³ä»£: ${d.gasCost.toLocaleString()}\n`;
        d.extras.forEach(ex => {
            const typeStr = ex.type === 'split' ? '(å‰²å‹˜)' : '(éƒ¨è²»)';
            lineText += `  - ${ex.name || 'è«¸çµŒè²»'}${typeStr}: ${parseInt(ex.amount).toLocaleString()}\n`;
        });
        lineText += `  - èª¿æ•´è²»: ${d.reward.toLocaleString()}\n`;
    });
    
    lineText += `\nâ– ã‚µãƒ¼ã‚¯ãƒ«ä¼šè¨ˆæ”¯å‡ºï¼š${circleNeed.toLocaleString()}å††\n`;
    if(surplus > 0) lineText += `(ç«¯æ•°ä½™å‰° ${surplus}å††å……å½“æ¸ˆã¿)\n`;
    lineText += `\nâ–¼è¨ˆç®—ãƒ»ç·¨é›†URL\n${window.location.href}`;
    document.getElementById('copyTextarea').value = lineText;
}

function copyRoomLink() {
    const url = window.location.href;
    if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => showToast("URLã‚³ãƒ”ãƒ¼å®Œäº†"));
    } else {
        const ta = document.createElement("textarea"); ta.value = url; document.body.appendChild(ta);
        ta.select(); document.execCommand("copy"); document.body.removeChild(ta);
        showToast("URLã‚³ãƒ”ãƒ¼å®Œäº†");
    }
}
function shareToLine() {
    window.open(`https://line.me/R/msg/text/?${encodeURIComponent("ç²¾ç®—ãƒ„ãƒ¼ãƒ«ã®ãƒªãƒ³ã‚¯ã§ã™\n" + window.location.href)}`, '_blank');
}
function copyToClipboard() {
    document.getElementById('copyTextarea').select(); document.execCommand('copy');
    showToast("ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
}
function showToast(msg) {
    const toast = document.getElementById("toast");
    toast.innerHTML = `<i class='fa-solid fa-circle-check'></i> <span>${msg}</span>`;
    toast.className = "show";
    setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
}
</script>
</body>
</html>
