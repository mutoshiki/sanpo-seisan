<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å±±æ­©ä¼šä¼šè¨ˆç²¾ç®—ãƒ„ãƒ¼ãƒ« v5.1</title>
<link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
<style>
:root {
    /* ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ: è½ã¡ç€ã„ãŸãƒ¢ãƒ€ãƒ³ãªé…è‰² */
    --primary: #2e7d32;      /* æ·±ã‚ã®ç·‘ */
    --primary-light: #e8f5e9;
    --accent: #f57f17;       /* è­¦å‘Šãƒ»å¼·èª¿ç”¨ã®ã‚ªãƒ¬ãƒ³ã‚¸ */
    --danger: #c62828;
    --danger-bg: #ffebee;
    --text-main: #1a202c;
    --text-sub: #4a5568;
    --bg: #f0f2f5;           /* èƒŒæ™¯ã‚’å°‘ã—ã‚°ãƒ¬ãƒ¼ã« */
    --card-bg: #ffffff;
    --border: #e2e8f0;
    --radius: 12px;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    
    /* LINEã‚«ãƒ©ãƒ¼ */
    --line-color: #06c755;
}

@media (prefers-color-scheme: dark) {
    :root {
        --primary: #66bb6a;
        --primary-light: #2d3748;
        --accent: #ffb74d;
        --danger: #ef5350;
        --danger-bg: #3e2723;
        --text-main: #f7fafc;
        --text-sub: #a0aec0;
        --bg: #171923;
        --card-bg: #2d3748;
        --border: #4a5568;
    }
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    margin: 0; padding: 20px 12px;
    background: var(--bg); color: var(--text-main);
    line-height: 1.6; font-size: 15px;
}

.container { max-width: 600px; margin: 0 auto; padding-bottom: 100px; }

/* --- ãƒ˜ãƒƒãƒ€ãƒ¼å‘¨ã‚Š --- */
header { text-align: center; margin-bottom: 24px; }
h1 { 
    font-size: 1.4rem; margin: 0; color: var(--primary); 
    display: flex; align-items: center; justify-content: center; gap: 8px;
    font-weight: 800;
}
h1 i { font-size: 1.6rem; }
h1 span { font-size: 0.8rem; color: var(--text-sub); font-weight: normal; margin-top: 4px; display: block;}

.room-badge {
    background: var(--text-main); color: var(--bg);
    padding: 8px 16px; border-radius: 30px; font-family: monospace; font-size: 1rem;
    margin: 16px auto; display: inline-flex; align-items: center; gap: 8px; cursor: pointer;
    box-shadow: var(--shadow); transition: transform 0.1s;
}
.room-badge:active { transform: scale(0.96); }
.room-badge i { font-size: 1.2rem; }
.room-badge-text { display: flex; flex-direction: column; line-height: 1.1; text-align: left; }
.room-badge-label { font-size: 0.65rem; opacity: 0.7; font-family: sans-serif; }

.sync-status {
    font-size: 0.75rem; color: var(--primary); font-weight: 600;
    display: flex; align-items: center; justify-content: center; gap: 4px;
    margin-top: 8px;
}
.sync-dot { width: 8px; height: 8px; background: currentColor; border-radius: 50%; display: inline-block; animation: pulse 2s infinite; }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

/* --- å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ --- */
.card {
    background: var(--card-bg); padding: 20px; border-radius: var(--radius);
    box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid var(--border);
}

h2 { 
    font-size: 1.1rem; margin: 0 0 16px 0; 
    display: flex; align-items: center; gap: 8px; 
    color: var(--text-main); border-bottom: 1px solid var(--border); padding-bottom: 10px;
}
h2 i { color: var(--primary); font-size: 1.3rem; }

/* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
.input-group { margin-bottom: 16px; }
label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 6px; color: var(--text-sub); }

input[type="number"], input[type="text"], select {
    width: 100%; padding: 12px; 
    border: 1px solid var(--border); border-radius: 8px; 
    font-size: 16px; background: var(--bg); color: var(--text-main);
    transition: 0.2s;
}
input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.15); }

.flex-row { display: flex; gap: 12px; }
.flex-row > div { flex: 1; }

/* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ */
.checkbox-card {
    display: flex; align-items: center; justify-content: space-between;
    background: var(--bg); padding: 12px 16px; border-radius: 8px; 
    cursor: pointer; user-select: none; border: 1px solid var(--border);
}
.checkbox-card input { display: none; }
.toggle-switch {
    width: 40px; height: 22px; background: #cbd5e0; border-radius: 20px; position: relative; transition: 0.3s;
}
.toggle-switch::after {
    content: ''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px;
    background: white; border-radius: 50%; transition: 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.2);
}
.checkbox-card input:checked + .toggle-switch { background: var(--primary); }
.checkbox-card input:checked + .toggle-switch::after { transform: translateX(18px); }

/* è»Šä¸¡ã‚«ãƒ¼ãƒ‰ */
.car-card {
    border: 1px solid var(--border); border-radius: 10px; margin-bottom: 12px;
    background: var(--card-bg); overflow: hidden;
}
.car-header {
    background: var(--bg); padding: 12px 16px;
    display: flex; justify-content: space-between; align-items: center;
    cursor: pointer; font-weight: 600; font-size: 0.95rem;
}
.car-header i { margin-right: 6px; color: var(--text-sub); }
.car-body { padding: 16px; display: none; border-top: 1px solid var(--border); }
.car-card.open .car-body { display: block; }
.toggle-icon { transition: transform 0.3s; font-size: 1.2rem; }
.car-card.open .toggle-icon { transform: rotate(180deg); }

.btn-icon-only {
    background: none; border: none; color: var(--danger); font-size: 1.2rem; 
    cursor: pointer; padding: 4px; display: flex; align-items: center;
}

/* è«¸çµŒè²»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.extra-section { 
    background: var(--bg); padding: 12px; border-radius: 8px; margin-top: 16px; 
    border: 1px dashed var(--border); 
}
.extra-item { display: flex; gap: 8px; margin-bottom: 8px; align-items: center;}

/* ãƒœã‚¿ãƒ³é¡ */
.btn {
    width: 100%; border: none; border-radius: 50px; font-size: 1rem; font-weight: 700;
    padding: 14px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
    text-decoration: none;
}
.btn-primary { 
    background: var(--primary); color: white; margin-top: 10px; 
    box-shadow: 0 4px 10px rgba(46, 125, 50, 0.3);
}
.btn-primary:active { transform: scale(0.98); }
.btn-outline { 
    background: transparent; border: 2px dashed var(--border); color: var(--primary); 
    padding: 12px; font-weight: 600;
}
.btn-outline:hover { background: var(--primary-light); border-color: var(--primary); }
.btn-sm { padding: 6px 12px; font-size: 0.85rem; width: auto; display: inline-flex; border-radius: 6px; }

/* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆå¤§å¹…æ”¹ä¿®ï¼‰ */
#resultArea { display: none; }
.result-card { border-top: 5px solid var(--primary); }

.total-payment-box {
    text-align: center; padding: 20px 0; border-bottom: 1px solid var(--border); margin-bottom: 20px;
}
.total-payment-label { font-size: 0.85rem; color: var(--text-sub); margin-bottom: 8px; display: block; }
.total-payment-amount { 
    font-size: 2.5rem; font-weight: 800; color: var(--primary); line-height: 1; letter-spacing: -1px;
}
.payment-detail-note { font-size: 0.75rem; color: var(--text-sub); margin-top: 8px; }

/* ãƒ‰ãƒ©ã‚¤ãƒãƒ¼æ”¯æ‰•ã„ã‚«ãƒ¼ãƒ‰ */
.driver-card {
    background: var(--bg); border-radius: 8px; padding: 15px; margin-bottom: 12px;
    border-left: 4px solid var(--text-sub);
}
.driver-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.05); }
.driver-name { font-weight: 700; font-size: 1.05rem; display: flex; align-items: center; gap: 6px; }
.driver-amount { font-size: 1.2rem; font-weight: 800; color: var(--text-main); }
.detail-row { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-sub); margin-bottom: 4px; }
.detail-row.sub { padding-left: 10px; border-left: 2px solid var(--border); margin-top: 4px; }

/* ä¼šè¨ˆã‚µãƒãƒªãƒ¼ */
.accounting-summary {
    margin-top: 24px; padding-top: 16px; border-top: 2px dashed var(--border);
}
.summary-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 6px; }
.summary-row.highlight { color: var(--danger); font-weight: bold; font-size: 1rem; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); }

/* ã‚³ãƒ”ãƒ¼ã‚¨ãƒªã‚¢ */
.copy-area {
    background: #2d3748; color: white; padding: 15px; border-radius: 8px; margin-top: 20px;
}
#copyTextarea { width: 100%; background: transparent; border: none; color: #e2e8f0; font-family: monospace; height: 120px; resize: none; font-size: 0.8rem; outline: none; }
.btn-copy { background: #4a5568; color: white; padding: 10px; width: 100%; border: none; border-radius: 6px; margin-top: 10px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }

/* å±¥æ­´ãƒªã‚¹ãƒˆ */
.history-container { margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px; }
.history-item { 
    background: var(--card-bg); padding: 10px 14px; border-radius: 8px; margin-bottom: 8px;
    display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border);
}
.history-meta { font-size: 0.75rem; color: var(--text-sub); }
.btn-restore { background: var(--primary); color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; }

/* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
#toast {
    visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center;
    border-radius: 50px; padding: 14px; position: fixed; z-index: 100; left: 50%; bottom: 30px;
    transform: translateX(-50%); font-size: 0.9rem; opacity: 0; transition: opacity 0.3s, bottom 0.3s;
    display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
#toast.show { visibility: visible; opacity: 1; bottom: 50px; }

</style>
</head>
<body>

<div class="container">
    <header>
        <h1><i class='bx bxs-landscape'></i> å±±æ­©ä¼š ç²¾ç®—ãƒ„ãƒ¼ãƒ«<span>v5.1</span></h1>
        
        <div class="room-badge" onclick="copyRoomLink()">
            <i class='bx bx-id-card'></i>
            <div class="room-badge-text">
                <span class="room-badge-label">Room ID</span>
                <span id="dispRoomId">...</span>
            </div>
            <i class='bx bx-copy' style="font-size: 0.9rem; opacity: 0.5; margin-left: 4px;"></i>
        </div>

        <div class="sync-status">
            <span class="sync-dot"></span>
            <span id="syncText">åŒæœŸä¸­...</span>
        </div>
    </header>

    <div class="card" style="background: var(--primary-light); border-color: transparent;">
        <h3 style="margin:0 0 10px 0; font-size:0.95rem; color: var(--primary); display: flex; align-items: center; gap: 6px;">
            <i class='bx bx-info-circle'></i> ä½¿ã„æ–¹
        </h3>
        <ul style="margin: 0; padding-left: 20px; font-size: 0.85rem; color: var(--text-sub);">
            <li>å‚åŠ äººæ•°ã€è»Šå‡ºã—ã—ã¦ãã‚ŒãŸæ–¹ã®æƒ…å ±ã‚’å…¥åŠ›ã—ã¾ã™ã€‚</li>
            <li>ã€Œç²¾ç®—ã‚’å®Ÿè¡Œã€ã‚’æŠ¼ã™ã¨1äººã‚ãŸã‚Šã®æ”¯æ‰•é¡ãŒè¨ˆç®—ã•ã‚Œã¾ã™ã€‚</li>
            <li>URLã‚’å…±æœ‰ã™ã‚Œã°ã€è¤‡æ•°äººã§å…±åŒç·¨é›†å‡ºæ¥ã¾ã™ã€‚</li>
        </ul>
    </div>

    <div class="card">
        <h2><i class='bx bxs-car'></i> è»Šä¸¡æƒ…å ±ã®ç™»éŒ²</h2>
        <div id="carList"></div>
        <button class="btn btn-outline" onclick="handleAddCarBtn()">
            <i class='bx bx-plus'></i> è»Šä¸¡ã‚’è¿½åŠ 
        </button>
    </div>

    <div class="card">
        <h2><i class='bx bxs-cog'></i> ç²¾ç®—ã®è¨­å®š</h2>
        
        <div class="input-group">
            <label>ç«¯æ•°å‡¦ç†ï¼ˆåˆ‡ã‚Šä¸Šã’å˜ä½ï¼‰</label>
            <select id="roundingUnit" onchange="pushData()">
                <option value="100" selected>100å††</option>
                <option value="50">50å††</option>
                <option value="10">10å††</option>
                <option value="1">1å††</option>
            </select>
        </div>

        <div class="input-group">
            <label>ä¼ç”»ã®å‚åŠ äººæ•° (ä¼ç”»è€…å«ã‚€)</label>
            <div style="position: relative;">
                <input type="number" id="totalPeople" placeholder="ä¾‹: 4" inputmode="numeric" oninput="pushData()" style="padding-left: 40px;">
                <i class='bx bxs-user-detail' style="position: absolute; left: 12px; top: 13px; color: var(--text-sub);"></i>
            </div>
        </div>
        
        <label class="checkbox-card">
            <span>ä¼ç”»è€…ã¯ã‚¬ã‚½ãƒªãƒ³ä»£ã‚’æ”¯æ‰•ã‚ãªã„</span>
            <input type="checkbox" id="organizerFree" onchange="pushData()">
            <div class="toggle-switch"></div>
        </label>
    </div>

    <button class="btn btn-primary" onclick="calculate()">
        <i class='bx bxs-calculator'></i> ç²¾ç®—ã‚’å®Ÿè¡Œã™ã‚‹
    </button>

    <div id="resultArea">
        <div class="card result-card" style="margin-top: 30px;">
            <div class="total-payment-box">
                <span class="total-payment-label">1äººã‚ãŸã‚Šã®å¾´åé¡ï¼ˆã‚¬ã‚½ãƒªãƒ³ä»£ï¼‰</span>
                <span class="total-payment-amount" id="resPerPerson">0<small style="font-size:1rem; font-weight:normal;">å††</small></span>
                <div class="payment-detail-note" id="resTargetDetail">--</div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="margin-bottom:12px; display:flex; align-items:center; gap:6px;">
                    <i class='bx bxs-wallet-alt'></i> ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¸ã®æ”¯æ‰•ã„
                </label>
                <div id="resDriverList"></div>
            </div>

            <div class="accounting-summary">
                <label style="margin-bottom:10px; display:block; font-size:0.85rem; font-weight:bold; color:var(--text-sub);">
                    <i class='bx bxs-bank'></i> ã‚µãƒ¼ã‚¯ãƒ«ä¼šè¨ˆæƒ…å ±
                </label>
                <div class="summary-row">
                    <span>çµŒè²»ãƒ»èª¿æ•´è²»ã®åˆè¨ˆ</span>
                    <span id="resCircleExpense">0å††</span>
                </div>
                <div class="summary-row" style="color: var(--primary);">
                    <span>ç«¯æ•°èª¿æ•´ã®ä½™ã‚Šï¼ˆã‚µãƒ¼ã‚¯ãƒ«è²»ã¸ï¼‰</span>
                    <span id="resGasSurplus">0å††</span>
                </div>
                <div class="summary-row highlight">
                    <span>ä¼šè¨ˆã‹ã‚‰ã®å®Ÿæ”¯å‡º</span>
                    <span id="resWithdraw">0å††</span>
                </div>
            </div>
        </div>

        <div class="copy-area">
            <h3 style="margin:0 0 10px 0; font-size:1rem; display:flex; align-items:center; gap:8px;">
                <i class='bx bxl-whatsapp'></i> ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ãƒ†ã‚­ã‚¹ãƒˆ
            </h3>
            <textarea id="copyTextarea" readonly></textarea>
            <div style="display: flex; gap: 10px;">
                <button class="btn-copy" onclick="copyToClipboard()">
                    <i class='bx bx-copy'></i> ã‚³ãƒ”ãƒ¼
                </button>
                <a id="btnLineShare" href="#" target="_blank" class="btn" style="background: #06c755; color: white; display: none;">
                    <i class='bx bxl-line' style="font-size:1.2rem;"></i> LINEã§é€ã‚‹
                </a>
            </div>
        </div>
    </div>

    <div class="history-container">
        <details>
            <summary style="cursor: pointer; color: var(--text-sub); font-weight: bold; outline:none;">
                <i class='bx bx-history'></i> è¨ˆç®—å±¥æ­´ (ä¿å­˜æ¸ˆã¿)
            </summary>
            <div style="margin-top: 15px;">
                <ul id="historyList" style="list-style: none; padding: 0;">
                    <li style="text-align:center; color:var(--text-sub); padding:10px; font-size:0.85rem;">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</li>
                </ul>
                <button class="btn btn-outline btn-sm" style="width:100%; margin-top:10px; font-weight:normal;" onclick="resetRoom()">
                    <i class='bx bx-trash'></i> å…¥åŠ›ã‚’å…¨ã¦ã‚¯ãƒªã‚¢
                </button>
            </div>
        </details>
    </div>
<div style="margin-top: 40px; text-align: center; border-top: 1px dashed var(--border); padding-top: 20px;">
        <button class="btn btn-sm" style="background: #718096; color: white; width: auto; margin: 0 auto;" onclick="fillTestData()">
            <i class='bx bx-test-tube'></i> ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥
        </button>
        <p style="font-size: 0.7rem; color: var(--text-sub); margin-top: 8px;">
            â€»æ—¢å­˜ã®å…¥åŠ›ã¯å…¨ã¦ä¸Šæ›¸ãã•ã‚Œã¾ã™
        </p>
    </div>

</div>

</div>

<div id="toast"><i class='bx bx-check-circle'></i> <span>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</span></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAypqRPRn-YHWLwjT3lQ6pN6_bWBqzUvp4",
  authDomain: "sanpo-seisan.firebaseapp.com",
  databaseURL: "https://sanpo-seisan-default-rtdb.firebaseio.com",
  projectId: "sanpo-seisan",
  storageBucket: "sanpo-seisan.firebasestorage.app",
  messagingSenderId: "709215338656",
  appId: "1:709215338656:web:c2b0dbc9aceb0fa60f89c5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// URLã‹ã‚‰ãƒ«ãƒ¼ãƒ IDå–å¾—
let roomId = new URLSearchParams(window.location.search).get("room");
if (!roomId) {
    roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
    const newUrl = window.location.pathname + "?room=" + roomId;
    window.history.replaceState(null, null, newUrl);
}
document.getElementById('dispRoomId').textContent = roomId;

const roomRef = ref(db, 'sessions/' + roomId);

// ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¸ã®ç´ä»˜ã‘
window.pushData = debounce(pushDataToFirebase, 500);
window.handleAddCarBtn = handleAddCarBtn;
window.resetRoom = resetRoom;
window.loadFromHistory = loadFromHistory;
window.deleteHistory = deleteHistory;
window.fillTestData = fillTestData;

// åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«å±¥æ­´è¡¨ç¤º
renderHistoryList();

// FirebaseåŒæœŸ
onValue(roomRef, (snapshot) => {
    const data = snapshot.val();
    const syncText = document.getElementById("syncText");
    
    if (data) {
        syncText.textContent = "åŒæœŸå®Œäº†";
        renderForm(data);
    } else {
        syncText.textContent = "æ–°è¦ãƒ«ãƒ¼ãƒ ";
        if(document.getElementById('carList').children.length === 0) {
            addCarToDOM(null, 0, true);
        }
    }
});

function renderForm(data) {
    setValIfDiff('totalPeople', data.total);
    setCheckIfDiff('organizerFree', data.org);
    setValIfDiff('roundingUnit', data.rounding);

    const carList = document.getElementById('carList');
    const remoteCars = data.cars || [];
    const currentCards = carList.getElementsByClassName('car-card');
    
    while(currentCards.length < remoteCars.length) {
        addCarToDOM(null, currentCards.length, true);
    }
    while(currentCards.length > remoteCars.length) {
        carList.removeChild(carList.lastChild);
    }

    Array.from(currentCards).forEach((card, i) => {
        const cData = remoteCars[i];
        
        const inputs = {
            name: card.querySelector('.inp-name'),
            dist: card.querySelector('.inp-dist'),
            eco: card.querySelector('.inp-eco'),
            price: card.querySelector('.inp-price')
        };
        
        if(document.activeElement !== inputs.name) inputs.name.value = cData.name || "";
        if(document.activeElement !== inputs.dist) inputs.dist.value = cData.dist || "";
        if(document.activeElement !== inputs.eco) inputs.eco.value = cData.eco || "";
        if(document.activeElement !== inputs.price) inputs.price.value = cData.price || "";
        
        const title = card.querySelector('.car-title-text');
        const dName = cData.name || `è»Šä¸¡ ${i + 1}`;
        title.innerHTML = `<i class='bx bxs-car'></i> ${dName}`;

        const extrasBox = card.querySelector('.extra-section div[id^="extras-"]');
        if(!extrasBox) return;

        const remoteExtras = cData.extras || [];
        const currentExtras = extrasBox.getElementsByClassName('extra-item');

        while(currentExtras.length < remoteExtras.length) {
            addExtraToDOM(extrasBox, "", "");
        }
        while(currentExtras.length > remoteExtras.length) {
            extrasBox.removeChild(extrasBox.lastChild);
        }

        Array.from(currentExtras).forEach((row, j) => {
            const exData = remoteExtras[j];
            const nameInp = row.querySelector('.ex-name');
            const amtInp = row.querySelector('.ex-amount');
            
            if(document.activeElement !== nameInp) nameInp.value = exData.name || "";
            if(document.activeElement !== amtInp) amtInp.value = exData.amount || "";
        });
    });
}

function setValIfDiff(id, val) {
    const el = document.getElementById(id);
    if (el && document.activeElement !== el && el.value != val) {
        el.value = val || "";
    }
}
function setCheckIfDiff(id, val) {
    const el = document.getElementById(id);
    if (el && el.checked != val) {
        el.checked = val || false;
    }
}

function pushDataToFirebase() {
    const data = getFormData();
    document.getElementById("syncText").textContent = "ä¿å­˜ä¸­...";
    set(roomRef, data).then(() => {
        document.getElementById("syncText").textContent = "åŒæœŸå®Œäº†";
    }).catch((e) => {
        document.getElementById("syncText").textContent = "ã‚¨ãƒ©ãƒ¼";
        console.error(e);
    });
}

function debounce(func, wait) {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
    };
}

function getFormData() {
    const cards = document.querySelectorAll('.car-card');
    const carDatas = Array.from(cards).map(card => ({
        name: card.querySelector('.inp-name').value, 
        dist: card.querySelector('.inp-dist').value,
        eco: card.querySelector('.inp-eco').value, 
        price: card.querySelector('.inp-price').value,
        extras: Array.from(card.querySelectorAll('.extra-item')).map(row => ({ 
            name: row.querySelector('.ex-name').value, 
            amount: row.querySelector('.ex-amount').value 
        }))
    }));
    return {
        total: document.getElementById('totalPeople').value,
        org: document.getElementById('organizerFree').checked,
        rounding: document.getElementById('roundingUnit').value,
        cars: carDatas,
        updatedAt: Date.now()
    };
}

function resetRoom() {
    if(confirm("å…¨ã¦ã®å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ç”»é¢ã‹ã‚‰ã‚‚æ¶ˆãˆã¾ã™ï¼‰")) {
        set(roomRef, null).then(() => {
            window.location.reload();
        });
    }
}

// ... æ—¢å­˜ã®ç´ä»˜ã‘ã‚³ãƒ¼ãƒ‰ã®ä¸‹ã«è¿½åŠ  ...
window.deleteHistory = deleteHistory;
window.fillTestData = fillTestData; // â˜…ã“ã‚Œã‚’è¿½åŠ 

// ... (ä¸­ç•¥) ...

// â˜…ã“ã®é–¢æ•°ã‚’ãƒ–ãƒ­ãƒƒã‚¯å†…ã®é©å½“ãªå ´æ‰€ï¼ˆresetRoomé–¢æ•°ã®ä¸‹ãªã©ï¼‰ã«è¿½åŠ ã—ã¦ãã ã•ã„
function fillTestData() {
    if(!confirm("ç¾åœ¨ã®å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¾ã™ã‹ï¼Ÿ")) return;

    // 1. æ—¢å­˜ã®è»Šä¸¡ã‚’ã‚¯ãƒªã‚¢
    document.getElementById('carList').innerHTML = "";

    // 2. åŸºæœ¬è¨­å®šã®å…¥åŠ›
    const totalPeople = 11; // ä¼ç”»è€…1 + 10äºº
    document.getElementById('totalPeople').value = totalPeople;
    document.getElementById('roundingUnit').value = "100";
    document.getElementById('organizerFree').checked = true;

    // 3. ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å®šç¾©
    const testData = [
        { name: "å±±ç”°å¤ªéƒ", dist: [180, 220], eco: [12, 16], price: [165, 175], extras: [["é«˜é€Ÿä»£", 4500], ["é§è»Šå ´", 1000]] },
        { name: "éˆ´æœ¨ä¸€éƒ", dist: [180, 220], eco: [20, 25], price: [160, 170], extras: [["é«˜é€Ÿä»£", 3800], ["ã‚¢ã‚¤ã‚¹ä»£", 800]] },
        { name: "ä½è—¤èŠ±å­", dist: [190, 230], eco: [15, 19], price: [168, 178], extras: [["æœ‰æ–™é“è·¯", 1200], ["æ¸©æ³‰ä»£", 2400]] }
    ];

    // ãƒ©ãƒ³ãƒ€ãƒ æ•°å€¤ç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼
    const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

    // 4. è»Šä¸¡ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆã¨DOMæŠ•å…¥
    testData.forEach((d, i) => {
        // è»Šä¸¡ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ï¼ˆå¼·åˆ¶ã‚ªãƒ¼ãƒ—ãƒ³ï¼‰
        addCarToDOM(null, -1, true);
        
        // è¿½åŠ ã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã‚’å–å¾—
        const card = document.getElementById('carList').lastElementChild;
        
        // åŸºæœ¬æƒ…å ±ã®å…¥åŠ›
        card.querySelector('.inp-name').value = d.name;
        card.querySelector('.inp-dist').value = rand(d.dist[0], d.dist[1]);
        card.querySelector('.inp-eco').value  = rand(d.eco[0], d.eco[1]);
        card.querySelector('.inp-price').value = rand(d.price[0], d.price[1]);

        // è«¸çµŒè²»ã®å…¥åŠ›
        const extraBox = card.querySelector('.extra-section > div'); // IDä»˜ãã®divã‚’å–å¾—
        d.extras.forEach(ex => {
            addExtraToDOM(extraBox, ex[0], ex[1]);
        });
    });

    // 5. ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦é€šçŸ¥
    pushDataToFirebase();
    showToast("ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¾ã—ãŸ");
    
    // è¨ˆç®—çµæœã‚¨ãƒªã‚¢ãŒé–‹ã„ã¦ã„ãŸã‚‰é–‰ã˜ã¦ãŠãï¼ˆå†è¨ˆç®—ã‚’ä¿ƒã™ãŸã‚ï¼‰
    document.getElementById('resultArea').style.display = 'none';
}

// å±¥æ­´ä¿å­˜æ©Ÿèƒ½
function saveToHistory() {
    const data = getFormData();
    // æœ€ä½é™ã®å…¥åŠ›ãƒã‚§ãƒƒã‚¯
    if(!data.total && data.cars.length === 1 && !data.cars[0].dist) return;
    
    const history = JSON.parse(localStorage.getItem('sanpo_history_v5') || "[]");
    
    // ç›´è¿‘ã®å±¥æ­´ã¨åŒã˜ãªã‚‰ä¿å­˜ã—ãªã„
    if(history.length > 0) {
        const last = history[0].data;
        if(JSON.stringify(last) === JSON.stringify(data)) return; 
    }

    const summary = `${data.total || "?"}å / è»Š${data.cars.length}å°`;
    history.unshift({ 
        date: new Date().toLocaleString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' }), 
        summary: summary,
        data: data 
    });
    
    localStorage.setItem('sanpo_history_v5', JSON.stringify(history.slice(0, 10)));
    renderHistoryList();
}

function renderHistoryList() {
    const list = document.getElementById('historyList');
    const history = JSON.parse(localStorage.getItem('sanpo_history_v5') || "[]");
    
    if (history.length === 0) {
        list.innerHTML = `<li style="text-align:center; color:var(--text-sub); padding:10px; font-size:0.8rem;">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</li>`;
        return;
    }

    list.innerHTML = "";
    history.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = 'history-item';
        li.innerHTML = `
            <div>
                <span class="history-meta">${item.date}</span>
                <div style="font-weight:600; font-size:0.9rem;">${item.summary}</div>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn-restore" onclick="loadFromHistory(${index})">å¾©å…ƒ</button>
                <button class="btn-icon-only" style="color:var(--text-sub); font-size:1rem;" onclick="deleteHistory(${index})"><i class='bx bx-x'></i></button>
            </div>
        `;
        list.appendChild(li);
    });
}

function loadFromHistory(index) {
    if(!confirm("ç¾åœ¨ã®å…¥åŠ›ã‚’ä¸Šæ›¸ãã—ã¦å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")) return;
    const history = JSON.parse(localStorage.getItem('sanpo_history_v5') || "[]");
    const item = history[index];
    if(item && item.data) {
        set(roomRef, item.data).then(() => {
            showToast("ğŸ“‚ å±¥æ­´ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸ");
        });
    }
}

function deleteHistory(index) {
    if(!confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    const history = JSON.parse(localStorage.getItem('sanpo_history_v5') || "[]");
    history.splice(index, 1);
    localStorage.setItem('sanpo_history_v5', JSON.stringify(history));
    renderHistoryList();
}


function handleAddCarBtn() {
    addCarToDOM();
    pushDataToFirebase();
}

window.addCarToDOM = function(data = null, idx = -1, forceOpen = false) {
    const list = document.getElementById('carList');
    if (idx === -1) idx = list.children.length;
    
    if(list.children[idx]) return;

    const div = document.createElement('div');
    const isOpen = forceOpen ? 'open' : 'open';
    div.className = `car-card ${isOpen}`;
    const onInput = `oninput="window.pushData()"`;
    const extrasId = `extras-${Date.now()}-${Math.random().toString(36).substr(2,5)}`;

    /* ä¿®æ­£ç®‡æ‰€: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å…·ä½“çš„ãªæ•°å€¤ä¾‹ã«å¤‰æ›´
    */
    div.innerHTML = `
        <div class="car-header" onclick="this.parentElement.classList.toggle('open')">
            <span class="car-title-text"><i class='bx bxs-car'></i> è»Šä¸¡ ${idx + 1}</span>
            <div style="display:flex; align-items:center; gap:8px;">
                <button class="btn-icon-only" onclick="removeCar(event, this)" title="å‰Šé™¤"><i class='bx bx-trash'></i></button>
                <i class='bx bx-chevron-down toggle-icon'></i>
            </div>
        </div>
        <div class="car-body">
            <div class="input-group">
                <label>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼åï¼ˆä»»æ„ï¼‰</label>
                <div style="position:relative;">
                    <i class='bx bx-user' style="position:absolute; left:12px; top:13px; color:var(--text-sub);"></i>
                    <input type="text" class="inp-name" placeholder="æ°å" ${onInput} style="padding-left:36px;">
                </div>
            </div>
            <div class="flex-row">
                <div class="input-group"><label>è·é›¢ (km)<span style="color:var(--danger)">*</span></label><input type="number" class="inp-dist" placeholder="ä¾‹: 240" inputmode="decimal" ${onInput}></div>
                <div class="input-group"><label>ç‡ƒè²» (km/L)<span style="color:var(--danger)">*</span></label><input type="number" class="inp-eco" placeholder="ä¾‹: 15" inputmode="decimal" ${onInput}></div>
                <div class="input-group"><label>ä¾¡æ ¼ (å††)<span style="color:var(--danger)">*</span></label><input type="number" class="inp-price" placeholder="ä¾‹: 160" inputmode="numeric" ${onInput}></div>
            </div>
            <div class="extra-section">
                <label style="margin-bottom:8px; display:block; font-size:0.8rem; color:var(--text-sub);">â• è«¸çµŒè²»ï¼ˆé«˜é€Ÿãƒ»é§è»Šå ´ä»£ãªã©ï¼‰</label>
                <div id="${extrasId}"></div>
                <button class="btn-reset" style="background:none; border:none; color:var(--primary); font-size:0.8rem; cursor:pointer; padding:0; margin-top:5px; font-weight:bold;" onclick="handleAddExtra(this)">
                    + çµŒè²»ã‚’è¿½åŠ 
                </button>
            </div>
        </div>
    `;
    list.appendChild(div);
}

window.removeCar = function(e, btn){ 
    e.stopPropagation(); 
    if(confirm("ã“ã®è»Šä¸¡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { 
        btn.closest('.car-card').remove(); 
        pushDataToFirebase();
    } 
}

window.handleAddExtra = function(btn) {
    const box = btn.previousElementSibling;
    addExtraToDOM(box);
    pushDataToFirebase();
}

function addExtraToDOM(container, name="", amount="") {
    const div = document.createElement('div');
    div.className = 'extra-item';
    div.innerHTML = `
        <input type="text" class="ex-name" placeholder="é …ç›®" value="${name}" style="flex:2; padding:10px;" oninput="window.pushData()">
        <input type="number" class="ex-amount" placeholder="å††" value="${amount}" style="flex:1; padding:10px;" inputmode="numeric" oninput="window.pushData()">
        <button class="btn-icon-only" style="color:var(--text-sub);" onclick="this.parentElement.remove(); window.pushData();"><i class='bx bx-x'></i></button>
    `;
    container.appendChild(div);
}

window.calculate = function() {
    const data = getFormData();
    const totalPeople = parseInt(data.total);
    const isOrgFree = data.org;
    
    let errorMsgs = [];
    if (!totalPeople || totalPeople <= 0) errorMsgs.push("å‚åŠ äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    if (data.cars.length === 0) errorMsgs.push("è»Šä¸¡ãŒ1å°ã‚‚ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“");

    data.cars.forEach((c, index) => {
        const dName = c.name || `è»Šä¸¡ ${index + 1}`;
        if(!c.dist) errorMsgs.push(`${dName}: èµ°è¡Œè·é›¢ãŒæœªå…¥åŠ›ã§ã™`);
        if(!c.eco) errorMsgs.push(`${dName}: ç‡ƒè²»ãŒæœªå…¥åŠ›ã§ã™`);
        if(!c.price) errorMsgs.push(`${dName}: ã‚¬ã‚½ãƒªãƒ³ä¾¡æ ¼ãŒæœªå…¥åŠ›ã§ã™`);
    });

    if (errorMsgs.length > 0) { alert("âš ï¸ ã‚¨ãƒ©ãƒ¼:\nãƒ»" + errorMsgs.join("\nãƒ»")); return; }

    let totalGas = 0; let totalExtras = 0; let totalReward = 0;
    let driverResults = []; 

    data.cars.forEach((c) => {
        const name = c.name || "ãƒ‰ãƒ©ã‚¤ãƒãƒ¼";
        const dist = parseFloat(c.dist) || 0;
        const eco = parseFloat(c.eco) || 1;
        const price = parseFloat(c.price) || 0;
        const gasCost = Math.round((dist / eco) * price);
        
        let extrasTotal = 0; 
        let exs = [];
        c.extras.forEach(ex => {
            const val = parseInt(ex.amount) || 0;
            const nm = ex.name || "è«¸çµŒè²»";
            if(val > 0) { extrasTotal += val; exs.push({name: nm, amount: val}); }
        });

        const reward = 1000; 
        totalGas += gasCost; 
        totalExtras += extrasTotal; 
        totalReward += reward;

        driverResults.push({
            name,
            totalPay: gasCost + extrasTotal + reward,
            gasCost,
            reward,
            extras: exs,
            extrasTotal
        });
    });

    const payers = isOrgFree ? (totalPeople - 1) : totalPeople;
    const roundUnit = parseInt(data.rounding);
    const perPersonGas = payers > 0 ? Math.ceil((totalGas / payers) / roundUnit) * roundUnit : 0;
    
    const collectedGasTotal = perPersonGas * payers;
    const gasSurplus = collectedGasTotal - totalGas;
    const circleNeed = (totalExtras + totalReward) - gasSurplus;

    // --- çµæœè¡¨ç¤º (DOMæ›´æ–°) ---
    document.getElementById('resPerPerson').innerHTML = perPersonGas.toLocaleString() + "<small style='font-size:1rem; font-weight:normal;'> å††</small>";
    document.getElementById('resTargetDetail').innerHTML = `å¾´åå¯¾è±¡ï¼š${payers}å / å®Ÿè²»åˆè¨ˆï¼š${totalGas.toLocaleString()}å†† (ç«¯æ•°${roundUnit}å††)`;
    
    const dList = document.getElementById('resDriverList'); 
    dList.innerHTML = "";
    driverResults.forEach(d => {
        const row = document.createElement('div'); 
        row.className = 'driver-card';
        
        // â˜…ä¿®æ­£ç®‡æ‰€: è«¸çµŒè²»ã‚’ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã›ãšã€åŒåˆ—ã®è¡Œã¨ã—ã¦ç”Ÿæˆã™ã‚‹
        let extrasHtml = "";
        if(d.extras.length > 0) {
            d.extras.forEach(ex => {
                // class="detail-row sub" ã§ã¯ãªã class="detail-row" ã«çµ±ä¸€
                extrasHtml += `<div class="detail-row"><span>${ex.name}</span><span>${ex.amount.toLocaleString()}å††</span></div>`;
            });
        }

        row.innerHTML = `
            <div class="driver-header">
                <span class="driver-name"><i class='bx bxs-user-circle'></i> ${d.name} <small style="font-weight:normal; font-size:0.8rem; margin-left:4px;">ã•ã‚“</small></span>
                <span class="driver-amount">${d.totalPay.toLocaleString()} å††</span>
            </div>
            <div class="detail-row"><span>ã‚¬ã‚½ãƒªãƒ³ä»£</span><span>${d.gasCost.toLocaleString()}å††</span></div>
            <div class="detail-row"><span>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼èª¿æ•´è²»</span><span>${d.reward.toLocaleString()}å††</span></div>
            ${extrasHtml}
        `;
        dList.appendChild(row);
    });

    document.getElementById('resCircleExpense').textContent = (totalExtras + totalReward).toLocaleString() + " å††";
    document.getElementById('resGasSurplus').textContent = "-" + gasSurplus.toLocaleString() + " å††";
    document.getElementById('resWithdraw').textContent = circleNeed.toLocaleString() + " å††";
    
    const resultArea = document.getElementById('resultArea');
    resultArea.style.display = 'block';
    
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });

    // --- è‡ªå‹•ä¿å­˜ã‚’å®Ÿè¡Œ ---
    saveToHistory();

    // --- LINEç”¨ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ ---
    let lineText = `ã€å±±æ­©ä¼š ç²¾ç®—å ±å‘Š â›°ï¸ã€‘\n`;
    lineText += `â– å¾´åé¡ï¼ˆã‚¬ã‚½ãƒªãƒ³ä»£ï¼‰\n1äººï¼š${perPersonGas.toLocaleString()}å††\n`;
    if(isOrgFree) lineText += `ï¼ˆâ€»ä¼ç”»è€…ã¯å…é™¤ï¼‰\n`;
    
    lineText += `\nâ– ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¸ã®æ”¯æ‰•é¡\n`;
    driverResults.forEach(d => {
        lineText += `ãƒ»${d.name}ã•ã‚“ï¼š${d.totalPay.toLocaleString()}å††\n`;
        lineText += `  (ã‚¬ã‚¹:${d.gasCost.toLocaleString()} / èª¿æ•´:${d.reward.toLocaleString()}`;
        if (d.extrasTotal > 0) lineText += ` / ç«‹æ›¿:${d.extrasTotal.toLocaleString()}`;
        lineText += `)\n`;
    });
    
    lineText += `\nâ– ã‚µãƒ¼ã‚¯ãƒ«ä¼šè¨ˆã‹ã‚‰ã®æ”¯å‡º\nè¨ˆï¼š${circleNeed.toLocaleString()}å††\n\nãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼`;
    lineText += `\n\nâ–¼è¨ˆç®—ãƒ»ç·¨é›†URL\n${window.location.href}`;

    document.getElementById('copyTextarea').value = lineText;

    const encodedText = encodeURIComponent(lineText);
    const lineBtn = document.getElementById('btnLineShare');
    lineBtn.href = `https://line.me/R/msg/text/?${encodedText}`;
    lineBtn.style.display = 'flex';

    showToast("âœ… ç²¾ç®—å®Œäº†ï¼å±¥æ­´ã«ä¿å­˜ã—ã¾ã—ãŸ");
}

window.copyRoomLink = function() {
    const url = window.location.href;
    if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => showToast("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼"));
    } else {
        const ta = document.createElement("textarea");
        ta.value = url;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        showToast("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
    }
}

window.copyToClipboard = function() {
    const textarea = document.getElementById('copyTextarea');
    textarea.select(); document.execCommand('copy');
    showToast("ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
}

function showToast(msg) {
    const toast = document.getElementById("toast");
    toast.innerHTML = `<i class='bx bx-check-circle'></i> <span>${msg}</span>`;
    toast.className = "show";
    setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
}
</script>
</body>
</html>
