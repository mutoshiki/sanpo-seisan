<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å±±æ­©ä¼šä¼šè¨ˆç²¾ç®—ãƒ„ãƒ¼ãƒ« Pro</title>

<style>
:root {
    --primary: #2e7d32;
    --primary-light: #e8f5e9;
    --accent: #f57c00;
    --danger: #d32f2f;
    --history: #0288d1;
    --text-main: #333333;
    --text-sub: #666666;
    --bg: #f0f2f5;
    --card: #ffffff;
    --radius: 12px;
    --shadow: 0 4px 15px rgba(0,0,0,0.05);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
    margin: 0;
    padding: 20px 15px;
    background: var(--bg);
    color: var(--text-main);
    line-height: 1.6;
    font-size: 16px;
}

.container { max-width: 500px; margin: 0 auto; }
header { text-align: center; margin-bottom: 25px; }
h1 { font-size: 1.4rem; margin: 0; color: var(--primary); display: flex; flex-direction: column; align-items: center; justify-content: center; }
h1 span { font-size: 0.9rem; margin-top: 5px; color: var(--text-sub); font-weight: normal; }

/* æ¡ˆå†…ãƒœãƒƒã‚¯ã‚¹ */
.usage-guide {
    background: #fff8e1;
    border: 1px solid #ffe0b2;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 25px;
    font-size: 0.9rem;
    color: #5d4037;
}
.usage-guide h3 {
    margin: 0 0 8px 0;
    color: #ef6c00;
    font-size: 1rem;
    display: flex; align-items: center; gap: 6px;
}
.usage-guide ul {
    margin: 0; padding-left: 20px;
    font-size: 0.85rem;
}

.card {
    background: var(--card);
    padding: 20px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    margin-bottom: 20px;
}

h2 { font-size: 1.1rem; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px; border-bottom: 2px solid var(--primary-light); padding-bottom: 8px; color: var(--primary); }
.sub-title { font-size: 0.8rem; font-weight: normal; color: var(--text-sub); margin-left: auto; }

.input-group { margin-bottom: 15px; }
label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 6px; color: var(--text-sub); }
input[type="number"], input[type="text"] {
    width: 100%; padding: 12px; border: 1px solid #cfd8dc; border-radius: 8px; font-size: 16px; transition: border 0.2s; background: #fafafa;
}
input:focus { outline: none; border-color: var(--primary); background: #fff; box-shadow: 0 0 0 2px var(--primary-light); }

.flex-row { display: flex; gap: 10px; }
.flex-row > div { flex: 1; }

.checkbox-card {
    display: flex; align-items: center; gap: 10px; background: var(--primary-light);
    padding: 12px; border-radius: 8px; cursor: pointer; user-select: none;
}
.checkbox-card input { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); }

/* è»Šä¸¡ã‚«ãƒ¼ãƒ‰ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¯¾å¿œï¼‰ */
.car-card {
    border: 1px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px;
    background: #fff; overflow: hidden;
}
.car-header {
    background: #f5f5f5; padding: 12px 15px;
    display: flex; justify-content: space-between; align-items: center;
    cursor: pointer; user-select: none;
    font-weight: bold; color: var(--text-main);
    transition: background 0.2s;
}
.car-header:active { background: #eeeeee; }
.car-title-text { display: flex; align-items: center; gap: 10px; font-size: 0.95rem; }
.toggle-icon { font-size: 0.8rem; color: #999; transition: transform 0.3s; }
.car-card.open .toggle-icon { transform: rotate(180deg); }

.car-body {
    padding: 15px;
    display: none; 
    animation: fadeIn 0.3s ease;
}
.car-card.open .car-body { display: block; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.remove-btn { 
    color: var(--danger); background: none; border: 1px solid var(--danger);
    font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; cursor: pointer;
}

.extra-section { background: #f9f9f9; padding: 12px; border-radius: 8px; margin-top: 15px; border: 1px dashed #ccc; }
.extra-item { display: flex; gap: 8px; margin-bottom: 8px; }

.btn {
    width: 100%; border: none; border-radius: 50px; font-size: 1rem; font-weight: bold;
    padding: 16px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
}
.btn-primary { background: var(--primary); color: white; margin-top: 10px; box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3); }
.btn-primary:active { transform: scale(0.98); }
.btn-outline { background: white; border: 2px dashed #b0bec5; color: var(--text-sub); margin-bottom: 15px; padding: 12px; }
.btn-reset { background: none; color: var(--text-sub); font-size: 0.85rem; margin-top: 20px; text-decoration: underline; padding: 10px; }

#resultArea { display: none; }

.result-header { text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
.price-tag { font-size: 2.4rem; font-weight: 800; color: var(--primary); display: block; line-height: 1.2; margin: 5px 0; }

/* æ”¯æ‰•ã„ãƒªã‚¹ãƒˆã®ãƒ‡ã‚¶ã‚¤ãƒ³ä¿®æ­£ */
.driver-row { 
    background: #fff; border: 1px solid #eee; border-radius: 8px; 
    padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
}
.driver-main { 
    display: flex; justify-content: space-between; align-items: center; 
    border-bottom: 2px solid var(--primary-light); padding-bottom: 8px; margin-bottom: 8px;
}
.driver-name { font-weight: bold; font-size: 1.05rem; }
.driver-total-price { font-size: 1.1rem; font-weight: bold; color: var(--primary); }

.detail-line { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.85rem; color: var(--text-sub); }
.detail-group { margin-top: 8px; padding-top: 8px; border-top: 1px dashed #ddd; }
.detail-label { color: #888; font-size: 0.75rem; margin-bottom: 2px; }

.copy-box { background: #263238; padding: 15px; border-radius: 8px; margin-top: 10px; }
#copyTextarea { 
    width: 100%; height: 160px; background: transparent; border: none; color: #eceff1; 
    font-size: 0.85rem; resize: none; font-family: monospace; outline: none;
}
.btn-copy { background: var(--accent); color: white; padding: 12px; margin-top: 10px; border-radius: 6px; border: none; width: 100%; font-weight: bold; cursor: pointer; }

/* å±¥æ­´ãƒ‡ã‚¶ã‚¤ãƒ³ */
.history-item { 
    background: #fff; border-left: 4px solid var(--history); padding: 12px; 
    margin-bottom: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.h-date { font-size: 0.75rem; color: var(--text-sub); margin-bottom: 2px;}
.h-summary { font-weight: bold; font-size: 0.9rem; }
.history-btns { display: flex; gap: 8px; }
.btn-h-restore { font-size: 0.8rem; background: var(--primary-light); color: var(--primary); border:none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
.btn-h-delete { font-size: 0.8rem; background: #ffebee; color: var(--danger); border:none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }

</style>
</head>
<body>

<div class="container">
    <header>
        <h1>â›°ï¸ å±±æ­©ä¼š ã‚¬ã‚½ãƒªãƒ³ç²¾ç®—ï¼ˆä»£è¡¨è€…ç”¨ï¼‰</h1>
    </header>

    <div class="usage-guide">
        <h3>âš ï¸ å‚åŠ è€…ãƒ»ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã®çš†æ§˜ã¸</h3>
        <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€<strong>ä»£è¡¨è€…ï¼ˆä¼šè¨ˆæ‹…å½“ï¼‰1åãŒå…¥åŠ›ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«</strong>ã§ã™ã€‚å„è‡ªã§ç²¾ç®—è¨ˆç®—ã¯è¡Œã‚ãšã€ä»¥ä¸‹ã®æƒ…å ±ã‚’ä»£è¡¨è€…ã«LINEç­‰ã§ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚</p>
        <ul style="margin-top:10px;">
            <li>èµ°è¡Œè·é›¢ (km)</li>
            <li>è»Šã®ç‡ƒè²» (km/L)</li>
            <li>ã‚¬ã‚½ãƒªãƒ³å˜ä¾¡ (å††)</li>
            <li>ç«‹æ›¿çµŒè²»ï¼ˆé«˜é€Ÿä»£ãƒ»é§è»Šå ´ä»£ãªã©ï¼‰</li>
        </ul>
    </div>

    <div class="card">
        <h2>âš™ï¸ åŸºæœ¬è¨­å®š</h2>
        <div class="input-group">
            <label>ä»Šå›ã®ä¼ç”»ã®å‚åŠ äººæ•°(ä¼ç”»è€…å«ã‚€)</label>
            <input type="number" id="totalPeople" placeholder="ä¾‹: 4" inputmode="numeric">
        </div>
        <label class="checkbox-card">
            <input type="checkbox" id="organizerFree">
            <span>ä¼ç”»è€…ã¯ã‚¬ã‚½ãƒªãƒ³ä»£ã‚’æ”¯æ‰•ã‚ãªã„</span>
        </label>
    </div>

    <div class="card" style="padding-bottom: 10px;">
        <h2>ğŸš— è»Šä¸¡æƒ…å ±ã®ç™»éŒ² <span class="sub-title">ï¼ˆâ€»ä»£è¡¨è€…ãŒã¾ã¨ã‚ã¦å…¥åŠ›ï¼‰</span></h2>
        <div id="carList"></div>
        <button class="btn btn-outline" onclick="addCar()">+ è»Šä¸¡ã‚’è¿½åŠ </button>
    </div>

    <button class="btn btn-primary" onclick="calculate()">ğŸš€ ç²¾ç®—ã‚’å®Ÿè¡Œã™ã‚‹</button>
    <button class="btn btn-reset" onclick="resetAll()">å…¨ã¦ã®å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ</button>

    <div id="resultArea">
        <div class="card" style="border-top: 6px solid var(--primary); margin-top:30px;">
            <div class="result-header">
                <label>1äººã‚ãŸã‚Šã®å¾´åé¡ï¼ˆã‚¬ã‚½ãƒªãƒ³ä»£ï¼‰</label>
                <span class="price-tag" id="resPerPerson">0å††</span>
                <small id="resTargetDetail" style="color:var(--text-sub)"></small>
            </div>

            <div class="res-section">
                <label style="margin-bottom:10px; display:block;">ğŸš— ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¸ã®æ”¯æ‰•ã„å†…è¨³</label>
                <div id="resDriverList"></div>
            </div>

            <div class="res-section" style="margin-top:20px; padding-top:15px; border-top: 1px dashed #ccc;">
                <label>ğŸ’° ã‚µãƒ¼ã‚¯ãƒ«ä¼šè¨ˆã‹ã‚‰ã®æ”¯å‡º</label>
                <div style="font-size:0.9rem; display: flex; justify-content: space-between; margin-top:5px;">
                    <span>çµŒè²»ãƒ»èª¿æ•´è²»ã®åˆè¨ˆ</span>
                    <span id="resCircleExpense">0å††</span>
                </div>
                <div style="font-size:0.9rem; display: flex; justify-content: space-between; color: var(--primary);">
                    <span>ç«¯æ•°å……å½“é¡ï¼ˆå‚åŠ è€…ã‹ã‚‰ã®ä½™å‰°é‡‘ï¼‰</span>
                    <span id="resGasSurplus">0å††</span>
                </div>
                <div style="font-size:1.1rem; font-weight: bold; display: flex; justify-content: space-between; margin-top:10px; color: var(--danger);">
                    <span>ä¼šè¨ˆã‹ã‚‰ã®å®Ÿæ”¯å‡º</span>
                    <span id="resWithdraw">0å††</span>
                </div>
            </div>
        </div>

        <div class="card" style="background: #263238; color: white;">
            <h2 style="color: white; border-color: #546e7a;">ğŸ“± LINEé€ä¿¡ç”¨ï¼ˆãã®ã¾ã¾é€ã‚Œã¾ã™ï¼‰</h2>
            <div class="copy-box">
                <textarea id="copyTextarea" readonly></textarea>
                <button class="btn-copy" onclick="copyToClipboard()">ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>
        </div>
    </div>

    <div class="history-section" style="margin-top: 40px; margin-bottom: 40px;">
        <h2 style="border:none; color: var(--history);">ğŸ•’ æœ€è¿‘ã®è¨ˆç®—å±¥æ­´</h2>
        <div id="historyList"></div>
    </div>
</div>

<script>
const DEFAULT_CAR = { name: "", dist: "", eco: "", price: "", extras: [] };

window.onload = function() {
    loadDraft();
    updateHistory();
};

// è»Šä¸¡ã‚«ãƒ¼ãƒ‰è¿½åŠ ï¼ˆæŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½ä»˜ãï¼‰
function addCar(data = null) {
    const list = document.getElementById('carList');
    const idx = list.children.length;
    const c = data || { ...DEFAULT_CAR, extras: [] };
    
    // æ–°è¦è¿½åŠ æ™‚ã¯é–‹ã
    const isOpen = data ? '' : 'open';

    const div = document.createElement('div');
    div.className = `car-card ${isOpen}`;
    div.id = `car-card-${idx}`;
    
    const displayName = c.name ? c.name : `è»Šä¸¡ ${idx + 1}`;

    div.innerHTML = `
        <div class="car-header" onclick="toggleCar(this)">
            <span class="car-title-text" id="car-title-${idx}">ğŸš™ ${displayName}</span>
            <div style="display:flex; align-items:center; gap:10px;">
                <button class="remove-btn" onclick="removeCar(event, this)">å‰Šé™¤</button>
                <span class="toggle-icon">â–¼</span>
            </div>
        </div>
        <div class="car-body">
            <div class="input-group">
                <label>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼åï¼ˆä»»æ„ï¼‰</label>
                <input type="text" class="inp-name" value="${c.name}" placeholder="æ°åï¼ˆä¾‹: ä½è—¤ï¼‰" oninput="updateHeaderName(${idx}, this.value)">
            </div>
            <div class="flex-row">
                <div class="input-group"><label>è·é›¢(km)</label><input type="number" class="inp-dist" value="${c.dist}" inputmode="decimal"></div>
                <div class="input-group"><label>ç‡ƒè²»(km/L)</label><input type="number" class="inp-eco" value="${c.eco}" inputmode="decimal"></div>
                <div class="input-group"><label>å˜ä¾¡(å††)</label><input type="number" class="inp-price" value="${c.price}" inputmode="numeric"></div>
            </div>
            <div class="extra-section">
                <label style="margin-bottom:8px; display:block; font-size:0.8rem;">â• ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ç«‹æ›¿çµŒè²»ï¼ˆé«˜é€Ÿãƒ»é§è»Šå ´ä»£ãªã©ï¼‰</label>
                <div id="extras-${idx}"></div>
                <button class="btn-reset" style="padding:0; margin:10px 0 0 0; text-align:left; font-size:0.8rem;" onclick="addExtra(${idx})">+ çµŒè²»ã‚’è¿½åŠ </button>
            </div>
        </div>
    `;
    list.appendChild(div);
    if(c.extras) c.extras.forEach(ex => addExtra(idx, ex.name, ex.amount));
}

// æŠ˜ã‚ŠãŸãŸã¿åˆ‡ã‚Šæ›¿ãˆ
function toggleCar(header) {
    const card = header.parentElement;
    card.classList.toggle('open');
}

// ãƒ˜ãƒƒãƒ€ãƒ¼ã®åå‰ã‚’é€£å‹•æ›´æ–°
function updateHeaderName(idx, val) {
    const title = document.getElementById(`car-title-${idx}`);
    title.textContent = val ? `ğŸš™ ${val}` : `ğŸš™ è»Šä¸¡ ${idx + 1}`;
}

function addExtra(idx, name="", amount="") {
    const box = document.getElementById(`extras-${idx}`);
    const div = document.createElement('div');
    div.className = 'extra-item';
    div.innerHTML = `
        <input type="text" class="ex-name" placeholder="åç›®" value="${name}" style="flex:2; padding:10px;">
        <input type="number" class="ex-amount" placeholder="é‡‘é¡" value="${amount}" style="flex:1; padding:10px;" inputmode="numeric">
        <button class="remove-btn" style="width:35px; border-radius:4px; font-size:1.2rem; padding:0;" onclick="this.parentElement.remove()">Ã—</button>
    `;
    box.appendChild(div);
}

function removeCar(e, btn){ 
    e.stopPropagation(); // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰ã‚’é˜²æ­¢
    if(confirm("ã“ã®è»Šä¸¡æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { 
        btn.closest('.car-card').remove(); 
        saveDraft(); 
    } 
}

function calculate() {
    const totalPeople = parseInt(document.getElementById('totalPeople').value);
    const isOrgFree = document.getElementById('organizerFree').checked;
    if (!totalPeople || totalPeople <= 0) { alert("ä¹—è»Šäººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    const cards = document.querySelectorAll('.car-card');
    let totalGas = 0; let totalExtras = 0; let totalReward = 0;
    let driverResults = []; 

    cards.forEach((card) => {
        const name = card.querySelector('.inp-name').value || "ãƒ‰ãƒ©ã‚¤ãƒãƒ¼";
        const dist = parseFloat(card.querySelector('.inp-dist').value) || 0;
        const eco = parseFloat(card.querySelector('.inp-eco').value) || 1;
        const price = parseFloat(card.querySelector('.inp-price').value) || 0;
        const gasCost = Math.round((dist / eco) * price);
        
        let extrasTotal = 0; 
        let exs = [];
        card.querySelectorAll('.extra-item').forEach(row => {
            const val = parseInt(row.querySelector('.ex-amount').value) || 0;
            const nm = row.querySelector('.ex-name').value || "è«¸çµŒè²»";
            if(val > 0) { extrasTotal += val; exs.push({name: nm, amount: val}); }
        });

        const reward = 1000; // ãƒ‰ãƒ©ã‚¤ãƒãƒ¼èª¿æ•´è²»ï¼ˆå›ºå®šï¼‰
        totalGas += gasCost; 
        totalExtras += extrasTotal; 
        totalReward += reward;

        driverResults.push({
            name,
            totalPay: gasCost + extrasTotal + reward,
            gasCost,
            reward,
            extras: exs,
            extrasTotal,
            dist: card.querySelector('.inp-dist').value,
            eco: card.querySelector('.inp-eco').value,
            price: card.querySelector('.inp-price').value
        });
    });

    const payers = isOrgFree ? (totalPeople - 1) : totalPeople;
    const perPersonGas = payers > 0 ? Math.ceil((totalGas / payers) / 100) * 100 : 0;
    const collectedGasTotal = perPersonGas * payers;
    const gasSurplus = collectedGasTotal - totalGas;
    const circleNeed = (totalExtras + totalReward) - gasSurplus;

    // --- ç”»é¢è¡¨ç¤º ---
    document.getElementById('resPerPerson').textContent = perPersonGas.toLocaleString() + " å††";
    // â‘ª è©³ç´°æ–‡ä¿®æ­£
    document.getElementById('resTargetDetail').innerHTML = `å¾´åäººæ•°ï¼š${payers}å ï¼ ã‚¬ã‚½ãƒªãƒ³ä»£å®Ÿè²»åˆè¨ˆï¼š${totalGas.toLocaleString()}å††`;
    
    // ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ãƒªã‚¹ãƒˆç”Ÿæˆ
    const dList = document.getElementById('resDriverList'); 
    dList.innerHTML = "";
    driverResults.forEach(d => {
        const row = document.createElement('div'); 
        row.className = 'driver-row';
        
        let extrasHtml = "";
        if(d.extras.length > 0) {
            d.extras.forEach(ex => {
                extrasHtml += `<div class="detail-line"><span>${ex.name}</span><span>${ex.amount.toLocaleString()}å††</span></div>`;
            });
            extrasHtml = `<div class="detail-group"><div class="detail-label">ç«‹æ›¿çµŒè²»</div>${extrasHtml}</div>`;
        }

        // â‘¬ ã‚¬ã‚½ãƒªãƒ³ä»£ã®æ˜ç´°æ–‡è¨€ä¿®æ­£
        row.innerHTML = `
            <div class="driver-main">
                <span class="driver-name">${d.name} æ§˜</span>
                <span class="driver-total-price">${d.totalPay.toLocaleString()} å††</span>
            </div>
            <div>
                <div class="detail-line"><span>ã‚¬ã‚½ãƒªãƒ³ä»£ï¼ˆèµ°è¡Œè·é›¢ãƒ»ç‡ƒè²»ã‹ã‚‰ç®—å‡ºï¼‰</span><span>${d.gasCost.toLocaleString()}å††</span></div>
                <div class="detail-line"><span>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼èª¿æ•´è²»</span><span>${d.reward.toLocaleString()}å††</span></div>
            </div>
            ${extrasHtml}
        `;
        dList.appendChild(row);
    });

    document.getElementById('resCircleExpense').textContent = (totalExtras + totalReward).toLocaleString() + " å††";
    document.getElementById('resGasSurplus').textContent = "-" + gasSurplus.toLocaleString() + " å††";
    document.getElementById('resWithdraw').textContent = circleNeed.toLocaleString() + " å††";
    document.getElementById('resultArea').style.display = 'block';
    
    document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });

    // LINEãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
    let lineText = `ã€å±±æ­©ä¼š ç²¾ç®—å ±å‘Š ğŸš™ã€‘\n`;
    lineText += `â– å¾´åé¡ï¼ˆã‚¬ã‚½ãƒªãƒ³ä»£ï¼‰\n1äººï¼š${perPersonGas.toLocaleString()}å††\n`;
    if(isOrgFree) lineText += `ï¼ˆâ€»ä¼ç”»è€…ã¯å…é™¤ï¼‰\n`;
    
    // â‘° ãƒ‰ãƒ©ã‚¤ãƒãƒ¼æ”¯æ‰•ã„LINEæ–‡è¨€ä¿®æ­£
    lineText += `\nâ– ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¸ã®æ”¯æ‰•é¡\n`;
    driverResults.forEach(d => {
        lineText += `ãƒ»${d.name}ã•ã‚“ï¼š${d.totalPay.toLocaleString()}å††\n`;
        lineText += `  (ã‚¬ã‚¹:${d.gasCost.toLocaleString()} / èª¿æ•´:${d.reward.toLocaleString()}`;
        if (d.extrasTotal > 0) lineText += ` / ç«‹æ›¿:${d.extrasTotal.toLocaleString()}`;
        lineText += `)\n`;
    });
    
    // â‘± ã‚µãƒ¼ã‚¯ãƒ«ä¼šè¨ˆLINEæ–‡è¨€ä¿®æ­£
    lineText += `\nâ– ã‚µãƒ¼ã‚¯ãƒ«ä¼šè¨ˆã‹ã‚‰ã®æ”¯å‡º\nè¨ˆï¼š${circleNeed.toLocaleString()}å††\n\nãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼`;
    document.getElementById('copyTextarea').value = lineText;

    saveToHistory({ 
        date: new Date().toLocaleString('ja-JP', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'}), 
        totalPeople, 
        isOrgFree, 
        cars: driverResults, 
        perPersonGas 
    });
}

function copyToClipboard() {
    const textarea = document.getElementById('copyTextarea');
    textarea.select(); document.execCommand('copy');
    const btn = document.querySelector('.btn-copy'); 
    const originalText = btn.textContent;
    btn.textContent = "âœ… ã‚³ãƒ”ãƒ¼å®Œäº†ï¼";
    setTimeout(() => { btn.textContent = originalText; }, 2000);
}

function saveDraft() {
    const cards = document.querySelectorAll('.car-card');
    const carDatas = Array.from(cards).map(card => ({
        name: card.querySelector('.inp-name').value, 
        dist: card.querySelector('.inp-dist').value,
        eco: card.querySelector('.inp-eco').value, 
        price: card.querySelector('.inp-price').value,
        extras: Array.from(card.querySelectorAll('.extra-item')).map(row => ({ name: row.querySelector('.ex-name').value, amount: row.querySelector('.ex-amount').value }))
    }));
    localStorage.setItem('gas_draft_v2', JSON.stringify({ total: document.getElementById('totalPeople').value, org: document.getElementById('organizerFree').checked, cars: carDatas }));
}

function loadDraft() {
    const raw = localStorage.getItem('gas_draft_v2'); 
    if(!raw) { addCar(); return; }
    
    const d = JSON.parse(raw); 
    document.getElementById('totalPeople').value = d.total;
    document.getElementById('organizerFree').checked = d.org;
    
    document.getElementById('carList').innerHTML = "";
    if(d.cars && d.cars.length) {
        d.cars.forEach(c => addCar(c));
    } else {
        addCar();
    }
}

function updateHistory() {
    const history = JSON.parse(localStorage.getItem('gas_history_v2') || "[]");
    const container = document.getElementById('historyList');
    container.innerHTML = history.length === 0 ? "<p style='font-size:0.85rem; color:#999; text-align:center;'>å±¥æ­´ãªã—</p>" : "";
    history.forEach((h, i) => {
        const div = document.createElement('div'); div.className = 'history-item';
        div.innerHTML = `
            <div>
                <div class="h-date">${h.date}</div>
                <div class="h-summary">${h.totalPeople}å / 1äºº ${h.perPersonGas.toLocaleString()}å††</div>
            </div>
            <div class="history-btns">
                <button class="btn-h-restore" onclick="restoreHistory(${i})">å¾©å…ƒ</button>
                <button class="btn-h-delete" onclick="deleteHistory(${i})">å‰Šé™¤</button>
            </div>`;
        container.appendChild(div);
    });
}

function restoreHistory(index) {
    if(!confirm("ç¾åœ¨ã®å…¥åŠ›ã‚’ç ´æ£„ã—ã¦ã€ã“ã®å±¥æ­´ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")) return;
    const history = JSON.parse(localStorage.getItem('gas_history_v2') || "[]");
    const data = history[index];
    document.getElementById('totalPeople').value = data.totalPeople;
    document.getElementById('organizerFree').checked = data.isOrgFree;
    document.getElementById('carList').innerHTML = "";
    
    data.cars.forEach(c => {
        const inputData = {
            name: c.name,
            dist: c.dist || "",
            eco: c.eco || "",
            price: c.price || "",
            extras: c.extras || []
        };
        addCar(inputData);
    });
    calculate();
}

function deleteHistory(index) {
    if(!confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    let history = JSON.parse(localStorage.getItem('gas_history_v2') || "[]");
    history.splice(index, 1);
    localStorage.setItem('gas_history_v2', JSON.stringify(history));
    updateHistory();
}

function resetAll() { if(confirm("å…¥åŠ›ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.removeItem('gas_draft_v2'); location.reload(); } }
document.addEventListener('input', saveDraft);
</script>

</body>
</html>
