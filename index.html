<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ã‚µãƒ¼ã‚¯ãƒ«ç”¨ã‚¬ã‚½ãƒªãƒ³ä»£è¨ˆç®—ãƒ„ãƒ¼ãƒ« V3</title>

<style>
:root{
    --main: #2c3e50;
    --accent: #27ae60;
    --danger: #c0392b;
    --bg: #f8f9fa;
    --card: #ffffff;
    --border: #e9ecef;
    --radius: 8px;
}

*{box-sizing:border-box}
body{
    font-family: "Helvetica Neue", Arial, sans-serif;
    margin:0;
    padding:20px 10px;
    background: var(--bg);
    color: #333;
}

.container{
    max-width: 600px;
    margin: 0 auto;
    background: var(--card);
    padding: 24px;
    border-radius: var(--radius);
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

h1{
    text-align: center;
    color: var(--main);
    font-size: 1.4rem;
    margin-bottom: 24px;
}

h2{
    font-size: 1.1rem;
    border-left: 5px solid var(--accent);
    padding-left: 10px;
    margin-top: 30px;
    color: var(--main);
}

/* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
label{
    display: block;
    font-weight: bold;
    font-size: 0.9rem;
    margin-top: 12px;
    margin-bottom: 4px;
    color: #555;
}
input[type="number"], input[type="text"]{
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 16px;
}

/* è»Šä¸¡ã‚«ãƒ¼ãƒ‰ */
.car-card{
    background: #fff;
    border: 1px solid #ddd;
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 16px;
    position: relative;
    border-top: 4px solid var(--main);
}
.car-header{
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}
.remove-btn{
    color: var(--danger);
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2rem;
}

/* è«¸è²»ç”¨ãƒªã‚¹ãƒˆ */
.extra-list{
    background: #f1f3f5;
    padding: 10px;
    border-radius: 4px;
    margin-top: 5px;
}
.extra-item{
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
    align-items: center;
}
.btn-mini{
    background: #ddd;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
}

/* ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³ */
.btn-primary{
    display: block;
    width: 100%;
    padding: 15px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 50px;
    font-size: 1.1rem;
    font-weight: bold;
    cursor: pointer;
    margin-top: 20px;
}
.btn-outline{
    width: 100%;
    padding: 10px;
    background: white;
    border: 2px dashed #aaa;
    color: #555;
    cursor: pointer;
    margin-top: 10px;
}
.btn-reset{
    width: 100%;
    padding: 10px;
    background: #eee;
    border: none;
    color: #666;
    margin-top: 10px;
    border-radius: 50px;
    cursor: pointer;
}

/* çµæœè¡¨ç¤º */
#resultArea{
    display: none;
    margin-top: 30px;
    background: #e3fcef; /* è–„ã„ç·‘èƒŒæ™¯ */
    padding: 20px;
    border-radius: var(--radius);
    border: 2px solid var(--accent);
}
.res-block{
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px dashed #aecbba;
}
.res-block:last-child{ border-bottom: none; }
.res-title{
    font-weight: bold;
    color: #2d5a42;
    margin-bottom: 5px;
    font-size: 1rem;
}
.price-large{
    font-size: 1.8rem;
    font-weight: bold;
    color: var(--accent);
}
.price-detail{
    font-size: 0.9rem;
    color: #555;
}
.circle-cost{
    color: var(--danger);
    font-weight: bold;
    font-size: 1.2rem;
}

/* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
.check-group{
    display: flex;
    align-items: center;
    gap: 10px;
    background: #fff3cd;
    padding: 10px;
    border-radius: 4px;
    margin-top: 10px;
    border: 1px solid #ffeeba;
}
</style>
</head>
<body>

<div class="container">
    <h1>ğŸš™ ã‚µãƒ¼ã‚¯ãƒ«ä¼šè¨ˆç²¾ç®—</h1>

    <label>ä¼ç”»ã®å‚åŠ äººæ•°</label>
    <input type="number" id="totalPeople" placeholder="ä¾‹: 12">

    <div class="check-group">
        <input type="checkbox" id="organizerFree">
        <label for="organizerFree">ä¼ç”»è€…ã¯ã€Œã‚¬ã‚½ãƒªãƒ³ä»£ã€ç„¡æ–™</label>
    </div>

    <h2>è»Šä¸¡ãƒ»ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ç™»éŒ²</h2>
    <div id="carList"></div>
    <button class="btn-outline" onclick="addCar()">+ è»Šä¸¡ã‚’è¿½åŠ </button>

    <button class="btn-primary" onclick="calculate()">è¨ˆç®—ã™ã‚‹</button>
    <button class="btn-reset" onclick="resetAll()">ãƒªã‚»ãƒƒãƒˆ</button>

    <div id="resultArea">
        <div class="res-block">
            <div class="res-title">â‘  å‚åŠ è€…ã‹ã‚‰ã®å¾´åé¡ (ã‚¬ã‚½ãƒªãƒ³ä»£)</div>
            <div class="price-large" id="resPerPerson">0å††</div>
            <div class="price-detail" id="resTargetDetail"></div>
        </div>

        <div class="res-block">
            <div class="res-title">â‘¡ å„ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¸ã®æ”¯æ‰•é‡‘é¡</div>
            <div class="price-detail" style="margin-bottom:5px;">(å†…è¨³ï¼šç«‹æ›¿ãˆãŸå…¨é¡ ï¼‹ èª¿æ•´è²»1000å††)</div>
            <div id="resDriverList"></div>
        </div>

        <div class="res-block">
            <div class="res-title">â‘¢ ã‚µãƒ¼ã‚¯ãƒ«ä¼šè¨ˆã®ç²¾ç®—çµæœ</div>
            <div style="font-size:0.9rem;">
                è«¸çµŒè²»ãƒ»èª¿æ•´è²»åˆè¨ˆï¼š<span id="resCircleExpense">0</span> å††<br>
                ã‚¬ã‚½ãƒªãƒ³ä»£ã®ç«¯æ•°ä½™å‰°ï¼š<span id="resGasSurplus" style="color:#27ae60">0</span> å†† (å¼•å½“)<br>
                <div style="margin-top:8px; padding-top:8px; border-top:1px solid #ccc;">
                    <strong>ã‚µãƒ¼ã‚¯ãƒ«ä¼šè¨ˆã‹ã‚‰ã®æ”¯å‡ºé¡ï¼š</strong><br>
                    <span class="circle-cost" id="resWithdraw">0 å††</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿æ§‹é€ 
const DEFAULT_CAR = { name: "", dist: "", eco: "", price: "", extras: [] };

window.onload = loadData;

// è»Šä¸¡è¿½åŠ 
function addCar(data = null) {
    const list = document.getElementById('carList');
    const idx = list.children.length;
    const c = data || DEFAULT_CAR;

    const div = document.createElement('div');
    div.className = 'car-card';
    div.innerHTML = `
        <div class="car-header">
            <strong>è»Šä¸¡ ${idx+1}</strong>
            <button class="remove-btn" onclick="removeCar(this)">Ã—</button>
        </div>
        
        <label>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼å</label>
        <input type="text" class="inp-name" value="${c.name}" placeholder="æ°å">

        <div style="display:flex; gap:5px;">
            <div style="flex:1"><label>è·é›¢km</label><input type="number" class="inp-dist" value="${c.dist}"></div>
            <div style="flex:1"><label>ç‡ƒè²»km/L</label><input type="number" class="inp-eco" value="${c.eco}"></div>
            <div style="flex:1"><label>å˜ä¾¡/L</label><input type="number" class="inp-price" value="${c.price}"></div>
        </div>

        <label>è«¸è²»ç”¨ï¼ˆé«˜é€Ÿãƒ»ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼ç­‰ï¼‰</label>
        <div class="extra-list" id="extras-${idx}"></div>
        <button class="btn-mini" onclick="addExtra(${idx})" style="margin-top:5px;">+ çµŒè²»è¿½åŠ </button>
    `;
    list.appendChild(div);

    // è«¸è²»ç”¨ã®å¾©å…ƒ
    if(c.extras && c.extras.length > 0){
        c.extras.forEach(ex => addExtra(idx, ex.name, ex.amount));
    }
}

// è«¸è²»ç”¨è¡Œã®è¿½åŠ 
function addExtra(idx, name="", amount="") {
    const box = document.getElementById(`extras-${idx}`);
    const div = document.createElement('div');
    div.className = 'extra-item';
    div.innerHTML = `
        <input type="text" class="ex-name" placeholder="åç›®" value="${name}" style="flex:2">
        <input type="number" class="ex-amount" placeholder="é‡‘é¡" value="${amount}" style="flex:1">
        <button class="remove-btn" style="font-size:1rem;" onclick="this.parentElement.remove()">Ã—</button>
    `;
    box.appendChild(div);
}

function removeCar(btn){
    if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
        btn.closest('.car-card').remove();
    }
}

// â– â– â–  è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã®ä¿®æ­£ç‰ˆ â– â– â– 
function calculate() {
    const totalPeople = parseInt(document.getElementById('totalPeople').value);
    const isOrgFree = document.getElementById('organizerFree').checked;

    if (!totalPeople) { alert("äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    const cards = document.querySelectorAll('.car-card');
    let totalGas = 0;       // å…¨è»Šã®ã‚¬ã‚½ãƒªãƒ³ä»£åˆè¨ˆ
    let totalExtras = 0;    // å…¨è»Šã®è«¸çµŒè²»åˆè¨ˆ (é«˜é€Ÿãƒ»ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼)
    let totalReward = 0;    // å…¨ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã®èª¿æ•´è²»åˆè¨ˆ
    let driverDetails = [];

    // 1. å…¨è»Šä¸¡ã®ã‚³ã‚¹ãƒˆé›†è¨ˆ
    cards.forEach(card => {
        const name = card.querySelector('.inp-name').value || "åç„¡ã—";
        const dist = parseFloat(card.querySelector('.inp-dist').value) || 0;
        const eco = parseFloat(card.querySelector('.inp-eco').value) || 1;
        const price = parseFloat(card.querySelector('.inp-price').value) || 0;

        // ã‚¬ã‚½ãƒªãƒ³ä»£ç®—å‡º
        const gas = Math.round((dist / eco) * price);
        
        // è«¸è²»ç”¨ç®—å‡º
        let extras = 0;
        let exNames = [];
        card.querySelectorAll('.extra-item').forEach(row => {
            const val = parseInt(row.querySelector('.ex-amount').value) || 0;
            const nm = row.querySelector('.ex-name').value || "çµŒè²»";
            if(val > 0) {
                extras += val;
                exNames.push(`${nm}:${val}`);
            }
        });

        const reward = 1000; // èª¿æ•´è²»

        // åˆè¨ˆã«åŠ ç®—
        totalGas += gas;
        totalExtras += extras;
        totalReward += reward;

        // ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã”ã¨ã®å—å–é¡ï¼ˆã‚¬ã‚½ãƒªãƒ³ï¼‹è«¸çµŒè²»ï¼‹èª¿æ•´è²»ï¼‰
        driverDetails.push({
            name: name,
            pay: gas + extras + reward,
            desc: `(ã‚¬ã‚¹${gas} + è«¸è²»${extras} + èª¿æ•´${reward})`,
            extraDetail: exNames.join(", ")
        });
    });

    // 2. å‰²ã‚Šå‹˜è¨ˆç®— (ã‚¬ã‚½ãƒªãƒ³ä»£ã®ã¿)
    // ä¼ç”»è€…ãŒç„¡æ–™ãªã‚‰ã€äººæ•°ã‹ã‚‰1å¼•ã
    const payers = isOrgFree ? (totalPeople - 1) : totalPeople;
    
    // 1äººã‚ãŸã‚Šã®å¾´åé¡ï¼ˆã‚¬ã‚½ãƒªãƒ³ä»£ã‚’äººæ•°ã§å‰²ã£ã¦100å††åˆ‡ã‚Šä¸Šã’ï¼‰
    const perPersonGas = Math.ceil((totalGas / payers) / 100) * 100;
    
    // ã‚¬ã‚½ãƒªãƒ³ä»£ã¨ã—ã¦é›†ã¾ã‚‹ç·é¡
    const collectedGasTotal = perPersonGas * payers;

    // ã‚¬ã‚½ãƒªãƒ³ä»£ã®ä½™å‰°ï¼ˆåˆ‡ã‚Šä¸Šã’åˆ†ï¼‰
    const gasSurplus = collectedGasTotal - totalGas;

    // 3. ã‚µãƒ¼ã‚¯ãƒ«è²»ã‹ã‚‰ã®å‡ºé‡‘è¨ˆç®—
    // ã‚µãƒ¼ã‚¯ãƒ«è² æ‹…é¡ = (è«¸è²»ç”¨ + èª¿æ•´è²») - (ã‚¬ã‚½ãƒªãƒ³ä»£ã®ä½™å‰°é‡‘)
    // â€»ä½™å‰°é‡‘ã¯ã‚µãƒ¼ã‚¯ãƒ«è²»ã®ç¯€ç´„ã«å……ã¦ã‚‹ã¨ã„ã†è€ƒãˆæ–¹
    const circleNeed = (totalExtras + totalReward) - gasSurplus;


    // â– â– â–  è¡¨ç¤ºã¸ã®åæ˜  â– â– â– 

    // â‘  å¾´åé¡
    document.getElementById('resPerPerson').textContent = perPersonGas.toLocaleString() + " å††";
    document.getElementById('resTargetDetail').textContent = 
        `å¯¾è±¡: ${payers}å (ä¼ç”»è€…ã¯${isOrgFree ? '0å††' : 'åŒé¡'}) / ã‚¬ã‚½ãƒªãƒ³ç·é¡ ${totalGas.toLocaleString()}å††`;

    // â‘¡ ãƒ‰ãƒ©ã‚¤ãƒãƒ¼æ”¯æ‰•ã„
    const dList = document.getElementById('resDriverList');
    dList.innerHTML = "";
    driverDetails.forEach(d => {
        const row = document.createElement('div');
        row.style.cssText = "display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:8px 0;";
        row.innerHTML = `
            <div>
                <strong>${d.name}</strong>
                <div style="font-size:0.8rem; color:#666;">${d.desc}</div>
                <div style="font-size:0.75rem; color:#888;">${d.extraDetail}</div>
            </div>
            <div style="font-weight:bold;">${d.pay.toLocaleString()} å††</div>
        `;
        dList.appendChild(row);
    });

    // â‘¢ ã‚µãƒ¼ã‚¯ãƒ«ä¼šè¨ˆ
    document.getElementById('resCircleExpense').textContent = (totalExtras + totalReward).toLocaleString();
    document.getElementById('resGasSurplus').textContent = "-" + gasSurplus.toLocaleString();
    document.getElementById('resWithdraw').textContent = circleNeed.toLocaleString() + " å††";

    document.getElementById('resultArea').style.display = 'block';
    saveData();
}

function saveData(){
    const data = {
        total: document.getElementById('totalPeople').value,
        orgFree: document.getElementById('organizerFree').checked,
        cars: []
    };
    document.querySelectorAll('.car-card').forEach(card => {
        const exs = [];
        card.querySelectorAll('.extra-item').forEach(ex => {
            exs.push({
                name: ex.querySelector('.ex-name').value,
                amount: ex.querySelector('.ex-amount').value
            });
        });
        data.cars.push({
            name: card.querySelector('.inp-name').value,
            dist: card.querySelector('.inp-dist').value,
            eco: card.querySelector('.inp-eco').value,
            price: card.querySelector('.inp-price').value,
            extras: exs
        });
    });
    localStorage.setItem('gas_calc_v3', JSON.stringify(data));
}

function loadData(){
    const raw = localStorage.getItem('gas_calc_v3');
    if(raw){
        const d = JSON.parse(raw);
        document.getElementById('totalPeople').value = d.total;
        document.getElementById('organizerFree').checked = d.orgFree;
        document.getElementById('carList').innerHTML = "";
        if(d.cars.length) d.cars.forEach(c => addCar(c));
        else addCar();
    } else {
        addCar();
    }
}

function resetAll(){
    if(confirm("ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")){
        localStorage.removeItem('gas_calc_v3');
        location.reload();
    }
}
</script>

</body>
</html>
