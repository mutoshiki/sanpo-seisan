
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å±±æ­©ä¼šä¼šè¨ˆç²¾ç®—ãƒ„ãƒ¼ãƒ« v4.1</title>
<style>
:root {
    --primary: #43a047;
    --primary-dark: #2e7d32;
    --primary-light: #e8f5e9;
    --accent: #ff9800;
    --danger: #e53935;
    --danger-bg: #ffebee;
    --line-color: #06c755;
    --text-main: #2d3748;
    --text-sub: #718096;
    --bg: #f7fafc;
    --card: #ffffff;
    --input-bg: #ffffff;
    --input-border: #e2e8f0;
    --header-bg: #f8f9fa;
    --guide-bg: #e3f2fd;
    --guide-border: #bbdefb;
    --guide-text: #0d47a1;
    --radius: 16px;
    --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
    --sync-status: #4caf50;
    --room-badge-bg: #37474f;
    --room-badge-text: #eceff1;
}

@media (prefers-color-scheme: dark) {
    :root {
        --primary: #66bb6a;
        --primary-dark: #1b5e20;
        --primary-light: #2d3748;
        --accent: #ffb74d;
        --danger: #ef5350;
        --danger-bg: #3e2723;
        --text-main: #e0e0e0;
        --text-sub: #b0bec5;
        --bg: #1a202c;
        --card: #2d3748;
        --input-bg: #2c2c2c;
        --input-border: #424242;
        --header-bg: #4a5568;
        --guide-bg: #263238;
        --guide-border: #37474f;
        --guide-text: #eceff1;
        --shadow: 0 4px 15px rgba(0,0,0,0.5);
        --room-badge-bg: #cfd8dc;
        --room-badge-text: #263238;
    }
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
    font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
    margin: 0; padding: 20px 15px;
    background: var(--bg); color: var(--text-main);
    line-height: 1.6; font-size: 16px;
    transition: background 0.3s, color 0.3s;
}

.container { max-width: 600px; margin: 0 auto; padding-bottom: 80px;}
header { text-align: center; margin-bottom: 20px; }
h1 { font-size: 1.5rem; margin: 0; color: var(--primary-dark); display: flex; flex-direction: column; align-items: center; justify-content: center; letter-spacing: 0.05em; }
h1 span { font-size: 0.8rem; margin-top: 4px; color: var(--text-sub); font-weight: normal; opacity: 0.8; }

.room-badge {
    background: var(--room-badge-bg); color: var(--room-badge-text);
    padding: 6px 16px; border-radius: 20px; font-family: monospace; font-size: 1.1rem; letter-spacing: 1px;
    margin: 15px auto; display: inline-flex; align-items: center; gap: 8px; cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.1s, box-shadow 0.2s;
}
.room-badge:active { transform: scale(0.96); }
.room-badge small { font-size: 0.7rem; opacity: 0.8; font-family: sans-serif; letter-spacing: 0; }

.sync-indicator {
    font-size: 0.75rem; color: var(--primary); 
    display: flex; align-items: center; justify-content: center; gap: 6px;
    margin-top: 5px; opacity: 0.9;
}
.dot { width: 8px; height: 8px; background: var(--sync-status); border-radius: 50%; display: inline-block; animation: pulse 2s infinite; }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

.usage-guide {
    background: var(--guide-bg); border: 1px solid var(--guide-border);
    padding: 15px 20px; border-radius: var(--radius); margin-bottom: 25px;
    font-size: 0.85rem; color: var(--guide-text);
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.usage-guide h3 { margin: 0 0 5px 0; font-size: 0.95rem; display: flex; align-items: center; gap: 6px; }

.card {
    background: var(--card); padding: 20px; border-radius: var(--radius);
    box-shadow: var(--shadow); margin-bottom: 24px; border: 1px solid rgba(0,0,0,0.03);
}

h2 { font-size: 1.1rem; margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px; border-bottom: 2px solid var(--primary-light); padding-bottom: 10px; color: var(--primary-dark); font-weight: 700; }
.sub-title { font-size: 0.8rem; font-weight: normal; color: var(--text-sub); margin-left: auto; }

.input-group { margin-bottom: 18px; }
label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; color: var(--text-sub); }

input[type="number"], input[type="text"], select {
    width: 100%; padding: 14px; 
    border: 1px solid var(--input-border); 
    border-radius: 10px; 
    font-size: 16px; 
    background: var(--input-bg);
    color: var(--text-main);
    font-family: "SF Mono", "Menlo", "Consolas", "Courier New", monospace;
    font-feature-settings: "tnum";
    transition: 0.2s;
    appearance: none;
}
input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(67, 160, 71, 0.2); }

.flex-row { display: flex; gap: 10px; }
.flex-row > div { flex: 1; }

/* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒé¢¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
.checkbox-card {
    display: flex; align-items: center; justify-content: space-between;
    background: var(--bg); border: 1px solid var(--input-border);
    padding: 16px; border-radius: 12px; cursor: pointer; user-select: none; color: var(--text-main);
    transition: all 0.2s;
}
.checkbox-card:active { background: var(--primary-light); }
.checkbox-card input { display: none; }
.toggle-switch {
    width: 44px; height: 24px; background: #ccc; border-radius: 24px; position: relative; transition: 0.3s;
}
.toggle-switch::after {
    content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px;
    background: white; border-radius: 50%; transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.checkbox-card input:checked + .toggle-switch { background: var(--primary); }
.checkbox-card input:checked + .toggle-switch::after { transform: translateX(20px); }

.car-card {
    border: 1px solid var(--input-border); border-radius: 12px; margin-bottom: 16px;
    background: var(--card); overflow: hidden; transition: box-shadow 0.2s;
}
.car-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
.car-header {
    background: var(--header-bg); padding: 14px 18px;
    display: flex; justify-content: space-between; align-items: center;
    cursor: pointer; user-select: none;
    font-weight: 600; color: var(--text-main);
    transition: background 0.2s;
}
.car-header:active { opacity: 0.8; }
.car-title-text { display: flex; align-items: center; gap: 10px; font-size: 1rem; }
.toggle-icon { font-size: 0.8rem; color: var(--text-sub); transition: transform 0.3s; }
.car-card.open .toggle-icon { transform: rotate(180deg); }

.car-body { padding: 20px; display: none; animation: fadeIn 0.3s ease; border-top: 1px solid var(--input-border); }
.car-card.open .car-body { display: block; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.remove-btn { 
    color: var(--danger); background: rgba(255, 255, 255, 0.5); border: 1px solid var(--danger);
    font-size: 0.85rem; width: 32px; height: 32px; border-radius: 50%; cursor: pointer;
    display: flex; align-items: center; justify-content: center; transition: 0.2s;
}
.remove-btn:hover { background: var(--danger); color: white; }

.extra-section { background: var(--bg); padding: 15px; border-radius: 10px; margin-top: 20px; border: 1px dashed var(--input-border); }
.extra-item { display: flex; gap: 8px; margin-bottom: 8px; }

.btn {
    width: 100%; border: none; border-radius: 50px; font-size: 1.05rem; font-weight: 700;
    padding: 16px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; letter-spacing: 0.02em;
}
.btn-primary { 
    background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
    color: white; margin-top: 10px; 
    box-shadow: 0 4px 15px rgba(67, 160, 71, 0.3); 
}
.btn-primary:active { transform: scale(0.98); box-shadow: 0 2px 8px rgba(67, 160, 71, 0.2); }
.btn-outline { 
    background: transparent; border: 2px dashed var(--input-border); color: var(--primary); 
    margin-bottom: 15px; padding: 14px; font-weight: 600;
}
.btn-outline:hover { background: var(--primary-light); border-color: var(--primary); }
.btn-reset { background: none; color: var(--text-sub); font-size: 0.85rem; margin-top: 20px; text-decoration: underline; padding: 10px; border:none; cursor:pointer; opacity: 0.8;}
.btn-reset:hover { opacity: 1; color: var(--danger); }
.btn-line { background: var(--line-color); color: white; margin-top: 10px; }
.btn-history { background: #546e7a; color: white; font-size: 0.9rem; padding: 10px; border-radius: 8px; margin-top: 10px; }

#resultArea { display: none; }
.result-header { text-align: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid var(--input-border); }
.price-tag { font-size: 2.8rem; font-weight: 800; color: var(--primary-dark); display: block; line-height: 1.2; margin: 10px 0; letter-spacing: -0.02em; }

.driver-row { 
    background: var(--bg); border: 1px solid var(--input-border); border-radius: 12px; 
    padding: 18px; margin-bottom: 15px; 
}
.driver-main { 
    display: flex; justify-content: space-between; align-items: center; 
    border-bottom: 2px solid rgba(0,0,0,0.05); padding-bottom: 10px; margin-bottom: 10px;
}
.driver-name { font-weight: 700; font-size: 1.1rem; }
.driver-total-price { font-size: 1.2rem; font-weight: 800; color: var(--primary-dark); }

.detail-line { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.85rem; color: var(--text-sub); }
.detail-group { margin-top: 8px; padding-top: 8px; border-top: 1px dashed var(--input-border); }
.detail-label { color: var(--text-sub); font-size: 0.75rem; margin-bottom: 2px; opacity: 0.8; }

.withdraw-box {
    font-size: 1.1rem; font-weight: bold; display: flex; justify-content: space-between; margin-top: 10px;
    color: var(--danger); border: 2px solid var(--danger); padding: 15px; border-radius: 12px;
    background: var(--danger-bg);
}

.copy-box { background: #263238; padding: 15px; border-radius: 8px; margin-top: 10px; }
#copyTextarea { 
    width: 100%; height: 160px; background: transparent; border: none; color: #eceff1; 
    font-size: 0.85rem; resize: none; font-family: monospace; outline: none;
}
.btn-copy { background: #455a64; color: white; padding: 12px; margin-top: 10px; border-radius: 6px; border: none; width: 100%; font-weight: bold; cursor: pointer; }

.history-list { list-style: none; padding: 0; margin: 10px 0 0 0; }
.history-item { 
    background: var(--header-bg); padding: 10px; border-radius: 6px; margin-bottom: 8px;
    display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--input-border);
}
.history-info { font-size: 0.85rem; }
.history-date { font-size: 0.75rem; color: var(--text-sub); display: block; }
.btn-load { background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; margin-left:10px; }
.btn-del-hist { background: none; color: var(--danger); border: none; font-size: 1.2rem; cursor: pointer; padding: 0 5px; }

#toast {
    visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center;
    border-radius: 50px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px;
    transform: translateX(-50%); font-size: 14px; opacity: 0; transition: opacity 0.3s, bottom 0.3s;
}
#toast.show { visibility: visible; opacity: 1; bottom: 50px; }
</style>
</head>
<body>

<div class="container">
    <header>
        <h1>â›°ï¸ å±±æ­©ä¼šä¼šè¨ˆç²¾ç®—ãƒ„ãƒ¼ãƒ«<span>v4.1</span></h1>
        
        <div class="room-badge" onclick="copyRoomLink()">
            <span>ID: <span id="dispRoomId">...</span></span>
            <small style="background:rgba(255,255,255,0.2); padding:2px 8px; border-radius:12px; margin-left:8px;">ğŸ”— å…±æœ‰URLã‚’ã‚³ãƒ”ãƒ¼</small>
        </div>

        <div class="sync-indicator">
            <span class="dot"></span>
            <span id="syncText">åŒæœŸä¸­...</span>
        </div>
    </header>

    <div class="usage-guide">
        <h3> ã“ã®ãƒ„ãƒ¼ãƒ«ã®ä½¿ã„æ–¹</h3>
        <ol style="padding-left: 20px; margin: 5px 0 10px 0;">
            <li><strong>è»Šä¸¡ã‚’ç™»éŒ²</strong>: ã€Œ+ è»Šä¸¡ã‚’è¿½åŠ ã€ã§è»Šã‚’ç™»éŒ²ã—ã¾ã™ã€‚</li>
            <li><strong>æƒ…å ±ã‚’å…¥åŠ›</strong>: èµ°è¡Œè·é›¢ã€ç‡ƒè²»ã€ã‚¬ã‚½ãƒªãƒ³ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¾ã™ã€‚</li>
            <li><strong>çµŒè²»ã‚’è¿½åŠ </strong>: é«˜é€Ÿä»£ãªã©ã¯ã€Œ+ çµŒè²»ã‚’è¿½åŠ ã€ã«å…¥åŠ›ã—ã¾ã™ã€‚</li>
            <li><strong>ç²¾ç®—</strong>: å‚åŠ äººæ•°ã‚’å…¥åŠ›ã—ã€Œç²¾ç®—ã‚’å®Ÿè¡Œã€ã§è¨ˆç®—ã—ã¾ã™ã€‚</li>
        </ol>
        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed var(--guide-border); font-size: 0.8rem;">
            <strong>ğŸ“¡ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…±æœ‰:</strong> å…¥åŠ›å†…å®¹ã¯åŒã˜URLã‚’é–‹ã„ã¦ã„ã‚‹å…¨å“¡ã«å³åº§ã«å…±æœ‰ãƒ»ä¿å­˜ã•ã‚Œã¾ã™ã€‚
        </div>
    </div>

    <div class="card" style="padding-bottom: 10px;">
        <h2>ğŸš— è»Šä¸¡æƒ…å ±ã®ç™»éŒ²</h2>
        <div id="carList"></div>
        <button class="btn btn-outline" onclick="handleAddCarBtn()">+ è»Šä¸¡ã‚’è¿½åŠ </button>
    </div>

    <div class="card">
        <h2>ğŸ‘¥ ç²¾ç®—ã®è¨­å®š</h2>
        
        <div class="input-group">
            <label>ç«¯æ•°å‡¦ç†ï¼ˆåˆ‡ã‚Šä¸Šã’å˜ä½ï¼‰</label>
            <select id="roundingUnit" onchange="pushData()">
                <option value="100" selected>100å††</option>
                <option value="50">50å††</option>
                <option value="10">10å††</option>
                <option value="1">1å††</option>
            </select>
        </div>

        <div class="input-group">
            <label>ä»Šå›ã®ä¼ç”»ã®å‚åŠ äººæ•°(ä¼ç”»è€…å«ã‚€)</label>
            <input type="number" id="totalPeople" placeholder="ä¾‹: 4" inputmode="numeric" oninput="pushData()">
        </div>
        
        <label class="checkbox-card" style="margin-bottom: 15px;">
            <span>ä¼ç”»è€…ã¯ã‚¬ã‚½ãƒªãƒ³ä»£ã‚’æ”¯æ‰•ã‚ãªã„</span>
            <input type="checkbox" id="organizerFree" onchange="pushData()">
            <div class="toggle-switch"></div>
        </label>
    </div>

    <button class="btn btn-primary" onclick="calculate()">ğŸš€ ç²¾ç®—ã‚’å®Ÿè¡Œã™ã‚‹</button>

    <div id="resultArea">
        <div class="card" style="border-top: 6px solid var(--primary); margin-top:30px;">
            <div class="result-header">
                <label>1äººã‚ãŸã‚Šã®å¾´åé¡ï¼ˆã‚¬ã‚½ãƒªãƒ³ä»£ï¼‰</label>
                <span class="price-tag" id="resPerPerson">0å††</span>
                <small id="resTargetDetail" style="color:var(--text-sub)"></small>
            </div>

            <div class="res-section">
                <label style="margin-bottom:10px; display:block;">ğŸš— ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¸ã®æ”¯æ‰•ã„å†…è¨³</label>
                <div id="resDriverList"></div>
            </div>

            <div class="res-section" style="margin-top:20px; padding-top:15px; border-top: 1px dashed var(--input-border);">
                <label>ğŸ’° ã‚µãƒ¼ã‚¯ãƒ«ä¼šè¨ˆã‹ã‚‰ã®æ”¯å‡º</label>
                <div style="font-size:0.9rem; display: flex; justify-content: space-between; margin-top:5px;">
                    <span>çµŒè²»ãƒ»èª¿æ•´è²»ã®åˆè¨ˆ</span>
                    <span id="resCircleExpense">0å††</span>
                </div>
                <div style="font-size:0.9rem; display: flex; justify-content: space-between; color: var(--primary);">
                    <span>ç«¯æ•°å……å½“é¡ï¼ˆå‚åŠ è€…ã‹ã‚‰ã®ä½™å‰°é‡‘ï¼‰</span>
                    <span id="resGasSurplus">0å††</span>
                </div>
                
                <div class="withdraw-box">
                    <span>ä¼šè¨ˆã‹ã‚‰ã®å®Ÿæ”¯å‡º</span>
                    <span id="resWithdraw">0å††</span>
                </div>
            </div>
        </div>

        <div class="card" style="background: #263238; color: white;">
            <h2 style="color: white; border-color: #546e7a;">ğŸ“± LINEé€ä¿¡ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h2>
            <div class="copy-box">
                <textarea id="copyTextarea" readonly></textarea>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-copy" onclick="copyToClipboard()">ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
                    <a id="btnLineShare" href="#" target="_blank" class="btn btn-line" style="display:none; width:100%;">ğŸ’¬ LINEã§é€ã‚‹</a>
                </div>
            </div>
        </div>
    </div>

    <div style="margin-top: 30px; border-top: 1px solid var(--input-border); padding-top: 20px;">
        <details>
            <summary style="cursor: pointer; color: var(--text-sub); font-weight: bold;">ğŸ“‚ å±¥æ­´</summary>
            <div style="margin-top: 15px;">
                <button class="btn btn-history" onclick="saveToHistory()">ğŸ’¾ ç¾åœ¨ã®å…¥åŠ›ã‚’å±¥æ­´ã«ä¿å­˜</button>
                <ul id="historyList" class="history-list">
                    <li style="text-align:center; color:var(--text-sub); padding:10px;">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</li>
                </ul>
            </div>
        </details>
        <button class="btn btn-reset" onclick="resetRoom()">âš ï¸ å…¥åŠ›ã‚’å…¨ã¦ã‚¯ãƒªã‚¢ (å…¨å“¡ã®ç”»é¢ã‹ã‚‰æ¶ˆå»)</button>
    </div>
</div>

<div id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAypqRPRn-YHWLwjT3lQ6pN6_bWBqzUvp4",
  authDomain: "sanpo-seisan.firebaseapp.com",
  databaseURL: "https://sanpo-seisan-default-rtdb.firebaseio.com",
  projectId: "sanpo-seisan",
  storageBucket: "sanpo-seisan.firebasestorage.app",
  messagingSenderId: "709215338656",
  appId: "1:709215338656:web:c2b0dbc9aceb0fa60f89c5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let roomId = new URLSearchParams(window.location.search).get("room");
if (!roomId) {
    roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
    const newUrl = window.location.pathname + "?room=" + roomId;
    window.history.replaceState(null, null, newUrl);
}
document.getElementById('dispRoomId').textContent = roomId;

const roomRef = ref(db, 'sessions/' + roomId);

window.pushData = debounce(pushDataToFirebase, 500);
window.handleAddCarBtn = handleAddCarBtn;
window.resetRoom = resetRoom;
window.saveToHistory = saveToHistory;
window.loadFromHistory = loadFromHistory;
window.deleteHistory = deleteHistory;

renderHistoryList();

onValue(roomRef, (snapshot) => {
    const data = snapshot.val();
    const syncText = document.getElementById("syncText");
    
    if (data) {
        syncText.textContent = "åŒæœŸå®Œäº†";
        renderForm(data);
    } else {
        syncText.textContent = "æ–°è¦ãƒ«ãƒ¼ãƒ ";
        if(document.getElementById('carList').children.length === 0) {
            addCarToDOM(null, 0, true);
        }
    }
});

function renderForm(data) {
    setValIfDiff('totalPeople', data.total);
    setCheckIfDiff('organizerFree', data.org);
    setValIfDiff('roundingUnit', data.rounding);

    const carList = document.getElementById('carList');
    const remoteCars = data.cars || [];
    
    const currentCards = carList.getElementsByClassName('car-card');
    
    while(currentCards.length < remoteCars.length) {
        addCarToDOM(null, currentCards.length, true);
    }
    while(currentCards.length > remoteCars.length) {
        carList.removeChild(carList.lastChild);
    }

    Array.from(currentCards).forEach((card, i) => {
        const cData = remoteCars[i];
        
        const inputs = {
            name: card.querySelector('.inp-name'),
            dist: card.querySelector('.inp-dist'),
            eco: card.querySelector('.inp-eco'),
            price: card.querySelector('.inp-price')
        };
        
        if(document.activeElement !== inputs.name) inputs.name.value = cData.name || "";
        if(document.activeElement !== inputs.dist) inputs.dist.value = cData.dist || "";
        if(document.activeElement !== inputs.eco) inputs.eco.value = cData.eco || "";
        if(document.activeElement !== inputs.price) inputs.price.value = cData.price || "";
        
        const title = card.querySelector('.car-title-text');
        const dName = cData.name || `è»Šä¸¡ ${i + 1}`;
        title.textContent = `ğŸš™ ${dName}`;

        const extrasBox = card.querySelector('.extra-section div[id^="extras-"]');
        if(!extrasBox) return;

        const remoteExtras = cData.extras || [];
        const currentExtras = extrasBox.getElementsByClassName('extra-item');

        while(currentExtras.length < remoteExtras.length) {
            addExtraToDOM(extrasBox, "", "");
        }
        while(currentExtras.length > remoteExtras.length) {
            extrasBox.removeChild(extrasBox.lastChild);
        }

        Array.from(currentExtras).forEach((row, j) => {
            const exData = remoteExtras[j];
            const nameInp = row.querySelector('.ex-name');
            const amtInp = row.querySelector('.ex-amount');
            
            if(document.activeElement !== nameInp) nameInp.value = exData.name || "";
            if(document.activeElement !== amtInp) amtInp.value = exData.amount || "";
        });
    });
}

function setValIfDiff(id, val) {
    const el = document.getElementById(id);
    if (el && document.activeElement !== el && el.value != val) {
        el.value = val || "";
    }
}
function setCheckIfDiff(id, val) {
    const el = document.getElementById(id);
    if (el && el.checked != val) {
        el.checked = val || false;
    }
}

function pushDataToFirebase() {
    const data = getFormData();
    document.getElementById("syncText").textContent = "ä¿å­˜ä¸­...";
    set(roomRef, data).then(() => {
        document.getElementById("syncText").textContent = "åŒæœŸå®Œäº†";
    }).catch((e) => {
        document.getElementById("syncText").textContent = "ã‚¨ãƒ©ãƒ¼";
        console.error(e);
    });
}

function debounce(func, wait) {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
    };
}

function getFormData() {
    const cards = document.querySelectorAll('.car-card');
    const carDatas = Array.from(cards).map(card => ({
        name: card.querySelector('.inp-name').value, 
        dist: card.querySelector('.inp-dist').value,
        eco: card.querySelector('.inp-eco').value, 
        price: card.querySelector('.inp-price').value,
        extras: Array.from(card.querySelectorAll('.extra-item')).map(row => ({ 
            name: row.querySelector('.ex-name').value, 
            amount: row.querySelector('.ex-amount').value 
        }))
    }));
    return {
        total: document.getElementById('totalPeople').value,
        org: document.getElementById('organizerFree').checked,
        rounding: document.getElementById('roundingUnit').value,
        cars: carDatas,
        updatedAt: Date.now()
    };
}

function resetRoom() {
    if(confirm("ãƒ«ãƒ¼ãƒ ã®å…¥åŠ›ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚\nï¼ˆä»–ã®å‚åŠ è€…ã®ç”»é¢ã‹ã‚‰ã‚‚æ¶ˆãˆã¾ã™ï¼‰")) {
        set(roomRef, null).then(() => {
            window.location.reload();
        });
    }
}

function saveToHistory() {
    const data = getFormData();
    if(!data.total && data.cars.length === 1 && !data.cars[0].dist) {
        showToast("âš ï¸ ç©ºã®ãƒ‡ãƒ¼ã‚¿ã¯ä¿å­˜ã§ãã¾ã›ã‚“");
        return;
    }
    
    const history = JSON.parse(localStorage.getItem('sanpo_history_v4') || "[]");
    const summary = `${data.total || "?"}å / è»Š${data.cars.length}å°`;
    history.unshift({ 
        date: new Date().toLocaleString(), 
        summary: summary,
        data: data 
    });
    
    localStorage.setItem('sanpo_history_v4', JSON.stringify(history.slice(0, 5)));
    renderHistoryList();
    showToast("ğŸ’¾ å±¥æ­´ã«ä¿å­˜ã—ã¾ã—ãŸ");
}

function renderHistoryList() {
    const list = document.getElementById('historyList');
    const history = JSON.parse(localStorage.getItem('sanpo_history_v4') || "[]");
    
    if (history.length === 0) {
        list.innerHTML = `<li style="text-align:center; color:var(--text-sub); padding:10px;">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</li>`;
        return;
    }

    list.innerHTML = "";
    history.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = 'history-item';
        li.innerHTML = `
            <div class="history-info">
                <span class="history-date">${item.date}</span>
                <span>${item.summary}</span>
            </div>
            <div>
                <button class="btn-del-hist" onclick="deleteHistory(${index})">ğŸ—‘ï¸</button>
                <button class="btn-load" onclick="loadFromHistory(${index})">å¾©å…ƒ</button>
            </div>
        `;
        list.appendChild(li);
    });
}

function loadFromHistory(index) {
    if(!confirm("ç¾åœ¨ã®å…¥åŠ›ã‚’ä¸Šæ›¸ãã—ã¦ã€å±¥æ­´ã‹ã‚‰å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆãƒ«ãƒ¼ãƒ å†…ã®å…¨å“¡ã«åæ˜ ã•ã‚Œã¾ã™ï¼‰")) return;

    const history = JSON.parse(localStorage.getItem('sanpo_history_v4') || "[]");
    const item = history[index];
    if(item && item.data) {
        set(roomRef, item.data).then(() => {
            showToast("ğŸ“‚ å±¥æ­´ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸ");
            document.querySelector('details').open = false;
        });
    }
}

function deleteHistory(index) {
    if(!confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    const history = JSON.parse(localStorage.getItem('sanpo_history_v4') || "[]");
    history.splice(index, 1);
    localStorage.setItem('sanpo_history_v4', JSON.stringify(history));
    renderHistoryList();
}


function handleAddCarBtn() {
    addCarToDOM();
    pushDataToFirebase();
}

window.addCarToDOM = function(data = null, idx = -1, forceOpen = false) {
    const list = document.getElementById('carList');
    if (idx === -1) idx = list.children.length;
    
    if(list.children[idx]) return;

    const div = document.createElement('div');
    const isOpen = forceOpen ? 'open' : 'open';
    div.className = `car-card ${isOpen}`;
    const onInput = `oninput="window.pushData()"`;
    const extrasId = `extras-${Date.now()}-${Math.random().toString(36).substr(2,5)}`;

    div.innerHTML = `
        <div class="car-header" onclick="this.parentElement.classList.toggle('open')">
            <span class="car-title-text">ğŸš™ è»Šä¸¡ ${idx + 1}</span>
            <div style="display:flex; align-items:center; gap:12px;">
                <button class="remove-btn" onclick="removeCar(event, this)" title="å‰Šé™¤">ğŸ—‘ï¸</button>
                <span class="toggle-icon">â–¼</span>
            </div>
        </div>
        <div class="car-body">
            <div class="input-group">
                <label>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼åï¼ˆä»»æ„ï¼‰</label>
                <input type="text" class="inp-name" placeholder="æ°å" ${onInput}>
            </div>
            <div class="flex-row">
                <div class="input-group"><label>è·é›¢<small style="font-size:0.75em; font-weight:normal; margin-left:2px">(km)</small><span style="color:var(--danger)">*</span></label><input type="number" class="inp-dist" placeholder="ä¾‹: 250" inputmode="decimal" ${onInput}></div>
                <div class="input-group"><label>ç‡ƒè²»<small style="font-size:0.75em; font-weight:normal; margin-left:2px">(km/L)</small><span style="color:var(--danger)">*</span></label><input type="number" class="inp-eco" placeholder="ä¾‹: 15" inputmode="decimal" ${onInput}></div>
                <div class="input-group"><label>ã‚¬ã‚½ãƒªãƒ³ä¾¡æ ¼<small style="font-size:0.75em; font-weight:normal; margin-left:2px">(å††)</small><span style="color:var(--danger)">*</span></label><input type="number" class="inp-price" placeholder="ä¾‹: 170" inputmode="numeric" ${onInput}></div>
            </div>
            <div class="extra-section">
                <label style="margin-bottom:8px; display:block; font-size:0.8rem;">â• è«¸è²»ç”¨ï¼ˆé«˜é€Ÿãƒ»é§è»Šå ´ä»£ãªã©ï¼‰</label>
                <div id="${extrasId}"></div>
                <button class="btn-reset" style="padding:0; margin:10px 0 0 0; text-align:left; font-size:0.8rem;" onclick="handleAddExtra(this)">+ çµŒè²»ã‚’è¿½åŠ </button>
            </div>
        </div>
    `;
    list.appendChild(div);
}

window.removeCar = function(e, btn){ 
    e.stopPropagation(); 
    if(confirm("ã“ã®è»Šä¸¡æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { 
        btn.closest('.car-card').remove(); 
        pushDataToFirebase();
    } 
}

window.handleAddExtra = function(btn) {
    const box = btn.previousElementSibling;
    addExtraToDOM(box);
    pushDataToFirebase();
}

function addExtraToDOM(container, name="", amount="") {
    const div = document.createElement('div');
    div.className = 'extra-item';
    div.innerHTML = `
        <input type="text" class="ex-name" placeholder="åç›®" value="${name}" style="flex:2; padding:10px;" oninput="window.pushData()">
        <input type="number" class="ex-amount" placeholder="é‡‘é¡" value="${amount}" style="flex:1; padding:10px;" inputmode="numeric" oninput="window.pushData()">
        <button class="remove-btn" style="width:35px; border-radius:4px; font-size:1.2rem; padding:0;" onclick="this.parentElement.remove(); window.pushData();">Ã—</button>
    `;
    container.appendChild(div);
}

window.calculate = function() {
    const data = getFormData();
    const totalPeople = parseInt(data.total);
    const isOrgFree = data.org;
    
    let errorMsgs = [];
    if (!totalPeople || totalPeople <= 0) errorMsgs.push("ãƒ»å‚åŠ äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    if (data.cars.length === 0) errorMsgs.push("ãƒ»è»Šä¸¡ãŒ1å°ã‚‚ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“");

    data.cars.forEach((c, index) => {
        const dName = c.name || `è»Šä¸¡ ${index + 1}`;
        if(!c.dist) errorMsgs.push(`ãƒ»${dName}: èµ°è¡Œè·é›¢ãŒæœªå…¥åŠ›ã§ã™`);
        if(!c.eco) errorMsgs.push(`ãƒ»${dName}: ç‡ƒè²»ãŒæœªå…¥åŠ›ã§ã™`);
        if(!c.price) errorMsgs.push(`ãƒ»${dName}: ã‚¬ã‚½ãƒªãƒ³ä¾¡æ ¼ãŒæœªå…¥åŠ›ã§ã™`);
    });

    if (errorMsgs.length > 0) { alert("âš ï¸ å…¥åŠ›ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™:\n" + errorMsgs.join("\n")); return; }

    let totalGas = 0; let totalExtras = 0; let totalReward = 0;
    let driverResults = []; 

    data.cars.forEach((c) => {
        const name = c.name || "ãƒ‰ãƒ©ã‚¤ãƒãƒ¼";
        const dist = parseFloat(c.dist) || 0;
        const eco = parseFloat(c.eco) || 1;
        const price = parseFloat(c.price) || 0;
        const gasCost = Math.round((dist / eco) * price);
        
        let extrasTotal = 0; 
        let exs = [];
        c.extras.forEach(ex => {
            const val = parseInt(ex.amount) || 0;
            const nm = ex.name || "è«¸çµŒè²»";
            if(val > 0) { extrasTotal += val; exs.push({name: nm, amount: val}); }
        });

        const reward = 1000; 
        totalGas += gasCost; 
        totalExtras += extrasTotal; 
        totalReward += reward;

        driverResults.push({
            name,
            totalPay: gasCost + extrasTotal + reward,
            gasCost,
            reward,
            extras: exs,
            extrasTotal
        });
    });

    const payers = isOrgFree ? (totalPeople - 1) : totalPeople;
    const roundUnit = parseInt(data.rounding);
    const perPersonGas = payers > 0 ? Math.ceil((totalGas / payers) / roundUnit) * roundUnit : 0;
    
    const collectedGasTotal = perPersonGas * payers;
    const gasSurplus = collectedGasTotal - totalGas;
    const circleNeed = (totalExtras + totalReward) - gasSurplus;

    document.getElementById('resPerPerson').textContent = perPersonGas.toLocaleString() + " å††";
    document.getElementById('resTargetDetail').innerHTML = `å¾´åäººæ•°ï¼š${payers}å ï¼ ã‚¬ã‚½ãƒªãƒ³ä»£å®Ÿè²»åˆè¨ˆï¼š${totalGas.toLocaleString()}å††<br>ï¼ˆç«¯æ•°å‡¦ç†: ${roundUnit}å††å˜ä½ï¼‰`;
    
    const dList = document.getElementById('resDriverList'); 
    dList.innerHTML = "";
    driverResults.forEach(d => {
        const row = document.createElement('div'); 
        row.className = 'driver-row';
        let extrasHtml = "";
        if(d.extras.length > 0) {
            d.extras.forEach(ex => {
                extrasHtml += `<div class="detail-line"><span>${ex.name}</span><span>${ex.amount.toLocaleString()}å††</span></div>`;
            });
            extrasHtml = `<div class="detail-group"><div class="detail-label">ç«‹æ›¿çµŒè²»</div>${extrasHtml}</div>`;
        }
        row.innerHTML = `
            <div class="driver-main">
                <span class="driver-name">${d.name} æ§˜</span>
                <span class="driver-total-price">${d.totalPay.toLocaleString()} å††</span>
            </div>
            <div>
                <div class="detail-line"><span>ã‚¬ã‚½ãƒªãƒ³ä»£</span><span>${d.gasCost.toLocaleString()}å††</span></div>
                <div class="detail-line"><span>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼èª¿æ•´è²»</span><span>${d.reward.toLocaleString()}å††</span></div>
            </div>
            ${extrasHtml}
        `;
        dList.appendChild(row);
    });

    document.getElementById('resCircleExpense').textContent = (totalExtras + totalReward).toLocaleString() + " å††";
    document.getElementById('resGasSurplus').textContent = "-" + gasSurplus.toLocaleString() + " å††";
    document.getElementById('resWithdraw').textContent = circleNeed.toLocaleString() + " å††";
    document.getElementById('resultArea').style.display = 'block';
    
    document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });

    let lineText = `ã€å±±æ­©ä¼š ç²¾ç®—å ±å‘Š ğŸš™ã€‘\n`;
    lineText += `â– å¾´åé¡ï¼ˆã‚¬ã‚½ãƒªãƒ³ä»£ï¼‰\n1äººï¼š${perPersonGas.toLocaleString()}å††\n`;
    if(isOrgFree) lineText += `ï¼ˆâ€»ä¼ç”»è€…ã¯å…é™¤ï¼‰\n`;
    
    lineText += `\nâ– ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¸ã®æ”¯æ‰•é¡\n`;
    driverResults.forEach(d => {
        lineText += `ãƒ»${d.name}ã•ã‚“ï¼š${d.totalPay.toLocaleString()}å††\n`;
        lineText += `  (ã‚¬ã‚¹:${d.gasCost.toLocaleString()} / èª¿æ•´:${d.reward.toLocaleString()}`;
        if (d.extrasTotal > 0) lineText += ` / ç«‹æ›¿:${d.extrasTotal.toLocaleString()}`;
        lineText += `)\n`;
    });
    
    lineText += `\nâ– ã‚µãƒ¼ã‚¯ãƒ«ä¼šè¨ˆã‹ã‚‰ã®æ”¯å‡º\nè¨ˆï¼š${circleNeed.toLocaleString()}å††\n\nãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼`;
    lineText += `\n\nâ–¼è¨ˆç®—ãƒ»ç·¨é›†URL\n${window.location.href}`;

    document.getElementById('copyTextarea').value = lineText;

    const encodedText = encodeURIComponent(lineText);
    const lineBtn = document.getElementById('btnLineShare');
    lineBtn.href = `https://line.me/R/msg/text/?${encodedText}`;
    lineBtn.style.display = 'flex';
}

window.copyRoomLink = function() {
    const url = window.location.href;
    if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => showToast("ğŸ“‹ å…±æœ‰URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼<br>ä»²é–“ã«é€ä¿¡ã—ã¦ãã ã•ã„ã€‚"));
    } else {
        const ta = document.createElement("textarea");
        ta.value = url;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        showToast("ğŸ“‹ å…±æœ‰URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
    }
}

window.copyToClipboard = function() {
    const textarea = document.getElementById('copyTextarea');
    textarea.select(); document.execCommand('copy');
    showToast("âœ… çµæœãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
}

function showToast(msg) {
    const toast = document.getElementById("toast");
    toast.innerHTML = msg;
    toast.className = "show";
    setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
}
</script>
</body>
</html>
