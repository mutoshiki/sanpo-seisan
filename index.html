<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å±±æ­©ä¼šä¼šè¨ˆç²¾ç®—ãƒ„ãƒ¼ãƒ«</title>

<style>
:root{
    --main: #2c3e50;
    --accent: #27ae60;
    --danger: #c0392b;
    --history: #2980b9;
    --bg: #f8f9fa;
    --card: #ffffff;
    --border: #e9ecef;
    --radius: 8px;
}

*{box-sizing:border-box}
body{
    font-family: "Helvetica Neue", Arial, sans-serif;
    margin:0;
    padding:20px 10px;
    background: var(--bg);
    color: #333;
}

.container{
    max-width: 600px;
    margin: 0 auto;
    background: var(--card);
    padding: 24px;
    border-radius: var(--radius);
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

h1{ text-align: center; color: var(--main); font-size: 1.4rem; margin-bottom: 24px; }
h2{ font-size: 1.1rem; border-left: 5px solid var(--accent); padding-left: 10px; margin-top: 30px; color: var(--main); }

label{ display: block; font-weight: bold; font-size: 0.9rem; margin-top: 12px; margin-bottom: 4px; color: #555; }
input[type="number"], input[type="text"]{
    width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px;
}

.car-card{
    background: #fff; border: 1px solid #ddd; border-radius: var(--radius);
    padding: 16px; margin-bottom: 16px; border-top: 4px solid var(--main);
}
.car-header{ display: flex; justify-content: space-between; margin-bottom: 10px; }
.remove-btn{ color: var(--danger); background: none; border: none; cursor: pointer; font-size: 1.2rem; }

.extra-list{ background: #f1f3f5; padding: 10px; border-radius: 4px; margin-top: 5px; }
.extra-item{ display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }

.btn-primary{ width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 50px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 20px; }
.btn-outline{ width: 100%; padding: 10px; background: white; border: 2px dashed #aaa; color: #555; cursor: pointer; margin-top: 10px; }
.btn-mini{ background: #ddd; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
.btn-reset{ width: 100%; padding: 10px; background: #eee; border: none; color: #666; margin-top: 10px; border-radius: 50px; cursor: pointer; }

#resultArea{
    display: none; margin-top: 30px; background: #e3fcef; padding: 20px;
    border-radius: var(--radius); border: 2px solid var(--accent);
}
.res-block{ margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed #aecbba; }
.price-large{ font-size: 1.8rem; font-weight: bold; color: var(--accent); }
.circle-cost{ color: var(--danger); font-weight: bold; font-size: 1.2rem; }

.check-group{ display: flex; align-items: center; gap: 10px; background: #fff3cd; padding: 10px; border-radius: 4px; margin-top: 10px; border: 1px solid #ffeeba; }

/* ã‚³ãƒ”ãƒšã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.copy-area {
    margin-top: 15px;
    background: #fff;
    padding: 10px;
    border-radius: 4px;
    border: 1px solid #ccc;
}
#copyTextarea {
    width: 100%;
    height: 120px;
    font-size: 0.85rem;
    border: none;
    resize: none;
    background: transparent;
    font-family: inherit;
    color: #333;
}
.btn-copy {
    background: #555;
    color: white;
    border: none;
    padding: 8px;
    width: 100%;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    margin-top: 5px;
}

/* å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.history-section { margin-top: 40px; border-top: 2px solid #ddd; padding-top: 20px; }
.history-item { 
    background: #fff; border: 1px solid #eee; padding: 10px; margin-bottom: 8px; 
    border-radius: 6px; display: flex; justify-content: space-between; align-items: center;
}
.history-info { font-size: 0.85rem; color: #666; }
.btn-restore { background: var(--history); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
.btn-del-history { color: var(--danger); background: none; border: none; cursor: pointer; margin-left: 10px; }

</style>
</head>
<body>

<div class="container">
    <h1>ğŸš™å±±æ­©ä¼šä¼šè¨ˆç²¾ç®—ãƒ„ãƒ¼ãƒ«</h1>

    <label>ä»Šå›ã®å‚åŠ äººæ•°ï¼ˆä¼ç”»è€…å«ã‚€ï¼‰</label>
    <input type="number" id="totalPeople" placeholder="ä¾‹: 12">

    <div class="check-group">
        <input type="checkbox" id="organizerFree">
        <label for="organizerFree">ä¼ç”»è€…ã¯ã€Œã‚¬ã‚½ãƒªãƒ³ä»£ã€ç„¡æ–™</label>
    </div>

    <h2>è»Šä¸¡ãƒ»ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ç™»éŒ²</h2>
    <div id="carList"></div>
    <button class="btn-outline" onclick="addCar()">+ è»Šä¸¡ã‚’è¿½åŠ </button>

    <button class="btn-primary" onclick="calculate()">è¨ˆç®—ã™ã‚‹</button>
    <button class="btn-reset" onclick="resetAll()">å…¥åŠ›ã‚’ç©ºã«ã™ã‚‹</button>

    <div id="resultArea">
        <div class="res-block">
            <div class="res-title" style="font-weight:bold;">â‘  å‚åŠ è€…ã§å‰²ã‚Šå‹˜ã™ã‚‹ã‚¬ã‚½ãƒªãƒ³ä»£</div>
            <div class="price-large" id="resPerPerson">0å††</div>
            <div id="resTargetDetail" style="font-size:0.9rem; color:#555;"></div>
        </div>

        <div class="res-block">
            <div class="res-title" style="font-weight:bold;">â‘¡ å„ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¸ã®æ”¯æ‰•é‡‘é¡</div>
            <div id="resDriverList"></div>
        </div>

        <div class="res-block">
            <div class="res-title" style="font-weight:bold;">â‘¢ ã‚µãƒ¼ã‚¯ãƒ«ä¼šè¨ˆã®ç²¾ç®—çµæœ</div>
            <div style="font-size:0.9rem;">
                è«¸çµŒè²»ãƒ»èª¿æ•´è²»åˆè¨ˆï¼š<span id="resCircleExpense">0</span> å††<br>
                ã‚¬ã‚½ãƒªãƒ³ä»£ã®ç«¯æ•°ï¼ˆåˆ‡ã‚Šä¸Šã’åˆ†ï¼‰ï¼š<span id="resGasSurplus" style="color:#27ae60">0</span> å†† (ã‚µãƒ¼ã‚¯ãƒ«ä¼šè¨ˆã«å……å½“)<br>
                <div style="margin-top:8px; padding-top:8px; border-top:1px solid #ccc;">
                    <strong>ã‚µãƒ¼ã‚¯ãƒ«ä¼šè¨ˆã‹ã‚‰ã®æ”¯å‡ºé¡ï¼š</strong><br>
                    <span class="circle-cost" id="resWithdraw">0 å††</span>
                </div>
            </div>
        </div>

        <div class="res-block" style="border-bottom:none;">
            <div class="res-title" style="font-weight:bold;">ğŸ“² LINEé€ä¿¡ç”¨ãƒ†ã‚­ã‚¹ãƒˆ</div>
            <div class="copy-area">
                <textarea id="copyTextarea" readonly></textarea>
                <button class="btn-copy" onclick="copyToClipboard()">ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <div class="history-section">
        <h2 style="border-left-color: var(--history);">ç²¾ç®—å±¥æ­´</h2>
        <div id="historyList"></div>
    </div>
</div>

<script>
const DEFAULT_CAR = { name: "", dist: "", eco: "", price: "", extras: [] };

window.onload = function() {
    loadDraft();
    updateHistory();
};

function addCar(data = null) {
    const list = document.getElementById('carList');
    const idx = list.children.length;
    const c = data || { ...DEFAULT_CAR, extras: [] };

    const div = document.createElement('div');
    div.className = 'car-card';
    div.innerHTML = `
        <div class="car-header">
            <strong>è»Šä¸¡ ${idx+1}</strong>
            <button class="remove-btn" onclick="removeCar(this)">Ã—</button>
        </div>
        <label>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼å</label>
        <input type="text" class="inp-name" value="${c.name}" placeholder="æ°å">
        <div style="display:flex; gap:5px;">
            <div style="flex:1"><label>è·é›¢km</label><input type="number" class="inp-dist" value="${c.dist}"></div>
            <div style="flex:1"><label>ç‡ƒè²»km/L</label><input type="number" class="inp-eco" value="${c.eco}"></div>
            <div style="flex:1"><label>å˜ä¾¡/L</label><input type="number" class="inp-price" value="${c.price}"></div>
        </div>
        <label>è«¸è²»ç”¨ï¼ˆé«˜é€Ÿãƒ»ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼ç­‰ï¼‰</label>
        <div class="extra-list" id="extras-${idx}"></div>
        <button class="btn-mini" onclick="addExtra(${idx})" style="margin-top:5px;">+ çµŒè²»è¿½åŠ </button>
    `;
    list.appendChild(div);
    if(c.extras) c.extras.forEach(ex => addExtra(idx, ex.name, ex.amount));
}

function addExtra(idx, name="", amount="") {
    const box = document.getElementById(`extras-${idx}`);
    const div = document.createElement('div');
    div.className = 'extra-item';
    div.innerHTML = `
        <input type="text" class="ex-name" placeholder="åç›®" value="${name}" style="flex:2">
        <input type="number" class="ex-amount" placeholder="é‡‘é¡" value="${amount}" style="flex:1">
        <button class="remove-btn" style="font-size:1rem;" onclick="this.parentElement.remove()">Ã—</button>
    `;
    box.appendChild(div);
}

function removeCar(btn){ btn.closest('.car-card').remove(); saveDraft(); }

function calculate() {
    const totalPeople = parseInt(document.getElementById('totalPeople').value);
    const isOrgFree = document.getElementById('organizerFree').checked;
    if (!totalPeople) { alert("äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    const cards = document.querySelectorAll('.car-card');
    let totalGas = 0; let totalExtras = 0; let totalReward = 0;
    let drivers = [];
    let carDatas = [];

    cards.forEach((card) => {
        const name = card.querySelector('.inp-name').value || "åç„¡ã—";
        const dist = parseFloat(card.querySelector('.inp-dist').value) || 0;
        const eco = parseFloat(card.querySelector('.inp-eco').value) || 1;
        const price = parseFloat(card.querySelector('.inp-price').value) || 0;
        const gas = Math.round((dist / eco) * price);
        
        let extras = 0; let exs = [];
        card.querySelectorAll('.extra-item').forEach(row => {
            const val = parseInt(row.querySelector('.ex-amount').value) || 0;
            const nm = row.querySelector('.ex-name').value || "çµŒè²»";
            if(val > 0) { extras += val; exs.push({name: nm, amount: val}); }
        });

        totalGas += gas; totalExtras += extras; totalReward += 1000;
        drivers.push({ name, pay: gas + extras + 1000, desc: `(ã‚¬ã‚¹${gas.toLocaleString()} + è«¸è²»${extras.toLocaleString()} + èª¿æ•´1000)` });
        carDatas.push({ name, dist, eco, price, extras: exs });
    });

    const payers = isOrgFree ? (totalPeople - 1) : totalPeople;
    const perPersonGas = Math.ceil((totalGas / payers) / 100) * 100;
    const collectedGasTotal = perPersonGas * payers;
    const gasSurplus = collectedGasTotal - totalGas;
    const circleNeed = (totalExtras + totalReward) - gasSurplus;

    // è¡¨ç¤ºåæ˜ 
    document.getElementById('resPerPerson').textContent = perPersonGas.toLocaleString() + " å††";
    document.getElementById('resTargetDetail').innerHTML = `å¯¾è±¡: ${payers}å / ã‚¬ã‚½ãƒªãƒ³ç·é¡: ${totalGas.toLocaleString()}å††`;
    
    const dList = document.getElementById('resDriverList');
    dList.innerHTML = "";
    drivers.forEach(d => {
        const row = document.createElement('div');
        row.style.cssText = "display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:8px 0;";
        row.innerHTML = `<div><strong>${d.name}</strong><br><small style="color:#666">${d.desc}</small></div><div style="font-weight:bold;">${d.pay.toLocaleString()} å††</div>`;
        dList.appendChild(row);
    });

    document.getElementById('resCircleExpense').textContent = (totalExtras + totalReward).toLocaleString();
    document.getElementById('resGasSurplus').textContent = "-" + gasSurplus.toLocaleString();
    document.getElementById('resWithdraw').textContent = circleNeed.toLocaleString() + " å††";
    document.getElementById('resultArea').style.display = 'block';

    // LINEãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
    let lineText = `ã€ç²¾ç®—å ±å‘Šã€‘\n`;
    lineText += `â– å‚åŠ è€…å¾´åï¼ˆã‚¬ã‚½ãƒªãƒ³ä»£ã®ã¿ï¼‰\n1äººï¼š${perPersonGas.toLocaleString()}å††\n`;
    if(isOrgFree) lineText += `â€»ä¼ç”»è€…ã¯ç„¡æ–™ã§ã™\n`;
    lineText += `\nâ– å„ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¸æ”¯æ‰•ã„\n`;
    drivers.forEach(d => { lineText += `ãƒ»${d.name}ã•ã‚“ï¼š${d.pay.toLocaleString()}å††\n`; });
    lineText += `\nâ– ã‚µãƒ¼ã‚¯ãƒ«ä¼šè¨ˆã‚ˆã‚Šæ”¯å‡º\nåˆè¨ˆï¼š${circleNeed.toLocaleString()}å††`;
    document.getElementById('copyTextarea').value = lineText;

    saveToHistory({
        date: new Date().toLocaleString(),
        totalPeople,
        isOrgFree,
        cars: carDatas,
        perPersonGas
    });
}

function copyToClipboard() {
    const textarea = document.getElementById('copyTextarea');
    textarea.select();
    document.execCommand('copy');
    alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼LINEã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");
}

function saveToHistory(data) {
    let history = JSON.parse(localStorage.getItem('gas_history') || "[]");
    history.unshift(data);
    if(history.length > 10) history.pop();
    localStorage.setItem('gas_history', JSON.stringify(history));
    updateHistory();
}

function updateHistory() {
    const history = JSON.parse(localStorage.getItem('gas_history') || "[]");
    const container = document.getElementById('historyList');
    container.innerHTML = history.length === 0 ? "<p style='font-size:0.8rem; color:#999;'>å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>" : "";
    history.forEach((h, i) => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
            <div class="history-info"><strong>${h.date}</strong><br>${h.totalPeople}å / 1äºº ${h.perPersonGas}å†† / è»Šä¸¡${h.cars.length}å°</div>
            <div><button class="btn-restore" onclick="restoreHistory(${i})">å¾©å…ƒ</button><button class="btn-del-history" onclick="deleteHistory(${i})">Ã—</button></div>
        `;
        container.appendChild(div);
    });
}

function restoreHistory(index) {
    if(!confirm("ç¾åœ¨ã®å…¥åŠ›ã‚’ç ´æ£„ã—ã¦ã€ã“ã®å±¥æ­´ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")) return;
    const history = JSON.parse(localStorage.getItem('gas_history') || "[]");
    const data = history[index];
    document.getElementById('totalPeople').value = data.totalPeople;
    document.getElementById('organizerFree').checked = data.isOrgFree;
    document.getElementById('carList').innerHTML = "";
    data.cars.forEach(c => addCar(c));
    document.getElementById('resultArea').style.display = 'none';
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function deleteHistory(index) {
    let history = JSON.parse(localStorage.getItem('gas_history') || "[]");
    history.splice(index, 1);
    localStorage.setItem('gas_history', JSON.stringify(history));
    updateHistory();
}

function saveDraft() {
    const cards = document.querySelectorAll('.car-card');
    const carDatas = Array.from(cards).map(card => {
        const exs = Array.from(card.querySelectorAll('.extra-item')).map(row => ({
            name: row.querySelector('.ex-name').value,
            amount: row.querySelector('.ex-amount').value
        }));
        return {
            name: card.querySelector('.inp-name').value,
            dist: card.querySelector('.inp-dist').value,
            eco: card.querySelector('.inp-eco').value,
            price: card.querySelector('.inp-price').value,
            extras: exs
        };
    });
    const draft = {
        total: document.getElementById('totalPeople').value,
        org: document.getElementById('organizerFree').checked,
        cars: carDatas
    };
    localStorage.setItem('gas_draft', JSON.stringify(draft));
}

function loadDraft() {
    const raw = localStorage.getItem('gas_draft');
    if(!raw) { addCar(); return; }
    const d = JSON.parse(raw);
    document.getElementById('totalPeople').value = d.total;
    document.getElementById('organizerFree').checked = d.org;
    if(d.cars.length) d.cars.forEach(c => addCar(c)); else addCar();
}

function resetAll() {
    if(confirm("å…¥åŠ›ã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿï¼ˆå±¥æ­´ã¯æ¶ˆãˆã¾ã›ã‚“ï¼‰")) {
        localStorage.removeItem('gas_draft');
        location.reload();
    }
}
document.addEventListener('input', saveDraft);
</script>

</body>
</html>
