<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å±±æ­©ä¼šä¼šè¨ˆç²¾ç®—ãƒ„ãƒ¼ãƒ« v5.8</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
:root {
    /* --- [Light Mode] å¤§äººã£ã½ã„ã‚¯ãƒ©ã‚·ãƒƒã‚¯ãƒ»ãƒã‚¤ãƒ“ãƒ¼ --- */
    --primary: #2c3e50;       /* æ¿ƒç´ºï¼šä¿¡é ¼æ„Ÿ */
    --primary-text: #2c3e50;  /* ãƒ†ã‚­ã‚¹ãƒˆç”¨ãƒ—ãƒ©ã‚¤ãƒãƒª */
    --primary-btn: #2c3e50;   /* ãƒœã‚¿ãƒ³èƒŒæ™¯ */
    --primary-btn-text: #fff; /* ãƒœã‚¿ãƒ³æ–‡å­— */
    
    --primary-light: #ecf0f1; /* è–„ã„ã‚°ãƒ¬ãƒ¼ï¼ˆèƒŒæ™¯ã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼‰ */
    
    --accent: #d35400;        /* ãƒ†ãƒ©ã‚³ãƒƒã‚¿ï¼ˆå¼·èª¿ï¼‰ */
    
    --bg: #f4f6f7;            /* å…¨ä½“èƒŒæ™¯ï¼šã‚ªãƒ•ãƒ›ãƒ¯ã‚¤ãƒˆ */
    --card-bg: #ffffff;       /* ã‚«ãƒ¼ãƒ‰èƒŒæ™¯ï¼šç™½ */
    
    --text-main: #2d3436;     /* ä¸»ãªæ–‡å­—ï¼šæ¿ƒã„ã‚°ãƒ¬ãƒ¼ */
    --text-sub: #636e72;      /* è£œè¶³æ–‡å­—ï¼šã‚°ãƒ¬ãƒ¼ */
    --text-placeholder: #b2bec3;
    
    --border: #dfe6e9;        /* å¢ƒç•Œç·š */
    --input-bg: #ffffff;      /* å…¥åŠ›æ¬„èƒŒæ™¯ */
    --input-border: #bdc3c7;
    
    --radius: 6px;
    --shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    
    --font-head: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif;
    --font-body: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

@media (prefers-color-scheme: dark) {
    :root {
        /* --- [Dark Mode] è¦–èªæ€§é‡è¦–ã®ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ»ãƒŠã‚¤ãƒˆ --- */
        --primary: #8fa6b8;       /* æ˜ã‚‹ã‚ã®ã‚¹ãƒãƒ¼ãƒ«ãƒ–ãƒ«ãƒ¼ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ãƒ»è¦‹å‡ºã—ç”¨ï¼‰ */
        --primary-text: #aab7c4;  /* ãƒ†ã‚­ã‚¹ãƒˆç”¨ã¯ã•ã‚‰ã«æ˜ã‚‹ã */
        --primary-btn: #4b6584;   /* ãƒœã‚¿ãƒ³ã¯å°‘ã—æ˜ã‚‹ã„ç´ºè‰² */
        --primary-btn-text: #f1f2f6;
        
        --primary-light: #252f38; /* é¸æŠæ™‚ã®èƒŒæ™¯ãªã© */
        
        --accent: #e67e22;        /* è½ã¡ç€ã„ãŸã‚ªãƒ¬ãƒ³ã‚¸ */
        
        --bg: #0b0e11;            /* èƒŒæ™¯ï¼šã»ã¼é»’ã«è¿‘ã„ãƒ€ãƒ¼ã‚¯ãƒ–ãƒ«ãƒ¼ã‚°ãƒ¬ãƒ¼ */
        --card-bg: #192229;       /* ã‚«ãƒ¼ãƒ‰ï¼šæ¿ƒã„ãƒãƒ£ã‚³ãƒ¼ãƒ« */
        
        --text-main: #f1f2f6;     /* æ–‡å­—ï¼šã»ã¼ç™½ï¼ˆèª­ã¿ã‚„ã™ã•æœ€å„ªå…ˆï¼‰ */
        --text-sub: #ced6e0;      /* è£œè¶³ï¼šæ˜ã‚‹ã„ã‚°ãƒ¬ãƒ¼ */
        --text-placeholder: #747d8c;
        
        --border: #353b48;        /* å¢ƒç•Œç·šï¼šèƒŒæ™¯ã‚ˆã‚Šå°‘ã—æ˜ã‚‹ã */
        --input-bg: #11151a;      /* å…¥åŠ›æ¬„ï¼šã‚«ãƒ¼ãƒ‰ã‚ˆã‚Šæš—ãï¼ˆçªªã‚“ã§è¦‹ãˆã‚‹ã‚ˆã†ã«ï¼‰ */
        --input-border: #4a5568;  /* å…¥åŠ›æ ï¼šã—ã£ã‹ã‚Šè¦‹ãˆã‚‹ã‚°ãƒ¬ãƒ¼ */
        
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
    font-family: var(--font-body);
    margin: 0; padding: 20px 12px;
    background: var(--bg); color: var(--text-main);
    line-height: 1.6; font-size: 15px;
    transition: background-color 0.3s, color 0.3s;
}

.container { max-width: 600px; margin: 0 auto; padding-bottom: 100px; }

/* --- ãƒ˜ãƒƒãƒ€ãƒ¼å‘¨ã‚Š --- */
header { 
    position: relative; 
    text-align: center; 
    margin-bottom: 30px; 
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border);
}
h1 { 
    font-family: var(--font-head);
    font-size: 1.5rem; margin: 0; color: var(--primary-text); 
    display: flex; align-items: center; justify-content: center; gap: 10px;
    font-weight: 700;
    letter-spacing: 0.05em;
}
h1 i { font-size: 1.4rem; color: var(--accent); }
h1 span { 
    font-size: 0.75rem; 
    background: var(--primary); color: #fff; 
    padding: 2px 6px; border-radius: 4px;
    font-weight: normal; margin-top: 2px; display: inline-block;
    vertical-align: middle;
    text-shadow: none;
    background: var(--primary-btn);
}

/* æ‹›å¾…ã‚¨ãƒªã‚¢ */
.share-invite-box {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-left: 4px solid var(--accent);
    color: var(--text-main);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 24px;
    box-shadow: var(--shadow);
    text-align: center;
}
.share-invite-title {
    font-weight: bold; font-size: 1rem; margin-bottom: 10px;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    color: var(--primary-text);
}
.share-btn-group {
    display: flex; gap: 10px; justify-content: center;
}
.btn-share-action {
    background: var(--primary-light);
    border: 1px solid var(--border);
    color: var(--primary-text);
    padding: 8px 16px;
    border-radius: var(--radius);
    font-size: 0.85rem;
    cursor: pointer;
    text-decoration: none;
    display: flex; align-items: center; gap: 6px;
    transition: all 0.2s;
    font-weight: 600;
}
.btn-share-action:hover { opacity: 0.8; transform: translateY(-1px); }
.btn-share-action:active { transform: scale(0.98); }

.room-badge {
    background: var(--bg); color: var(--text-sub);
    padding: 4px 12px; border-radius: 20px; font-family: monospace; font-size: 0.8rem;
    margin: 12px auto 0; display: inline-flex; align-items: center; gap: 6px; 
    border: 1px solid var(--border);
}

.sync-status {
    font-size: 0.75rem; color: var(--text-sub); font-weight: 500;
    display: flex; align-items: center; justify-content: center; gap: 6px;
    margin-top: 8px;
}
.sync-dot { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; display: inline-block; animation: pulse 2s infinite; }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

/* --- ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³ --- */
.help-trigger {
    position: absolute; right: 0; top: 5px;
    background: none; border: none; color: var(--text-sub);
    font-size: 1.2rem; cursor: pointer; padding: 5px;
    transition: color 0.2s;
}
.help-trigger:hover { color: var(--primary); }

/* --- å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ --- */
.card {
    background: var(--card-bg); padding: 24px; border-radius: var(--radius);
    box-shadow: var(--shadow); margin-bottom: 24px; border: 1px solid var(--border);
}

h2 { 
    font-family: var(--font-head);
    font-size: 1.1rem; margin: 0 0 20px 0; 
    display: flex; align-items: center; gap: 10px; 
    color: var(--primary-text); 
    border-bottom: 1px solid var(--border); padding-bottom: 12px;
}
h2 i { color: var(--text-sub); font-size: 1.1rem; }

/* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
.input-group { margin-bottom: 18px; }
label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; color: var(--text-main); }

input[type="number"], input[type="text"], select {
    width: 100%; padding: 12px; 
    border: 1px solid var(--input-border); border-radius: var(--radius); 
    font-size: 16px; background: var(--input-bg); color: var(--text-main);
    transition: 0.2s; 
}
input:focus, select:focus { 
    outline: none; 
    border-color: var(--primary); 
    box-shadow: 0 0 0 2px rgba(100, 150, 200, 0.2); 
}
input::placeholder { color: var(--text-placeholder); opacity: 0.8; }

.flex-row { display: flex; gap: 12px; }
.flex-row > div { flex: 1; }

/* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ */
.checkbox-card {
    display: flex; align-items: center; justify-content: space-between;
    background: var(--input-bg); padding: 12px 16px; border-radius: var(--radius); 
    cursor: pointer; user-select: none; border: 1px solid var(--input-border);
}
.checkbox-card input { display: none; }
.toggle-switch {
    width: 44px; height: 24px; background: var(--text-sub); border-radius: 20px; position: relative; transition: 0.3s;
}
.toggle-switch::after {
    content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px;
    background: #fff; border-radius: 50%; transition: 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.2);
}
.checkbox-card input:checked + .toggle-switch { background: var(--accent); }
.checkbox-card input:checked + .toggle-switch::after { transform: translateX(20px); }

/* è»Šä¸¡ã‚«ãƒ¼ãƒ‰ */
.car-card {
    border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 16px;
    background: var(--card-bg); overflow: hidden; 
}
.car-header {
    background: var(--bg); padding: 12px 16px;
    display: flex; justify-content: space-between; align-items: center;
    cursor: pointer; font-weight: 600; font-size: 0.95rem; color: var(--text-main);
    border-bottom: 1px solid transparent;
    transition: background 0.2s;
}
.car-card.open .car-header { border-bottom-color: var(--border); background: var(--primary-light); color: var(--primary-text); }
.car-header i { margin-right: 8px; color: var(--text-sub); }
.car-card.open .car-header i { color: var(--primary); }

.car-body { padding: 20px; display: none; background: var(--card-bg); }
.car-card.open .car-body { display: block; }

.toggle-icon { transition: transform 0.3s; font-size: 1rem; color: var(--text-sub); }
.car-card.open .toggle-icon { transform: rotate(180deg); }

.btn-icon-only {
    background: none; border: none; color: var(--text-sub); font-size: 1rem; 
    cursor: pointer; padding: 6px; display: flex; align-items: center; transition: color 0.2s;
}
.btn-icon-only:hover { color: #d32f2f; }

/* è«¸çµŒè²»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.extra-section { 
    background: var(--bg); padding: 16px; border-radius: var(--radius); margin-top: 20px; 
    border: 1px solid var(--border); 
}
.extra-item { display: flex; gap: 8px; margin-bottom: 10px; align-items: center;}
.extra-item .ex-name { flex: 1.5; }
.extra-item .ex-amount { flex: 1; min-width: 0; }
.extra-item .ex-type { flex: 0.8; font-size: 0.8rem; padding: 10px 4px; }

/* ãƒœã‚¿ãƒ³é¡ */
.btn {
    width: 100%; border: none; border-radius: var(--radius); font-size: 1rem; font-weight: 600;
    padding: 14px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
    text-decoration: none; letter-spacing: 0.02em;
}
.btn-primary { 
    background: var(--primary-btn); color: var(--primary-btn-text); margin-top: 10px; 
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
}
.btn-primary:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25); }
.btn-primary:active { transform: translateY(0); }

.btn-outline { 
    background: transparent; border: 1px solid var(--primary-text); color: var(--primary-text); 
    padding: 12px; font-weight: 600;
}
.btn-outline:hover { background: var(--primary-light); }
.btn-sm { padding: 8px 16px; font-size: 0.85rem; width: auto; display: inline-flex; border-radius: 4px; }

/* --- ãƒ¬ã‚·ãƒ¼ãƒˆé¢¨ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
#resultArea { display: none; }

.receipt-wrapper {
    padding: 20px; 
    margin: 20px -20px;
}

.receipt-paper {
    background: #fff; /* ç´™ã¯å¸¸ã«ç™½ */
    color: #333;      /* æ–‡å­—ã¯å¸¸ã«é»’ */
    font-family: "Courier New", Courier, monospace;
    padding: 30px 25px;
    position: relative;
    box-shadow: 0 2px 15px rgba(0,0,0,0.1);
    max-width: 400px;
    margin: 0 auto;
    border-top: 1px solid #eee;
    border-radius: 2px;
}

.receipt-header {
    text-align: center;
    border-bottom: 1px solid #333;
    padding-bottom: 15px;
    margin-bottom: 15px;
}
.receipt-logo { font-size: 2rem; color: #333; margin-bottom: 5px; }
.receipt-title { font-size: 1rem; font-weight: bold; letter-spacing: 2px; text-transform: uppercase; margin: 0; }
.receipt-meta { font-size: 0.75rem; color: #666; margin-top: 5px; font-family: sans-serif; }

.receipt-total-section {
    text-align: center;
    padding: 15px 0;
    border-bottom: 1px solid #333;
}
.receipt-label-main { font-size: 0.8rem; display: block; margin-bottom: 5px; color: #555; }
.receipt-amount-main { font-size: 2.2rem; font-weight: bold; line-height: 1; display: block; color: #000; }
.receipt-note { font-size: 0.75rem; color: #666; margin-top: 8px; display: block;}

.receipt-section {
    padding: 15px 0;
    border-bottom: 1px dashed #ccc;
}
.receipt-section-title {
    font-size: 0.75rem; font-weight: bold; margin-bottom: 8px; display: block; text-align: left;
    color: #555;
}

.receipt-row {
    display: flex; justify-content: space-between; align-items: baseline;
    font-size: 0.9rem; margin-bottom: 6px;
    line-height: 1.4;
}
.receipt-row.bold { font-weight: bold; font-size: 0.95rem; margin-top: 8px; }
.receipt-row span:last-child { white-space: nowrap; margin-left: 10px; }
.receipt-detail { font-size: 0.75rem; color: #777; margin-left: 10px; margin-bottom: 8px; display: block; line-height: 1.3;}

.receipt-footer {
    text-align: center; margin-top: 30px; font-size: 0.75rem; color: #888;
}

/* ã‚³ãƒ”ãƒ¼ã‚¨ãƒªã‚¢ */
.copy-area {
    background: var(--card-bg); color: var(--text-main); padding: 20px; 
    border-radius: var(--radius); margin-top: 20px; border: 1px solid var(--border);
}
#copyTextarea { 
    width: 100%; background: var(--input-bg); border: 1px solid var(--border); 
    color: var(--text-main); font-family: monospace; height: 100px; resize: none; 
    font-size: 0.85rem; outline: none; padding: 10px; border-radius: var(--radius);
}
.btn-copy { 
    background: var(--bg); color: var(--text-main); padding: 12px; width: 100%; 
    border: 1px solid var(--border); border-radius: var(--radius); 
    margin-top: 10px; font-weight: 600; cursor: pointer; 
    display: flex; align-items: center; justify-content: center; gap: 6px; 
    transition: all 0.2s; 
}
.btn-copy:hover { background: var(--primary-light); color: var(--primary-text); border-color: var(--primary); }

/* å±¥æ­´ãƒªã‚¹ãƒˆ */
.history-container { margin-top: 40px; border-top: 1px solid var(--border); padding-top: 20px; }
.history-item { 
    background: var(--card-bg); padding: 16px; border-radius: var(--radius); margin-bottom: 10px;
    display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border);
    transition: border-color 0.2s;
}
.history-item:hover { border-color: var(--text-sub); }
.history-meta { font-size: 0.75rem; color: var(--text-sub); display: block; margin-bottom: 2px;}
.btn-restore { 
    background: var(--primary-btn); color: var(--primary-btn-text); border: none; 
    padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; 
}
.btn-restore:hover { opacity: 0.9; }

/* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
#toast {
    visibility: hidden; min-width: 280px; 
    background-color: var(--primary-btn); color: var(--primary-btn-text); 
    text-align: center; border-radius: 4px; padding: 16px; 
    position: fixed; z-index: 100; left: 50%; bottom: 30px;
    transform: translateX(-50%); font-size: 0.9rem; opacity: 0; 
    transition: opacity 0.3s, bottom 0.3s;
    display: flex; align-items: center; justify-content: center; gap: 10px; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}
#toast.show { visibility: visible; opacity: 1; bottom: 50px; }

/* --- ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« (Hidden Guide) --- */
.modal {
    display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%;
    overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(2px);
}
.modal-content {
    background-color: var(--card-bg); margin: 5% auto; padding: 0;
    border: none; width: 92%; max-width: 600px;
    border-radius: var(--radius); box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    animation: slideIn 0.3s; position: relative;
    max-height: 90vh; display: flex; flex-direction: column;
}
@keyframes slideIn { from {opacity: 0; transform: translateY(20px);} to {opacity: 1; transform: translateY(0);} }
.modal-header {
    padding: 20px 24px; border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
    background: var(--bg); border-radius: var(--radius) var(--radius) 0 0;
}
.modal-title { margin: 0; font-size: 1.1rem; color: var(--text-main); font-weight: bold; display: flex; align-items: center; gap: 8px; }
.close-btn { color: var(--text-sub); font-size: 1.5rem; cursor: pointer; line-height: 1; padding: 5px;}
.close-btn:hover { color: var(--accent); }
.modal-body { padding: 24px; overflow-y: auto; font-size: 0.95rem; color: var(--text-main); }

.guide-section { margin-bottom: 28px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
.guide-section:last-child { border-bottom: none; margin-bottom: 0; }
.guide-h3 { font-size: 1rem; color: var(--primary-text); margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px; font-weight: bold; }
.guide-h3 i { color: var(--accent); }
.guide-p { margin: 0 0 10px 0; color: var(--text-main); line-height: 1.7; }
.guide-tag { 
    display: inline-block; background: var(--bg); border: 1px solid var(--border);
    color: var(--text-main); padding: 2px 8px; border-radius: 4px; 
    font-size: 0.75rem; font-weight: bold; margin-right: 4px; 
}
</style>
</head>
<body>

<div id="helpModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title"><i class='fa-solid fa-book-open'></i> åˆã‚ã¦ã®æ–¹ã¸ï¼šä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h3>
            <span class="close-btn" onclick="closeHelp()">&times;</span>
        </div>
        <div class="modal-body">
            
            <div class="guide-section">
                <h3 class="guide-h3"><i class='fa-solid fa-users'></i> 1. ãƒ¡ãƒ³ãƒãƒ¼ã¨å…±æœ‰ã™ã‚‹</h3>
                <p class="guide-p">å…¥åŠ›å†…å®¹ã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å…±æœ‰ã•ã‚Œã¾ã™ã€‚</p>
                <p class="guide-p">ãƒšãƒ¼ã‚¸ä¸Šéƒ¨ã® <span class="guide-tag">LINEã§é€ã‚‹</span> ã‚„ <span class="guide-tag">ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</span> ã‚’ä½¿ã£ã¦URLã‚’ãƒ¡ãƒ³ãƒãƒ¼ã«é€ã‚‹ã¨ã€å…¨å“¡ãŒè‡ªåˆ†ã®ã‚¹ãƒãƒ›ã‹ã‚‰è»Šä¸¡æƒ…å ±ãªã©ã‚’å…¥åŠ›ãƒ»ç¢ºèªã§ãã¾ã™ã€‚</p>
            </div>

            <div class="guide-section">
                <h3 class="guide-h3"><i class='fa-solid fa-car'></i> 2. è»Šä¸¡æƒ…å ±ã®å…¥åŠ›</h3>
                <p class="guide-p">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ï¼ˆè»Šå‡ºã—æ‹…å½“ï¼‰ã®æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                <ul style="padding-left: 20px; margin: 5px 0; color: var(--text-sub);">
                    <li><strong>è·é›¢:</strong> å¾€å¾©ã®èµ°è¡Œè·é›¢ (km)</li>
                    <li><strong>ç‡ƒè²»:</strong> è»Šã®ç‡ƒè²» (km/L)</li>
                    <li><strong>ä¾¡æ ¼:</strong> ã‚¬ã‚½ãƒªãƒ³å˜ä¾¡ (å††/L)</li>
                </ul>
                <p class="guide-p" style="margin-top:8px;">
                    <i class='fa-solid fa-circle-plus' style="color:var(--primary)"></i> <strong>è«¸çµŒè²»ã®è¿½åŠ :</strong><br>
                    é«˜é€Ÿä»£ã‚„é§è»Šå ´ä»£ã‚’å…¥åŠ›ã—ã¾ã™ã€‚<br>
                    <span class="guide-tag">å‰²å‹˜</span> å…¨å“¡ã§ç­‰åˆ†ã—ã¾ã™ï¼ˆé€šå¸¸ã®é«˜é€Ÿä»£ãªã©ï¼‰ã€‚<br>
                    <span class="guide-tag">éƒ¨è²»</span> ã‚µãƒ¼ã‚¯ãƒ«è²»ç­‰ã‹ã‚‰æ”¯æ‰•ã†å ´åˆã«é¸æŠã—ã¾ã™ã€‚<br>
                    <span style="font-size:0.8rem; color:var(--accent);">â€» ãƒã‚¤ãƒŠã‚¹ï¼ˆä¾‹: -500ï¼‰ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ã‚¯ãƒ¼ãƒãƒ³ã®å‰²å¼•ã‚„è¿”é‡‘ã®è¨ˆç®—ã«ä½¿ãˆã¾ã™ã€‚</span>
                </p>
            </div>

            <div class="guide-section">
                <h3 class="guide-h3"><i class='fa-solid fa-calculator'></i> 3. è¨ˆç®—ã¨ç²¾ç®—</h3>
                <p class="guide-p">å‚åŠ äººæ•°ã‚’å…¥åŠ›ã—ã€<span class="guide-tag">ç²¾ç®—ã‚’å®Ÿè¡Œã™ã‚‹</span> ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™ã€‚</p>
                <p class="guide-p">
                    è‡ªå‹•çš„ã«ã€Œ1äººã‚ãŸã‚Šã®æ”¯æ‰•é¡ã€ã¨ã€Œãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¸ã®å—å–é¡ã€ãŒè¨ˆç®—ã•ã‚Œã€çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
                    ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã«ã¯<strong>ä¸€å¾‹1,000å††ã®èª¿æ•´è²»</strong>ãŒåŠ ç®—ã•ã‚Œã¾ã™ã€‚
                </p>
            </div>

            <div class="guide-section">
                <h3 class="guide-h3"><i class='fa-solid fa-share-nodes'></i> 4. çµæœã®ä¿å­˜ã¨å±¥æ­´</h3>
                <p class="guide-p">
                    çµæœã¯ <span class="guide-tag">ç”»åƒã‚’ä¿å­˜</span> ã§ä¿å­˜ã—ãŸã‚Šã€ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦LINEã«è²¼ã‚Šä»˜ã‘å¯èƒ½ã§ã™ã€‚
                </p>
                <p class="guide-p">
                    ã¾ãŸã€ä¸€åº¦è¨ˆç®—ã™ã‚‹ã¨è‡ªå‹•çš„ã«<strong>å±¥æ­´</strong>ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ãƒšãƒ¼ã‚¸ä¸‹éƒ¨ã®ã€Œè¨ˆç®—å±¥æ­´ã€ã‹ã‚‰éå»ã®å…¥åŠ›ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚
                </p>
            </div>
            
            <div style="text-align:center; margin-top:20px;">
                <button class="btn btn-primary btn-sm" onclick="closeHelp()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <header>
        <h1><i class='fa-solid fa-mountain'></i> å±±æ­©ä¼š ç²¾ç®—ãƒ„ãƒ¼ãƒ«<span>v5.8</span></h1>
        <button class="help-trigger" onclick="openHelp()" title="ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰">
            <i class='fa-regular fa-circle-question'></i>
        </button>
        
        <div class="sync-status">
            <span class="sync-dot"></span>
            <span id="syncText">åŒæœŸä¸­...</span>
        </div>
    </header>

    <div class="share-invite-box">
        <div class="share-invite-title">
            <i class='fa-solid fa-users'></i> ãƒ¡ãƒ³ãƒãƒ¼ã‚’æ‹›å¾…ã—ã¦å…±åŒç·¨é›†
        </div>
        <p style="margin: 0 0 16px 0; font-size: 0.85rem; opacity: 0.8; color:var(--text-main);">
            ã“ã®URLã‚’ã‚·ã‚§ã‚¢ã™ã‚‹ã¨ã€å…¨å“¡ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«å…¥åŠ›ãƒ»ç·¨é›†ãŒã§ãã¾ã™ã€‚
        </p>
        <div class="share-btn-group">
            <button class="btn-share-action" onclick="copyRoomLink()">
                <i class='fa-regular fa-copy'></i> ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼
            </button>
            <button class="btn-share-action" onclick="shareToLine()">
                <i class='fa-brands fa-line'></i> LINEã§é€ã‚‹
            </button>
        </div>
        
        <div class="room-badge" onclick="copyRoomLink()">
            <span class="room-badge-label">Room ID:</span>
            <span id="dispRoomId">...</span>
        </div>
    </div>

    <div class="card" style="background: var(--bg); border-color: var(--primary);">
        <h3 style="margin:0 0 10px 0; font-size:0.95rem; color: var(--primary-text); display: flex; align-items: center; gap: 6px;">
            <i class='fa-solid fa-circle-info'></i> ä½¿ã„æ–¹
        </h3>
        <ul style="margin: 0; padding-left: 20px; font-size: 0.85rem; color: var(--text-main);">
            <li>å‚åŠ äººæ•°ã€ãƒ‰ãƒ©ã‚¤ãƒãƒ¼æƒ…å ±ã‚’å…¥åŠ›ã—ã¾ã™ã€‚</li>
            <li><strong>è«¸çµŒè²»</strong>ã«ã¯é«˜é€Ÿä»£ãªã©ã‚’å…¥åŠ›ã—ã¾ã™ã€‚ãƒã‚¤ãƒŠã‚¹ï¼ˆä¾‹: -500ï¼‰ã‚‚å…¥åŠ›å¯èƒ½ã§ã™ã€‚</li>
            <li>ã€Œç²¾ç®—ã‚’å®Ÿè¡Œã€ã‚’æŠ¼ã™ã¨1äººã‚ãŸã‚Šã®æ”¯æ‰•é¡ãŒè¨ˆç®—ã•ã‚Œã¾ã™ã€‚</li>
        </ul>
        <div style="text-align:right; margin-top:8px;">
            <button onclick="openHelp()" style="background:none; border:none; color:var(--primary-text); font-size:0.8rem; cursor:pointer; text-decoration:underline;">
                <i class='fa-solid fa-book'></i> è©³ã—ã„ã‚¬ã‚¤ãƒ‰ã‚’è¦‹ã‚‹
            </button>
        </div>
    </div>

    <div class="card">
        <h2><i class='fa-solid fa-car'></i> è»Šä¸¡æƒ…å ±ã®ç™»éŒ²</h2>
        <div id="carList"></div>
        <button class="btn btn-outline" onclick="handleAddCarBtn()">
            <i class='fa-solid fa-plus'></i> è»Šä¸¡ã‚’è¿½åŠ 
        </button>
    </div>

    <div class="card">
        <h2><i class='fa-solid fa-gear'></i> ç²¾ç®—ã®è¨­å®š</h2>
        
        <div class="input-group">
            <label>ç«¯æ•°å‡¦ç†ï¼ˆåˆ‡ã‚Šä¸Šã’å˜ä½ï¼‰</label>
            <select id="roundingUnit" onchange="pushData()">
                <option value="100" selected>100å††</option>
                <option value="50">50å††</option>
                <option value="10">10å††</option>
                <option value="1">1å††</option>
            </select>
        </div>

        <div class="input-group">
            <label>ä¼ç”»ã®å‚åŠ äººæ•° (ä¼ç”»è€…å«ã‚€)</label>
            <div style="position: relative;">
                <input type="number" id="totalPeople" placeholder="ä¾‹: 4" inputmode="numeric" oninput="pushData()" style="padding-left: 40px;">
                <i class='fa-solid fa-users' style="position: absolute; left: 12px; top: 12px; color: var(--text-sub);"></i>
            </div>
        </div>
        
        <label class="checkbox-card">
            <span>ä¼ç”»è€…ã¯ã‚¬ã‚½ãƒªãƒ³ä»£ã‚’æ”¯æ‰•ã‚ãªã„</span>
            <input type="checkbox" id="organizerFree" onchange="pushData()">
            <div class="toggle-switch"></div>
        </label>
    </div>

    <button class="btn btn-primary" onclick="calculate()">
        <i class='fa-solid fa-calculator'></i> ç²¾ç®—ã‚’å®Ÿè¡Œã™ã‚‹
    </button>

   <div id="resultArea">
        <div id="captureTarget" class="receipt-wrapper">
            <div class="receipt-paper">
                <div class="receipt-header">
                    <div class="receipt-logo"><i class='fa-solid fa-mountain-sun'></i></div>
                    <h3 class="receipt-title">ã‚¬ã‚½ãƒªãƒ³ä»£ç²¾ç®—æ›¸</h3>
                    <div class="receipt-meta" id="receiptDate">2024.01.01 12:00</div>
                </div>

                <div class="receipt-total-section">
                    <span class="receipt-label-main">1äººã‚ãŸã‚Šã®å¾´åé¡</span>
                    <span class="receipt-amount-main" id="resPerPerson">0</span>
                    <span class="receipt-note" id="resTargetDetail">--</span>
                </div>

                <div class="receipt-section">
                    <span class="receipt-section-title">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¸ã®æ”¯æ‰•ã„</span>
                    <div id="resDriverList"></div>
                </div>

                <div class="receipt-section">
                    <span class="receipt-section-title">ã‚µãƒ¼ã‚¯ãƒ«ä¼šè¨ˆæƒ…å ±</span>
                    <div class="receipt-row">
                        <span>éƒ¨è²»è² æ‹…åˆ†ã®çµŒè²»åˆè¨ˆ</span>
                        <span id="resCircleExpense">0</span>
                    </div>
                    <div class="receipt-row">
                        <span>ç«¯æ•°èª¿æ•´ã®ä½™ã‚Š (ã‚µãƒ¼ã‚¯ãƒ«è²»ã¸)</span>
                        <span id="resGasSurplus">0</span>
                    </div>
                    <div class="receipt-row bold">
                        <span>ä¼šè¨ˆã‹ã‚‰ã®å®Ÿæ”¯å‡º</span>
                        <span id="resWithdraw">0</span>
                    </div>
                </div>

                <div class="receipt-footer">
                    ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼<br>
                    å±±æ­©ä¼š
                </div>
            </div>
        </div>

        <div class="copy-area">
            <h3 style="margin:0 0 10px 0; font-size:1rem; display:flex; align-items:center; gap:8px;">
                <i class='fa-solid fa-share-nodes'></i> çµæœã®å…±æœ‰
            </h3>
            <textarea id="copyTextarea" readonly></textarea>
            <div style="display: flex; gap: 10px;">
                <button class="btn-copy" onclick="copyToClipboard()">
                    <i class='fa-solid fa-copy'></i> ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼
                </button>
                <button class="btn" style="background: var(--primary-btn); color: #fff; font-size:0.9rem; border: none; border-radius: 6px; width: 100%; margin-top:10px;" onclick="downloadResultImage()">
                    <i class='fa-solid fa-download'></i> ç”»åƒã‚’ä¿å­˜
                </button>
            </div>
        </div>
    </div>

    <div class="history-container">
        <details open>
            <summary style="cursor: pointer; color: var(--text-sub); font-weight: bold; outline:none;">
                <i class='fa-solid fa-clock-rotate-left'></i> è¨ˆç®—å±¥æ­´ (ä¿å­˜æ¸ˆã¿)
            </summary>
            <div style="margin-top: 15px;">
                <ul id="historyList" style="list-style: none; padding: 0;">
                    <li style="text-align:center; color:var(--text-sub); padding:10px; font-size:0.85rem;">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</li>
                </ul>
                <button class="btn btn-outline btn-sm" style="width:100%; margin-top:10px; font-weight:normal;" onclick="resetRoom()">
                    <i class='fa-solid fa-trash'></i> å…¥åŠ›ã‚’å…¨ã¦ã‚¯ãƒªã‚¢
                </button>
            </div>
        </details>
    </div>
    <div style="margin-top: 40px; text-align: center; border-top: 1px dashed var(--border); padding-top: 20px;">
        <button class="btn btn-sm" style="background: var(--text-sub); color: var(--card-bg); width: auto; margin: 0 auto;" onclick="fillTestData()">
            <i class='fa-solid fa-flask'></i> ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥
        </button>
        <p style="font-size: 0.7rem; color: var(--text-sub); margin-top: 8px;">
            â€»æ—¢å­˜ã®å…¥åŠ›ã¯å…¨ã¦ä¸Šæ›¸ãã•ã‚Œã¾ã™
        </p>
    </div>

</div>

<div id="toast"><i class='fa-solid fa-circle-check'></i> <span>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</span></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// --- Global Assignments ---
window.pushData = debounce(pushDataToFirebase, 500);
window.handleAddCarBtn = handleAddCarBtn;
window.resetRoom = resetRoom;
window.loadFromHistory = loadFromHistory;
window.deleteHistory = deleteHistory;
window.fillTestData = fillTestData;
window.downloadResultImage = downloadResultImage;
window.addCarToDOM = addCarToDOM;
window.removeCar = removeCar;
window.handleAddExtra = handleAddExtra;
window.calculate = calculate;
window.copyRoomLink = copyRoomLink;
window.shareToLine = shareToLine;
window.copyToClipboard = copyToClipboard;

// --- Help Modal Logic ---
window.openHelp = function() {
    document.getElementById('helpModal').style.display = 'block';
}
window.closeHelp = function() {
    document.getElementById('helpModal').style.display = 'none';
}
// ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
window.onclick = function(event) {
    const modal = document.getElementById('helpModal');
    if (event.target == modal) {
        modal.style.display = "none";
    }
}

const firebaseConfig = {
  apiKey: "AIzaSyAypqRPRn-YHWLwjT3lQ6pN6_bWBqzUvp4",
  authDomain: "sanpo-seisan.firebaseapp.com",
  databaseURL: "https://sanpo-seisan-default-rtdb.firebaseio.com",
  projectId: "sanpo-seisan",
  storageBucket: "sanpo-seisan.firebasestorage.app",
  messagingSenderId: "709215338656",
  appId: "1:709215338656:web:c2b0dbc9aceb0fa60f89c5"
};

let app, db, roomRef, roomId;

try {
    app = initializeApp(firebaseConfig);
    db = getDatabase(app);

    // URLã‹ã‚‰ãƒ«ãƒ¼ãƒ IDå–å¾—
    roomId = new URLSearchParams(window.location.search).get("room");
    if (!roomId) {
        roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
        const newUrl = window.location.pathname + "?room=" + roomId;
        window.history.replaceState(null, null, newUrl);
    }
    const dispEl = document.getElementById('dispRoomId');
    if(dispEl) dispEl.textContent = roomId;

    roomRef = ref(db, 'sessions/' + roomId);

    // Start sync and history load
    renderHistoryList();
    onValue(roomRef, (snapshot) => {
        const data = snapshot.val();
        const syncText = document.getElementById("syncText");
        
        if (data) {
            if(syncText) syncText.textContent = "åŒæœŸå®Œäº†";
            renderForm(data);
        } else {
            if(syncText) syncText.textContent = "æ–°è¦ãƒ«ãƒ¼ãƒ ";
            const list = document.getElementById('carList');
            if(list && list.children.length === 0) {
                addCarToDOM(null, 0, true);
            }
        }
    });

} catch (e) {
    console.error("Initialization Error:", e);
    showToast("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
}

// ç”»åƒä¿å­˜ç”¨é–¢æ•°
function downloadResultImage() {
    const target = document.getElementById('captureTarget');
    showToast("ç”»åƒã‚’ç”Ÿæˆä¸­...");

    if (typeof html2canvas === 'undefined') {
        alert("ç”»åƒç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        return;
    }

    const options = {
        scale: 2,
        backgroundColor: null,
        logging: false,
        useCORS: true
    };

    html2canvas(target, options).then(canvas => {
        const link = document.createElement('a');
        link.download = `receipt_${roomId}_${Date.now()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        showToast("âœ… ç”»åƒã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    }).catch(err => {
        console.error(err);
        showToast("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
    });
}

function renderForm(data) {
    setValIfDiff('totalPeople', data.total);
    setCheckIfDiff('organizerFree', data.org);
    setValIfDiff('roundingUnit', data.rounding);

    const carList = document.getElementById('carList');
    const remoteCars = data.cars || [];
    const currentCards = carList.getElementsByClassName('car-card');
    
    while(currentCards.length < remoteCars.length) {
        addCarToDOM(null, currentCards.length, true);
    }
    while(currentCards.length > remoteCars.length) {
        carList.removeChild(carList.lastChild);
    }

    Array.from(currentCards).forEach((card, i) => {
        const cData = remoteCars[i];
        
        const inputs = {
            name: card.querySelector('.inp-name'),
            dist: card.querySelector('.inp-dist'),
            eco: card.querySelector('.inp-eco'),
            price: card.querySelector('.inp-price')
        };
        
        if(document.activeElement !== inputs.name) inputs.name.value = cData.name || "";
        if(document.activeElement !== inputs.dist) inputs.dist.value = cData.dist || "";
        if(document.activeElement !== inputs.eco) inputs.eco.value = cData.eco || "";
        if(document.activeElement !== inputs.price) inputs.price.value = cData.price || "";
        
        const title = card.querySelector('.car-title-text');
        const dName = cData.name || `è»Šä¸¡ ${i + 1}`;
        title.innerHTML = `<i class='fa-solid fa-car'></i> ${dName}`;

        const extrasBox = card.querySelector('.extra-section div[id^="extras-"]');
        if(!extrasBox) return;

        const remoteExtras = cData.extras || [];
        const currentExtras = extrasBox.getElementsByClassName('extra-item');

        while(currentExtras.length < remoteExtras.length) {
            addExtraToDOM(extrasBox, "", "", "club");
        }
        while(currentExtras.length > remoteExtras.length) {
            extrasBox.removeChild(extrasBox.lastChild);
        }

        Array.from(currentExtras).forEach((row, j) => {
            const exData = remoteExtras[j];
            const nameInp = row.querySelector('.ex-name');
            const amtInp = row.querySelector('.ex-amount');
            const typeSel = row.querySelector('.ex-type');
            
            if(document.activeElement !== nameInp) nameInp.value = exData.name || "";
            if(document.activeElement !== amtInp) amtInp.value = exData.amount || "";
            if(document.activeElement !== typeSel) typeSel.value = exData.type || "club";
        });
    });
}

function setValIfDiff(id, val) {
    const el = document.getElementById(id);
    if (el && document.activeElement !== el && el.value != val) {
        el.value = val || "";
    }
}
function setCheckIfDiff(id, val) {
    const el = document.getElementById(id);
    if (el && el.checked != val) {
        el.checked = val || false;
    }
}

function pushDataToFirebase() {
    if(!roomRef) return; // Guard against init failure
    const data = getFormData();
    const syncText = document.getElementById("syncText");
    if(syncText) syncText.textContent = "ä¿å­˜ä¸­...";
    set(roomRef, data).then(() => {
        if(syncText) syncText.textContent = "åŒæœŸå®Œäº†";
    }).catch((e) => {
        if(syncText) syncText.textContent = "ã‚¨ãƒ©ãƒ¼";
        console.error(e);
    });
}

function debounce(func, wait) {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
    };
}

function getFormData() {
    const cards = document.querySelectorAll('.car-card');
    const carDatas = Array.from(cards).map(card => ({
        name: card.querySelector('.inp-name').value, 
        dist: card.querySelector('.inp-dist').value,
        eco: card.querySelector('.inp-eco').value, 
        price: card.querySelector('.inp-price').value,
        extras: Array.from(card.querySelectorAll('.extra-item')).map(row => ({ 
            name: row.querySelector('.ex-name').value, 
            amount: row.querySelector('.ex-amount').value,
            type: row.querySelector('.ex-type').value 
        }))
    }));
    return {
        total: document.getElementById('totalPeople').value,
        org: document.getElementById('organizerFree').checked,
        rounding: document.getElementById('roundingUnit').value,
        cars: carDatas,
        updatedAt: Date.now()
    };
}

function resetRoom() {
    if(!roomRef) return;
    if(confirm("å…¨ã¦ã®å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ç”»é¢ã‹ã‚‰ã‚‚æ¶ˆãˆã¾ã™ï¼‰")) {
        set(roomRef, null).then(() => {
            window.location.reload();
        });
    }
}

function fillTestData() {
    if(!confirm("ç¾åœ¨ã®å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¾ã™ã‹ï¼Ÿ")) return;

    document.getElementById('carList').innerHTML = "";

    const totalPeople = 11;
    document.getElementById('totalPeople').value = totalPeople;
    document.getElementById('roundingUnit').value = "100";
    document.getElementById('organizerFree').checked = true;

    const testData = [
        { 
            name: "ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼A", dist: [200, 240], eco: [12, 16], price: [165, 175], 
            extras: [
                ["é«˜é€Ÿä»£", 4500, "split"],
                ["ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼ä»£", 8000, "club"],
                ["é§è»Šå ´", 1200, "split"]
            ] 
        },
        { 
            name: "éˆ´æœ¨ä¸€éƒ", dist: [180, 220], eco: [20, 25], price: [160, 170], 
            extras: [
                ["ã‚¢ã‚¤ã‚¹ä»£", 800, "club"],
                ["ã‚¯ãƒ¼ãƒãƒ³å‰²å¼•", -500, "club"] 
            ] 
        },
        { 
            name: "ä½è—¤èŠ±å­", dist: [190, 230], eco: [15, 19], price: [168, 178], 
            extras: [
                ["æœ‰æ–™é“è·¯", 1200, "split"],
                ["æ¸©æ³‰ä»£ç«‹æ›¿", 5000, "club"]
            ] 
        }
    ];

    const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

    testData.forEach((d, i) => {
        addCarToDOM(null, -1, true);
        const card = document.getElementById('carList').lastElementChild;
        
        card.querySelector('.inp-name').value = d.name;
        card.querySelector('.inp-dist').value = rand(d.dist[0], d.dist[1]);
        card.querySelector('.inp-eco').value  = rand(d.eco[0], d.eco[1]);
        card.querySelector('.inp-price').value = rand(d.price[0], d.price[1]);

        const extraBox = card.querySelector('.extra-section > div');
        d.extras.forEach(ex => {
            addExtraToDOM(extraBox, ex[0], ex[1], ex[2]);
        });
    });

    pushDataToFirebase();
    showToast("ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿(æ··åœ¨)ã‚’æŠ•å…¥ã—ã¾ã—ãŸ");
    document.getElementById('resultArea').style.display = 'none';
}

function saveToHistory() {
    const data = getFormData();
    if(!data.total && data.cars.length === 1 && !data.cars[0].dist) return;
    
    try {
        const history = JSON.parse(localStorage.getItem('sanpo_history_v5') || "[]");
        
        if(history.length > 0) {
            const last = history[0].data;
            if(JSON.stringify(last) === JSON.stringify(data)) return; 
        }

        const summary = `${data.total || "?"}å / è»Š${data.cars.length}å°`;
        history.unshift({ 
            date: new Date().toLocaleString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' }), 
            summary: summary,
            data: data 
        });
        
        localStorage.setItem('sanpo_history_v5', JSON.stringify(history.slice(0, 10)));
        renderHistoryList();
    } catch(e) {
        console.error("History Save Error:", e);
    }
}

function renderHistoryList() {
    const list = document.getElementById('historyList');
    if(!list) return;

    let history = [];
    try {
        history = JSON.parse(localStorage.getItem('sanpo_history_v5') || "[]");
    } catch(e) {
        console.error("History Load Error", e);
    }
    
    if (history.length === 0) {
        list.innerHTML = `<li style="text-align:center; color:var(--text-sub); padding:10px; font-size:0.8rem;">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</li>`;
        return;
    }

    list.innerHTML = "";
    history.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = 'history-item';
        li.innerHTML = `
            <div>
                <span class="history-meta">${item.date}</span>
                <div style="font-weight:600; font-size:0.9rem;">${item.summary}</div>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn-restore" onclick="loadFromHistory(${index})">å¾©å…ƒ</button>
                <button class="btn-icon-only" style="color:var(--text-sub); font-size:1rem;" onclick="deleteHistory(${index})"><i class='fa-solid fa-xmark'></i></button>
            </div>
        `;
        list.appendChild(li);
    });
}

function loadFromHistory(index) {
    if(!roomRef) return;
    if(!confirm("ç¾åœ¨ã®å…¥åŠ›ã‚’ä¸Šæ›¸ãã—ã¦å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")) return;
    try {
        const history = JSON.parse(localStorage.getItem('sanpo_history_v5') || "[]");
        const item = history[index];
        if(item && item.data) {
            set(roomRef, item.data).then(() => {
                showToast("ğŸ“‚ å±¥æ­´ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸ");
            });
        }
    } catch(e) { console.error(e); }
}

function deleteHistory(index) {
    if(!confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    try {
        const history = JSON.parse(localStorage.getItem('sanpo_history_v5') || "[]");
        history.splice(index, 1);
        localStorage.setItem('sanpo_history_v5', JSON.stringify(history));
        renderHistoryList();
    } catch(e) { console.error(e); }
}

function handleAddCarBtn() {
    addCarToDOM();
    pushDataToFirebase();
}

function addCarToDOM(data = null, idx = -1, forceOpen = false) {
    const list = document.getElementById('carList');
    if(!list) return;
    if (idx === -1) idx = list.children.length;
    
    if(list.children[idx]) return;

    const div = document.createElement('div');
    const isOpen = forceOpen ? 'open' : 'open';
    div.className = `car-card ${isOpen}`;
    const onInput = `oninput="window.pushData()"`;
    const extrasId = `extras-${Date.now()}-${Math.random().toString(36).substr(2,5)}`;

    div.innerHTML = `
        <div class="car-header" onclick="this.parentElement.classList.toggle('open')">
            <span class="car-title-text"><i class='fa-solid fa-car'></i> è»Šä¸¡ ${idx + 1}</span>
            <div style="display:flex; align-items:center; gap:8px;">
                <button class="btn-icon-only" onclick="removeCar(event, this)" title="å‰Šé™¤"><i class='fa-solid fa-trash'></i></button>
                <i class='fa-solid fa-chevron-down toggle-icon'></i>
            </div>
        </div>
        <div class="car-body">
            <div class="input-group">
                <label>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼åï¼ˆä»»æ„ï¼‰</label>
                <div style="position:relative;">
                    <i class='fa-solid fa-user' style="position:absolute; left:12px; top:12px; color:var(--text-sub);"></i>
                    <input type="text" class="inp-name" placeholder="æ°å" ${onInput} style="padding-left:36px;">
                </div>
            </div>
            <div class="flex-row">
                <div class="input-group"><label>è·é›¢ (km)<span style="color:var(--accent)">*</span></label><input type="number" class="inp-dist" placeholder="ä¾‹: 240" inputmode="decimal" ${onInput}></div>
                <div class="input-group"><label>ç‡ƒè²» (km/L)<span style="color:var(--accent)">*</span></label><input type="number" class="inp-eco" placeholder="ä¾‹: 15" inputmode="decimal" ${onInput}></div>
                <div class="input-group"><label>ä¾¡æ ¼ (å††)<span style="color:var(--accent)">*</span></label><input type="number" class="inp-price" placeholder="ä¾‹: 160" inputmode="numeric" ${onInput}></div>
            </div>
            <div class="extra-section">
                <label style="margin-bottom:8px; display:block; font-size:0.8rem; color:var(--text-sub);">â• è«¸çµŒè²»ï¼ˆé«˜é€Ÿãƒ»é§è»Šå ´ãƒ»å‰²å¼•ãªã©ï¼‰</label>
                <div id="${extrasId}"></div>
                <button class="btn-reset" style="background:none; border:none; color:var(--primary-text); font-size:0.8rem; cursor:pointer; padding:0; margin-top:5px; font-weight:bold;" onclick="handleAddExtra(this)">
                    + çµŒè²»ã‚’è¿½åŠ 
                </button>
            </div>
        </div>
    `;
    list.appendChild(div);
}

function removeCar(e, btn){ 
    e.stopPropagation(); 
    if(confirm("ã“ã®è»Šä¸¡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { 
        btn.closest('.car-card').remove(); 
        pushDataToFirebase();
    } 
}

function handleAddExtra(btn) {
    const box = btn.previousElementSibling;
    addExtraToDOM(box);
    pushDataToFirebase();
}

function addExtraToDOM(container, name="", amount="", type="club") {
    const div = document.createElement('div');
    div.className = 'extra-item';
    
    const isSplit = (type === 'split') ? 'selected' : '';
    const isClub = (type === 'club') ? 'selected' : '';

    div.innerHTML = `
        <input type="text" class="ex-name" placeholder="é …ç›®" value="${name}" oninput="window.pushData()">
        <input type="text" class="ex-amount" placeholder="é‡‘é¡" value="${amount}" oninput="window.pushData()">
        <select class="ex-type" onchange="window.pushData()">
            <option value="club" ${isClub}>éƒ¨è²»</option>
            <option value="split" ${isSplit}>å‰²å‹˜</option>
        </select>
        <button class="btn-icon-only" style="color:var(--text-sub);" onclick="this.parentElement.remove(); window.pushData();"><i class='fa-solid fa-xmark'></i></button>
    `;
    container.appendChild(div);
}

function calculate() {
    const data = getFormData();
    const totalPeople = parseInt(data.total);
    const isOrgFree = data.org;
    
    let errorMsgs = [];
    if (!totalPeople || totalPeople <= 0) errorMsgs.push("å‚åŠ äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    if (data.cars.length === 0) errorMsgs.push("è»Šä¸¡ãŒ1å°ã‚‚ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“");

    data.cars.forEach((c, index) => {
        const dName = c.name || `è»Šä¸¡ ${index + 1}`;
        if(!c.dist) errorMsgs.push(`${dName}: èµ°è¡Œè·é›¢ãŒæœªå…¥åŠ›ã§ã™`);
        if(!c.eco) errorMsgs.push(`${dName}: ç‡ƒè²»ãŒæœªå…¥åŠ›ã§ã™`);
        if(!c.price) errorMsgs.push(`${dName}: ã‚¬ã‚½ãƒªãƒ³ä¾¡æ ¼ãŒæœªå…¥åŠ›ã§ã™`);
    });

    if (errorMsgs.length > 0) { alert("âš ï¸ ã‚¨ãƒ©ãƒ¼:\nãƒ»" + errorMsgs.join("\nãƒ»")); return; }

    let totalGas = 0; 
    let totalExtrasSplit = 0; 
    let totalExtrasClub = 0; 
    let totalReward = 0;

    let driverResults = []; 

    data.cars.forEach((c) => {
        const name = c.name || "ãƒ‰ãƒ©ã‚¤ãƒãƒ¼";
        const dist = parseFloat(c.dist) || 0;
        const eco = parseFloat(c.eco) || 1;
        const price = parseFloat(c.price) || 0;
        const gasCost = Math.round((dist / eco) * price);
        
        let driverExtrasTotal = 0; 
        let exs = [];

        c.extras.forEach(ex => {
            const val = parseInt(ex.amount) || 0;
            const nm = ex.name || "è«¸çµŒè²»";
            const tp = ex.type || "club"; 

            // 0ä»¥å¤–ãªã‚‰è¨ˆç®—å¯¾è±¡ã¨ã™ã‚‹ (ãƒã‚¤ãƒŠã‚¹å¯¾å¿œ)
            if(val !== 0) { 
                driverExtrasTotal += val; 
                exs.push({name: nm, amount: val, type: tp});
                
                if(tp === 'split') {
                    totalExtrasSplit += val;
                } else {
                    totalExtrasClub += val;
                }
            }
        });

        const reward = 1000; 
        totalGas += gasCost; 
        totalReward += reward;

        driverResults.push({
            name,
            totalPay: gasCost + driverExtrasTotal + reward, 
            gasCost,
            reward,
            extras: exs,
            extrasTotal: driverExtrasTotal
        });
    });

    const totalCollectionTarget = totalGas + totalExtrasSplit;

    const payers = isOrgFree ? (totalPeople - 1) : totalPeople;
    const roundUnit = parseInt(data.rounding);
    
    const perPersonPay = payers > 0 ? Math.ceil((totalCollectionTarget / payers) / roundUnit) * roundUnit : 0;
    
    const totalCollected = perPersonPay * payers;
    
    const surplus = totalCollected - totalCollectionTarget;

    const circleNeed = (totalExtrasClub + totalReward) - surplus;


    document.getElementById('receiptDate').textContent = new Date().toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });

    document.getElementById('resPerPerson').textContent = "Â¥ " + perPersonPay.toLocaleString();
    
    // æ—¥æœ¬èªè¡¨è¨˜ã«ã—ã€å¿…è¦ãªã‚‰è«¸çµŒè²»ã®å†…è¨³ã‚‚è¡¨ç¤º
    let detailText = `å¯¾è±¡: ${payers}å / å®Ÿè²»è¨ˆ: Â¥${totalCollectionTarget.toLocaleString()}`;
    
    if (totalExtrasSplit > 0) {
        detailText += ` (å†…:è«¸çµŒè²»${totalExtrasSplit.toLocaleString()})`;
    }

    document.getElementById('resTargetDetail').textContent = detailText;
    
    
    
    const dList = document.getElementById('resDriverList'); 
    dList.innerHTML = "";
    driverResults.forEach(d => {
        const row = document.createElement('div'); 
        row.className = 'receipt-row';
        
        let extrasHtml = "";
        if(d.extras.length > 0) {
            d.extras.forEach(ex => {
                const mark = ex.type === 'split' ? '[å‰²å‹˜]' : '[éƒ¨è²»]';
                extrasHtml += `<span class="receipt-detail">- ${ex.name} ${mark}: Â¥${ex.amount.toLocaleString()}</span>`;
            });
        }

        row.innerHTML = `
            <div style="flex:1;">
                <div style="display:flex; justify-content:space-between; font-weight:bold;">
                    <span>${d.name} ã•ã‚“</span>
                    <span>Â¥${d.totalPay.toLocaleString()}</span>
                </div>
                <span class="receipt-detail">- ã‚¬ã‚½ãƒªãƒ³ä»£: Â¥${d.gasCost.toLocaleString()}</span>
                <span class="receipt-detail">- èª¿æ•´è²»: Â¥${d.reward.toLocaleString()}</span>
                ${extrasHtml}
            </div>
        `;
        dList.appendChild(row);
    });



    document.getElementById('resCircleExpense').textContent = "Â¥" + (totalExtrasClub + totalReward).toLocaleString();
    document.getElementById('resGasSurplus').textContent = "-Â¥" + surplus.toLocaleString();
    document.getElementById('resWithdraw').textContent = "Â¥" + circleNeed.toLocaleString();
    
    const resultArea = document.getElementById('resultArea');
    resultArea.style.display = 'block';
    resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });

    saveToHistory();

    let lineText = `ã€å±±æ­©ä¼š ç²¾ç®—å ±å‘Š â›°ï¸ã€‘\n`;
    lineText += `â– å¾´åé¡ï¼ˆ1äººã‚ãŸã‚Šï¼‰\n`;
    lineText += `${perPersonPay.toLocaleString()}å††\n`;
    if(isOrgFree) lineText += `ï¼ˆâ€»ä¼ç”»è€…ã¯å…é™¤ï¼‰\n`;
    
    lineText += `\nâ– ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¸ã®æ”¯æ‰•é¡\n`;
    driverResults.forEach(d => {
        lineText += `ãƒ»${d.name}ã•ã‚“ï¼š${d.totalPay.toLocaleString()}å††\n`;
        let details = [`ã‚¬ã‚¹:${d.gasCost}`];
        const splitEx = d.extras.filter(e => e.type === 'split').reduce((s,e)=>s+e.amount,0);
        const clubEx  = d.extras.filter(e => e.type !== 'split').reduce((s,e)=>s+e.amount,0);
        
        if(splitEx !== 0) details.push(`å‰²å‹˜çµŒè²»:${splitEx}`);
        if(clubEx !== 0) details.push(`éƒ¨è²»çµŒè²»:${clubEx}`);
        details.push(`èª¿æ•´:${d.reward}`);
        
        lineText += `  (${details.join('/')})\n`;
    });
    
    lineText += `\nâ– ã‚µãƒ¼ã‚¯ãƒ«ä¼šè¨ˆã‹ã‚‰ã®æ”¯å‡º\nè¨ˆï¼š${circleNeed.toLocaleString()}å††\n`;
    if(surplus > 0) lineText += `(ç«¯æ•°ä½™å‰° ${surplus}å††å……å½“æ¸ˆã¿)\n`;

    lineText += `\n\nâ–¼è¨ˆç®—ãƒ»ç·¨é›†URL\n${window.location.href}`;

    document.getElementById('copyTextarea').value = lineText;

    showToast("âœ… ç²¾ç®—å®Œäº†ï¼å±¥æ­´ã«ä¿å­˜ã—ã¾ã—ãŸ");
}

function copyRoomLink() {
    const url = window.location.href;
    if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => showToast("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼"));
    } else {
        const ta = document.createElement("textarea");
        ta.value = url;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        showToast("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
    }
}

function shareToLine() {
    const url = window.location.href;
    const text = "ç²¾ç®—ãƒ„ãƒ¼ãƒ«ã®ãƒªãƒ³ã‚¯ã§ã™ã€‚å…¥åŠ›ã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼";
    window.open(`https://line.me/R/msg/text/?${encodeURIComponent(text + "\n" + url)}`, '_blank');
}

function copyToClipboard() {
    const textarea = document.getElementById('copyTextarea');
    textarea.select(); document.execCommand('copy');
    showToast("ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
}

function showToast(msg) {
    const toast = document.getElementById("toast");
    toast.innerHTML = `<i class='fa-solid fa-circle-check'></i> <span>${msg}</span>`;
    toast.className = "show";
    setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
}
</script>
</body>
</html>
